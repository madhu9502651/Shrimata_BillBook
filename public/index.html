<!doctype html>
<html lang="en" class="h-full">

<head>
    <script>
      // Always redirect to login if not authenticated (run as soon as possible)
      if (!localStorage.getItem('token') || !localStorage.getItem('user')) {
        window.location.replace('/login.html');
      }
    </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Business Manager Pro - Shrimata BillBook</title>

    <script src="/js/api-client.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script>
    // Utility: Escape HTML to prevent XSS
    function escapeHtml(str) {
      if (typeof str !== 'string') return str;
      return str.replace(/[&<>"'`=\/]/g, function (s) {
        return ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;',
          '`': '&#96;',
          '=': '&#61;',
          '/': '&#47;'
        })[s];
      });
    }
    // Utility: Format date as DD MMM YYYY (e.g., 28 Jan 2026)
    function formatDate(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      if (isNaN(d)) return dateStr;
      return d.toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    // Utility: Show toast notification
    function showToast(message, type = 'info', duration = 3000) {
      // Remove any existing toast
      const old = document.getElementById('global-toast');
      if (old) old.remove();
      // Create toast
      const toast = document.createElement('div');
      toast.id = 'global-toast';
      toast.textContent = message;
      toast.style.position = 'fixed';
      toast.style.bottom = '32px';
      toast.style.left = '50%';
      toast.style.transform = 'translateX(-50%)';
      toast.style.background = type === 'error' ? '#dc2626' : (type === 'success' ? '#059669' : '#334155');
      toast.style.color = '#fff';
      toast.style.padding = '12px 24px';
      toast.style.borderRadius = '8px';
      toast.style.fontSize = '1rem';
      toast.style.zIndex = 9999;
      toast.style.boxShadow = '0 2px 8px rgba(0,0,0,0.15)';
      document.body.appendChild(toast);
      setTimeout(() => { toast.remove(); }, duration);
    }
    </script>
  <script>
    // Ensure global api instance
    window.api = window.api || new SecureAPI();
    // Secure data SDK that uses backend API
    (function () {
      let dataHandlerRef = null;
      let allData = [];

      // Fetch all data from backend
      async function loadDataFromBackend() {
        // Login/session check removed: always load data
        try {
          const response = await api.getData();
          allData = response.data.map(item => ({
            ...item,
            __backendId: item._id || item.__backendId
          }));
          if (dataHandlerRef && typeof dataHandlerRef.onDataChanged === 'function') {
            dataHandlerRef.onDataChanged(allData);
          }
        } catch (error) {
          console.error('Failed to load data:', error);
          alert('Failed to load data: ' + error.message);
          alert('Failed to load data: ' + error.message);
        }
      }

      window.dataSdk = {
        init: async (handler) => {
          dataHandlerRef = handler;
          await loadDataFromBackend();
          return { isOk: true };
        },
        create: async (rec) => {
          try {
            const response = await api.createRecord(rec);
            const newRec = { ...response.data, __backendId: response.data._id };
            allData.push(newRec);
            if (dataHandlerRef && typeof dataHandlerRef.onDataChanged === 'function') {
              dataHandlerRef.onDataChanged(allData);
            }
            return { isOk: true, data: newRec };
          } catch (error) {
            console.error('Create failed:', error);
            alert(error.message);
            return { isOk: false, error: error.message };
          }
        },
        update: async (rec) => {
          try {
            const id = rec._id || rec.__backendId;
            const response = await api.updateRecord(id, rec);
            const updatedRec = { ...response.data, __backendId: response.data._id };
            const index = allData.findIndex(d => d.__backendId === updatedRec.__backendId);
            if (index !== -1) {
              allData[index] = updatedRec;
            }
            if (dataHandlerRef && typeof dataHandlerRef.onDataChanged === 'function') {
              dataHandlerRef.onDataChanged(allData);
            }
            return { isOk: true, data: updatedRec };
          } catch (error) {
            console.error('Update failed:', error);
            if (typeof shouldHideCompanyData === 'function' && shouldHideCompanyData()) {
              // Hide all data and show locked message
              if (typeof renderProduction === 'function') renderProduction();
              alert('‚õî You have already added production for today. You cannot add, edit, or delete further.');
            } else {
              alert(error.message);
            }
            return { isOk: false, error: error.message };
          }
        },
        delete: async (rec) => {
          try {
            const id = rec._id || rec.__backendId;
            await api.deleteRecord(id);
            allData = allData.filter(d => d.__backendId !== rec.__backendId);
            if (dataHandlerRef && typeof dataHandlerRef.onDataChanged === 'function') {
              dataHandlerRef.onDataChanged(allData);
            }
            return { isOk: true };
          } catch (error) {
            console.error('Delete failed:', error);
            if (typeof shouldHideCompanyData === 'function' && shouldHideCompanyData()) {
              // Hide all data and show locked message
              if (typeof renderProduction === 'function') renderProduction();
              alert('‚õî You have already added production for today. You cannot add, edit, or delete further.');
            } else {
              alert(error.message);
            }
            return { isOk: false, error: error.message };
          }
        }
      };

      window.elementSdk = {
        init: () => { },
        config: { currency_symbol: '‚Çπ' },
        setConfig: () => { }
      };
    })();
  </script>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <link href="/output.css" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'DM Sans', sans-serif;
    }

    .tab-active {
      background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
      color: white;
    }

    .card-gradient {
      background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
    }

    .stat-card {
      background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
    }

    .pending-card {
      background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
    }

    .profit-card {
      background: linear-gradient(135deg, #059669 0%, #10b981 100%);
    }

    .loss-card {
      background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
    }

    .modal-backdrop {
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }

    .input-field {
      transition: all 0.2s ease;
    }

    .input-field:focus {
      box-shadow: 0 0 0 3px rgba(45, 90, 135, 0.2);
    }

    .btn-primary {
      background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
      transition: all 0.2s ease;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(30, 58, 95, 0.3);
    }

    .btn-secondary {
      background: #e2e8f0;
      color: #1e3a5f;
      transition: all 0.2s ease;
    }

    .btn-secondary:hover {
      background: #cbd5e1;
    }

    .table-row:hover {
      background: #f1f5f9;
    }
    /* Reduce font size for tables in production, orders, and expenses */
    #orders-section table,
    #production-summary-card table,
    #investments-section table,
    #products-section table,
    #attendance-section table {
      font-size: 0.85rem;
    }
    #orders-section th, #orders-section td,
    #production-summary-card th, #production-summary-card td,
    #investments-section th, #investments-section td,
    #products-section th, #products-section td,
    #attendance-section th, #attendance-section td {
      padding: 0.25rem 0.4rem;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-fade-in {
      animation: fadeIn 0.3s ease forwards;
    }

    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    .scrollbar-thin::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 3px;
    }

    .scrollbar-thin::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 3px;
    }

    .scrollbar-thin::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    .cursor-pointer {
      cursor: pointer;
    }

    /* Receipt Print Styles */
    @media print {
      body * {
        visibility: hidden;
      }

      #receipt-modal,
      #receipt-modal * {
        visibility: visible;
      }

      #receipt-modal {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        background: white;
      }

      #receipt-content {
        max-width: 800px !important;
        margin: 0 auto !important;
        padding: 20px !important;
        transform: scale(1) !important;
      }

      #receipt-content img {
        max-width: 80px !important;
        height: auto !important;
      }

      .no-print {
        display: none !important;
      }

      .modal-backdrop {
        background: white !important;
      }

      /* Ensure proper sizing for all elements */
      #receipt-content * {
        max-width: 100%;
        box-sizing: border-box;
      }

      /* Prevent page breaks inside elements */
      #receipt-content>div {
        page-break-inside: avoid;
      }
    }

    #receipt-content::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url('logo.jpg');
      background-repeat: no-repeat;
      background-position: center;
      background-size: 60%;
      opacity: 0.6;
      pointer-events: none;
      z-index: 0;
      transform: rotate(-45deg);
    }
  </style>
  <style>
    @view-transition {
      navigation: auto;
    }
  </style>
</head>
<body class="h-full min-h-screen w-full flex items-center justify-center bg-slate-100 text-slate-800" style="min-height: 100vh;">
  <!-- Reference Screenshot for Developers: <img src='/IMG_7938.png' alt='Mobile Dashboard Reference' style='max-width: 100%; display: none;' /> -->
  <div id="app" class="flex flex-col bg-white w-full max-w-[420px] min-h-screen h-full shadow-lg overflow-hidden" style="height: 100vh;">
    <script>
      // Set user info in header and restrict tabs for 'user' role
      (function() {
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        document.getElementById('user-name').textContent = user.fullName || user.username || 'User';
        const badge = document.getElementById('user-role-badge');
        if (user.role === 'user') {
          badge.textContent = 'USER';
          badge.classList.remove('bg-purple-600');
          badge.classList.add('bg-blue-600');
          // Hide all tabs except Production
          const allowed = ['tab-workers'];
          document.querySelectorAll('.tab-btn').forEach(btn => {
            if (!allowed.includes(btn.id)) {
              btn.style.display = 'none';
            } else {
              btn.style.display = '';
            }
          });
          // Show only production tab content
          document.querySelectorAll('.tab-content').forEach(tc => {
            if (tc.id !== 'content-workers') tc.style.display = 'none';
            else tc.style.display = '';
          });
          // Set production tab as active
          document.getElementById('tab-workers').classList.add('tab-active');
        }

        // User menu toggle logic
        const userMenuBtn = document.getElementById('user-menu-btn');
        const userMenu = document.getElementById('user-menu');
        if (userMenuBtn && userMenu) {
          userMenuBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            userMenu.classList.toggle('hidden');
          });
          // Hide menu when clicking outside
          document.addEventListener('click', function(e) {
            if (!userMenu.contains(e.target) && e.target !== userMenuBtn) {
              userMenu.classList.add('hidden');
            }
          });
        }
      })();
    </script>
    <header class="bg-white shadow-sm border-b border-slate-200 px-4 py-3 flex-shrink-0">
      <div class="w-full flex flex-col items-center gap-2 pt-2 pb-2">
        <h1 id="app-title" class="text-xl font-bold text-slate-800 w-full text-center tracking-tight leading-tight mb-2">Shrimata Business Manager Pro</h1>
        <div class="w-full flex flex-row flex-wrap items-center justify-between gap-2">
          <div class="flex items-center gap-2 bg-gradient-to-r from-purple-50 to-indigo-50 px-3 py-2 rounded-lg border border-purple-200 flex-1 min-w-0 relative">
            <button id="user-menu-btn" class="text-base align-middle font-medium text-slate-700 truncate flex items-center gap-1 focus:outline-none" style="background: none; border: none; cursor: pointer;">
              üë§ <span id="user-name">User</span>
              <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
            </button>
            <span id="user-role-badge" class="text-xs px-2 py-1 rounded-full bg-purple-600 text-white font-semibold">ADMIN</span>
            <div id="user-menu" class="absolute right-0 top-12 bg-white border border-slate-200 rounded shadow-lg z-50 hidden min-w-[160px]">
              <button id="change-password-btn" class="block w-full text-left px-4 py-2 hover:bg-slate-100 text-slate-700">Change Password</button>
              <button id="logout-btn" class="block w-full text-left px-4 py-2 hover:bg-slate-100 text-red-600">Logout</button>
            </div>
          </div>
          <div class="flex gap-2 flex-shrink-0 mt-2">
            <button onclick="showAlerts()" class="bg-amber-500 hover:bg-amber-600 text-white px-3 py-2 rounded-lg flex items-center gap-2 transition-colors" title="View Alerts">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
              </svg>
              <span id="alerts-count" class="font-bold">0</span>
            </button>
            <button onclick="confirmLogout()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg flex items-center gap-2 transition-colors" title="Logout">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
              </svg>
            </button>
          </div>
        </div>
        <div class="w-full flex flex-row items-center gap-2 mt-2">
          <div class="flex items-center gap-2 bg-slate-100 px-3 py-2 rounded-lg">
            <label class="text-sm font-medium text-slate-700">Month:</label>
            <select id="month-selector" onchange="filterByMonth()" class="bg-white border border-slate-300 rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="all">All Time</option>
              <option value="2026-01" selected>January 2026</option>
              <option value="2025-12">December 2025</option>
              <option value="2025-11">November 2025</option>
              <option value="2025-10">October 2025</option>
            </select>
          </div>
          <div id="pending-alert" class="pending-card text-white flex-1 px-4 py-2 rounded-lg flex items-center gap-2 shadow-lg">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg><span class="font-medium">To Collect: <span id="total-pending" class="font-bold">‚Çπ0</span></span>
          </div>
        </div>

      </div>
    </header><!-- Navigation Tabs -->
    <nav class="bg-white border-b border-slate-200 px-4 flex-shrink-0" style="position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100vw; max-width: 420px; z-index: 50;">
      <div class="w-full flex gap-1 overflow-x-auto scrollbar-thin py-2 justify-between">
          <button onclick="switchTab('dashboard')" id="tab-dashboard"
          class="tab-btn tab-active flex-1 flex flex-col items-center justify-center px-1 py-2 rounded-lg font-medium text-xl whitespace-nowrap transition-all">
          <span aria-label="Dashboard" title="Dashboard" class="text-base align-middle">üìä</span>
          <span class="text-[10px] mt-1 text-slate-500 font-medium">Dashboard</span>
        </button>
          <button onclick="switchTab('orders')" id="tab-orders"
          class="tab-btn flex-1 flex flex-col items-center justify-center px-1 py-2 rounded-lg font-medium text-xl whitespace-nowrap transition-all bg-slate-100 hover:bg-slate-200">
          <span aria-label="Orders" title="Orders" class="text-base align-middle">üìã</span>
          <span class="text-[10px] mt-1 text-slate-500 font-medium">Orders</span>
        </button>
          <button onclick="switchTab('attendance')" id="tab-attendance"
          class="tab-btn flex-1 flex flex-col items-center justify-center px-1 py-2 rounded-lg font-medium text-xl whitespace-nowrap transition-all bg-slate-100 hover:bg-slate-200 relative">
          <span aria-label="Attendance" title="Attendance" class="text-base align-middle">üë•</span>
          <span class="text-[10px] mt-1 text-slate-500 font-medium">Attendance</span>
          <span id="attendance-badge" class="hidden absolute top-1 right-2 w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
        </button>
          <button onclick="switchTab('workers')" id="tab-workers"
          class="tab-btn flex-1 flex flex-col items-center justify-center px-1 py-2 rounded-lg font-medium text-xl whitespace-nowrap transition-all bg-slate-100 hover:bg-slate-200 relative">
          <span aria-label="Production" title="Production" class="text-base align-middle">üë∑</span>
          <span class="text-[10px] mt-1 text-slate-500 font-medium">Production</span>
          <span id="production-badge" class="hidden absolute top-1 right-2 w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
        </button>
          <button onclick="switchTab('investments')" id="tab-investments"
          class="tab-btn flex-1 flex flex-col items-center justify-center px-1 py-2 rounded-lg font-medium text-xl whitespace-nowrap transition-all bg-slate-100 hover:bg-slate-200">
          <span aria-label="Expenses" title="Expenses" class="text-base align-middle">üí∞</span>
          <span class="text-[10px] mt-1 text-slate-500 font-medium">Expenses</span>
        </button>
          <button onclick="switchTab('products')" id="tab-products"
          class="tab-btn flex-1 flex flex-col items-center justify-center px-1 py-2 rounded-lg font-medium text-xl whitespace-nowrap transition-all bg-slate-100 hover:bg-slate-200">
          <span aria-label="Products" title="Products" class="text-base align-middle">üì¶</span>
          <span class="text-[10px] mt-1 text-slate-500 font-medium">Products</span>
        </button>
      </div>
    </nav><!-- Main Content -->
    <main class="flex-1 overflow-auto p-4 scrollbar-thin">
      <div class="w-full flex flex-col gap-3 pb-32 px-2 pt-2"><!-- Dashboard Tab, pb-32 for nav/action bar space -->
        <div id="content-dashboard" class="tab-content animate-fade-in">
          <!-- Notification Permission Banner -->
          <div id="notification-banner" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4 hidden">
            <div class="flex items-center justify-between gap-3">
              <div class="flex items-center gap-3">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                </svg>
                <div>
                  <div class="font-semibold text-blue-900">Enable Daily Reminders</div>
                  <div class="text-sm text-blue-700">Get notified at 10 AM for attendance and 7 PM for production</div>
                </div>
              </div>
              <button onclick="enableNotifications()"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium text-sm whitespace-nowrap">
                Enable Notifications
              </button>
            </div>
          </div>
          <!-- Stats Cards -->
          <div class="grid grid-cols-2 gap-4 mb-6">
            <div onclick="showAllInvestments()"
              class="stat-card rounded-xl p-4 text-white shadow cursor-pointer hover:opacity-90 transition-opacity mb-3">
              <div class="text-sm opacity-80 mb-1">
                Total Monthly Cost
              </div>
              <div id="stat-invested" class="text-2xl font-bold">
                ‚Çπ0
              </div>
              <div class="text-xs opacity-70 mt-1">Materials + Wages + Expenses</div>
            </div>
            <div class="stat-card rounded-xl p-4 text-white shadow mb-3">
              <div class="text-sm opacity-80 mb-1">
                Total Revenue
              </div>
              <div id="stat-revenue" class="text-2xl font-bold">
                ‚Çπ0
              </div>
            </div>
            <div id="profit-loss-card" class="profit-card rounded-xl p-4 text-white shadow mb-3">
              <div class="text-sm opacity-80 mb-1">
                Profit/Loss
              </div>
              <div id="stat-profit" class="text-2xl font-bold">
                ‚Çπ0
              </div>
            </div>
            <div class="pending-card rounded-xl p-4 text-white shadow mb-3">
              <div class="text-sm opacity-80 mb-1">
                Pending Collection
              </div>
              <div id="stat-pending" class="text-2xl font-bold">
                ‚Çπ0
              </div>
            </div>
          </div>

          <!-- Cost Breakdown -->
          <div class="card-gradient rounded-xl shadow-lg p-4 mb-6 border border-slate-200">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2"><span>üíµ</span> Cost Breakdown</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
                <div class="text-sm text-purple-600 mb-1">Raw Materials</div>
                <div class="text-2xl font-bold text-purple-700" id="breakdown-raw-materials">‚Çπ0</div>
              </div>
              <div class="bg-orange-50 border border-orange-200 rounded-lg p-3">
                <div class="text-sm text-orange-600 mb-1">Wages & Expenses</div>
                <div class="text-2xl font-bold text-orange-700" id="breakdown-wages">‚Çπ0</div>
              </div>
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                <div class="text-sm text-blue-600 mb-1">Other Investments</div>
                <div class="text-2xl font-bold text-blue-700" id="breakdown-investments">‚Çπ0</div>
              </div>
            </div>
          </div>

          <!-- Material Usage & Conversion -->
          <div id="material-usage-card" class="card-gradient rounded-xl shadow-lg p-4 mb-6 border border-slate-200"
            style="display:none;">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2"><span>‚öñÔ∏è</span> Material Usage vs Production</h2>
            <p class="text-sm text-slate-600 mb-4">Track how raw materials (kg) convert to finished products (pcs)</p>
            <div id="material-usage-content" class="space-y-3"></div>
          </div>

          <!-- Pending Orders -->
          <div id="pending-orders-card" class="card-gradient rounded-xl shadow-lg p-4 mb-6 border border-slate-200"
            style="display:none;">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2"><span>‚è∞</span> Orders to Settle Soon</h2>
            <div id="pending-orders-list" class="space-y-2"></div>
          </div><!-- Production Targets -->
          <div class="card-gradient rounded-xl shadow-lg p-4 mb-6 border border-slate-200">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2"><span>üéØ</span> Production Targets (Based on
              Pending Orders)</h2>
            <div id="production-targets">
              <p class="text-slate-500 text-center py-8">No pending orders to calculate targets.</p>
            </div>
          </div><!-- Pricing Recommendations -->
          <div class="card-gradient rounded-xl shadow-lg p-4 mb-6 border border-slate-200">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2"><span>üí∞</span> Pricing Recommendations</h2>
            <div id="pricing-recommendations">
              <p class="text-slate-500 text-center py-8">Add production data to calculate recommended prices.</p>
            </div>
          </div><!-- Monthly Breakdown -->
          <div class="card-gradient rounded-xl shadow-lg p-4 mb-6 border border-slate-200">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2"><span>üìÖ</span> Monthly Breakdown</h2>
            <div id="monthly-breakdown" class="overflow-x-auto scrollbar-thin">
              <p class="text-slate-500 text-center py-8">No data available yet. Start by adding investments and sales.
              </p>
            </div>
          </div><!-- Product Analysis -->
          <div class="card-gradient rounded-xl shadow-lg p-4 border border-slate-200">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2"><span>üìà</span> Product Analysis</h2>
            <div class="mb-4"><select id="product-analysis-select" onchange="showProductAnalysis()"
                class="input-field w-full md:w-64 px-3 py-2 border border-slate-300 rounded-lg focus:outline-none">
                <option value="">Select a product...</option>
              </select>
            </div>
            <div id="product-analysis" class="text-slate-500 text-center py-8">
              Select a product to view investment details and cost analysis.
            </div>
          </div>
        </div><!-- Investments Tab -->
        <div id="content-investments" class="tab-content hidden animate-fade-in">
          <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
            <h2 class="text-xl font-bold">üí∞ Investment Records</h2>
            <div id="investment-add-buttons">
              <button id="btn-add-investment" onclick="openModal('investment')"
                class="btn-primary text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg> Add Investment
              </button>
              <button id="btn-add-household" onclick="openModal('household')"
                class="btn-primary text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2"
                style="display:none;">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg> Add Household
              </button>
            </div>
          </div>
          <div class="flex gap-2 mb-4">
            <button id="inv-view-investments" onclick="setInvestmentsView('investments')"
              class="px-3 py-1 rounded-md bg-slate-100 hover:bg-slate-200">Investments</button>
            <button id="inv-view-households" onclick="setInvestmentsView('households')"
              class="px-3 py-1 rounded-md bg-slate-100 hover:bg-slate-200">Households</button>
            <button id="inv-view-rolls" onclick="setInvestmentsView('rolls')"
              class="px-3 py-1 rounded-md bg-slate-100 hover:bg-slate-200">üì¶ Rolls</button>
          </div>
          <div id="rolls-section" class="hidden">
            <div class="flex justify-between items-center mb-4">
              <div>
                <h3 class="text-lg font-bold text-slate-800">üì¶ Raw Material Rolls Inventory</h3>
                <p class="text-sm text-slate-600">Track paper rolls with dimensions for smart wastage calculation</p>
              </div>
              <button onclick="openModal('roll')"
                class="btn-primary text-white px-3 py-2 rounded-lg font-medium text-sm flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg> Add Roll
              </button>
            </div>
            <div id="rolls-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
              <!-- Populated by renderRolls() -->
            </div>
          </div>
          <div class="card-gradient rounded-xl shadow-lg border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto scrollbar-thin">
              <table class="w-full">
                <thead id="investments-table-header" class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Product</th>
                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Quantity</th>
                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Cost</th>
                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Transport</th>
                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Total</th>
                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Date</th>
                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Place</th>
                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Actions</th>
                  </tr>
                </thead>
                <tbody id="investments-table">
                  <tr>
                    <td colspan="8" class="text-center py-8 text-slate-500">No investments recorded yet.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div><!-- Orders Tab -->
        <div id="content-orders" class="tab-content hidden animate-fade-in">
          <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
            <h2 class="text-xl font-bold">üìã Orders Management</h2>
            <div class="flex gap-2">
              <input type="text" id="orders-search" onkeyup="searchOrders()" placeholder="Search customer, product..."
                class="input-field px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                style="min-width: 250px;">
              <button onclick="openModal('order')"
                class="btn-primary text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg> Add Order
              </button>
            </div>
          </div>
          <div class="card-gradient rounded-xl shadow-lg border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto scrollbar-thin">
              <table class="w-full">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Customer</th>
                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Product</th>
                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Items</th>
                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Total Price</th>
                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Paid</th>
                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Balance</th>
                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Issue Date</th>
                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Delivery</th>
                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Actions</th>
                  </tr>
                </thead>
                <tbody id="orders-table">
                  <tr>
                    <td colspan="8" class="text-center py-8 text-slate-500">No orders recorded yet.</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div id="orders-pagination"
              class="flex items-center justify-between px-4 py-3 border-t border-slate-200 bg-slate-50">
              <!-- Pagination controls -->
            </div>
          </div>

          <!-- Payment History Section -->
          <div class="mt-6 card-gradient rounded-xl shadow-lg border border-slate-200 p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-bold text-slate-800">üí∞ Payment History by Customer</h3>
              <input type="text" id="payments-search" onkeyup="searchPayments()" placeholder="Search customer..."
                class="input-field px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                style="max-width: 250px;">
            </div>
            <div id="payment-history-container">
              <!-- Populated by renderPaymentHistory() -->
            </div>
            <div id="payments-pagination" class="flex items-center justify-between mt-4 pt-4 border-t border-slate-200">
              <!-- Pagination controls -->
            </div>
          </div>
        </div><!-- Production Tab -->
        <div id="content-production" class="tab-content hidden animate-fade-in">
          <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
            <h2 class="text-xl font-bold">üè≠ Production Summary</h2>
            <div class="bg-blue-50 border border-blue-200 rounded-lg px-3 py-2 text-sm text-blue-800">
              ‚ú® Auto-calculated from daily worker data
            </div>
          </div>
          <div id="production-summary-card" class="card-gradient rounded-xl shadow-lg p-4 mb-4 border border-slate-200">
            <h3 class="font-bold mb-3 text-slate-700">üìä Monthly Overview</h3>
            <div id="production-monthly-overview" class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <!-- Auto-populated by renderProduction() -->
            </div>
          </div>
          <div id="production-details-card" style="position:relative;">
            <div id="production-details-container">
              <!-- ... -->
            </div>
          </div>
        </div><!-- Workers Tab -->
        <div id="content-workers" class="tab-content hidden animate-fade-in">
          <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
            <h2 class="text-xl font-bold">üè≠ Production Records</h2>
            <button onclick="showTodayProductionView()"
              class="btn-primary text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
              </svg> Today's Production
            </button>
          </div>

          <!-- Filter Options -->
          <div class="bg-slate-50 rounded-lg p-4 mb-4 border border-slate-200">
            <div class="flex flex-wrap items-end gap-3">
              <div>
                <label class="block text-xs font-medium text-slate-600 mb-1">Filter Type</label>
                <select id="production-filter-type" class="input-field px-3 py-2 border border-slate-300 rounded-lg"
                  onchange="updateProductionDateInputs()">
                  <option value="all">All Records</option>
                  <option value="date">Specific Date</option>
                  <option value="week">Week</option>
                  <option value="month" selected>Month</option>
                </select>
              </div>
              <div id="production-date-container" class="flex gap-3">
                <div>
                  <label class="block text-xs font-medium text-slate-600 mb-1">Select Month</label>
                  <input type="month" id="production-month"
                    class="input-field px-3 py-2 border border-slate-300 rounded-lg">
                </div>
              </div>
              <button onclick="filterProductionRecords()"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                Apply Filter
              </button>
            </div>
          </div>

          <div id="worker-summary-card" class="card-gradient rounded-xl shadow-lg p-4 mb-4 border border-slate-200">
            <h3 class="font-bold mb-3 text-slate-700">üìä Worker Performance (Current Month)</h3>
            <div id="worker-summary" class="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                <div class="text-sm text-blue-600 mb-1">Total Workers</div>
                <div class="text-2xl font-bold text-blue-700" id="total-workers">0</div>
              </div>
              <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                <div class="text-sm text-green-600 mb-1">Total Output</div>
                <div class="text-2xl font-bold text-green-700" id="worker-output">0</div>
              </div>
              <div class="bg-orange-50 border border-orange-200 rounded-lg p-3">
                <div class="text-sm text-orange-600 mb-1">Total Wages</div>
                <div class="text-2xl font-bold text-orange-700" id="total-wages">‚Çπ0</div>
              </div>
              <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
                <div class="text-sm text-purple-600 mb-1">Avg Productivity</div>
                <div class="text-2xl font-bold text-purple-700" id="avg-productivity">0</div>
              </div>
            </div>
          </div>
          <div id="worker-details-card"
            class="card-gradient rounded-xl shadow-lg border border-slate-200 overflow-hidden"
            style="position:relative;">
            <div class="overflow-x-auto scrollbar-thin">
              <table class="w-full">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Date</th>
                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Worker Name</th>
                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Product</th>
                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Units Produced</th>
                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Hours Worked</th>
                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Units/Hour</th>
                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Actions</th>
                  </tr>
                </thead>
                <tbody id="workers-table">
                  <tr>
                    <td colspan="10" class="text-center py-8 text-slate-500">No worker records yet.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Production Summary Section -->
          <div class="mt-6 mb-6 bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl p-6 border-2 border-purple-300">
            <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
              <h3 class="text-2xl font-bold text-purple-900">üè≠ Production Summary</h3>
              <div class="bg-blue-600 text-white rounded-lg px-4 py-2 text-sm font-semibold shadow-lg">
                ‚ú® Auto-calculated from daily worker data
              </div>
            </div>
            <div class="card-gradient rounded-xl shadow-lg p-4 mb-4 border border-slate-200 bg-white">
              <h3 class="font-bold mb-3 text-slate-700">üìä Monthly Overview</h3>
              <div id="workers-production-monthly-overview" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <!-- Auto-populated by renderProduction() -->
              </div>
            </div>
            <div id="workers-production-details-container">
              <!-- Auto-populated by renderProduction() -->
            </div>
          </div>
        </div><!-- Attendance Tab -->
        <div id="content-attendance" class="tab-content hidden animate-fade-in">
          <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
            <h2 class="text-xl font-bold">üë• Attendance Management</h2>
            <button onclick="openModal('master_worker')"
              class="btn-primary text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg> Add Worker
            </button>
          </div>

          <!-- Global Settings -->
          <div class="card-gradient rounded-xl shadow-lg p-4 mb-4 border border-slate-200">
            <h3 class="font-bold mb-3 text-slate-700">‚öôÔ∏è Global Settings</h3>
            <div class="flex flex-wrap items-center gap-4">
              <div class="flex items-center gap-3">
                <label class="text-sm font-medium text-slate-700">Paid Leaves per Month:</label>
                <select id="global-paid-leaves" class="input-field px-3 py-2 border border-slate-300 rounded-lg"
                  onchange="saveGlobalPaidLeaves(this.value)">
                  <option value="0">0 days</option>
                  <option value="1">1 day</option>
                  <option value="2">2 days</option>
                  <option value="3">3 days</option>
                  <option value="4" selected>4 days</option>
                  <option value="5">5 days</option>
                  <option value="6">6 days</option>
                  <option value="7">7 days</option>
                  <option value="8">8 days</option>
                </select>
              </div>
              <button onclick="resetAllPaidLeaves()"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                Reset All Paid Leaves
              </button>
              <span class="text-xs text-slate-500">Applied to all workers. Click reset to refresh for new month.</span>
            </div>
          </div>

          <!-- Worker List -->
          <div class="card-gradient rounded-xl shadow-lg p-4 mb-4 border border-slate-200">
            <h3 class="font-bold mb-3 text-slate-700">üë• Workers List</h3>
            <div id="attendance-workers-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
              <!-- Populated by renderAttendanceWorkers() -->
            </div>
          </div>

          <!-- Daily Attendance -->
          <div class="card-gradient rounded-xl shadow-lg p-4 mb-4 border border-slate-200">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-bold text-slate-700">üìÖ Daily Attendance</h3>
              <input type="date" id="attendance-date" class="input-field px-3 py-2 border border-slate-300 rounded-lg"
                onchange="renderAttendanceForDate()">
            </div>
            <div id="attendance-marking-grid" class="space-y-2">
              <!-- Populated by renderAttendanceForDate() -->
            </div>
          </div>

          <!-- Attendance History -->
          <div class="card-gradient rounded-xl shadow-lg p-4 border border-slate-200">
            <h3 class="font-bold mb-4 text-slate-700">üìä Attendance History</h3>

            <!-- Filter Options -->
            <div class="bg-slate-50 rounded-lg p-4 mb-4 border border-slate-200">
              <div class="flex flex-wrap items-end gap-3">
                <div>
                  <label class="block text-xs font-medium text-slate-600 mb-1">Filter Type</label>
                  <select id="history-filter-type" class="input-field px-3 py-2 border border-slate-300 rounded-lg"
                    onchange="updateHistoryDateInputs()">
                    <option value="all">All Records</option>
                    <option value="date">Specific Date</option>
                    <option value="week">Week</option>
                    <option value="month" selected>Month</option>
                  </select>
                </div>
                <div id="history-date-container" class="flex gap-3">
                  <div>
                    <label class="block text-xs font-medium text-slate-600 mb-1">Select Month</label>
                    <input type="month" id="history-month"
                      class="input-field px-3 py-2 border border-slate-300 rounded-lg">
                  </div>
                </div>
                <button onclick="filterAttendanceHistory()"
                  class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                  Apply Filter
                </button>
              </div>
            </div>

            <div id="attendance-history-container">
              <!-- Populated by renderAttendanceHistory() -->
            </div>
          </div>
        </div><!-- Products Tab -->
        <div id="content-sales" class="tab-content hidden animate-fade-in">
          <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
            <h2 class="text-xl font-bold">üõí Sales Records</h2><button onclick="openModal('sale')"
              class="btn-primary text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg> Add Sale </button>
          </div>
          <div class="card-gradient rounded-xl shadow-lg border border-slate-200 overflow-hidden">
            <div class="overflow-x-auto scrollbar-thin">
              <table class="w-full">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Product</th>
                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Customer</th>
                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Qty</th>
                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Price</th>
                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Pending</th>
                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Due Date</th>
                    <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Actions</th>
                  </tr>
                </thead>
                <tbody id="sales-table">
                  <tr>
                    <td colspan="7" class="text-center py-8 text-slate-500">No sales recorded yet.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div><!-- Products Tab -->
        <div id="content-products" class="tab-content hidden animate-fade-in">
          <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
            <h2 class="text-xl font-bold">üì¶ Product Management</h2><button onclick="openModal('product')"
              class="btn-primary text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
              </svg> Add Product </button>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" id="products-grid">
            <div class="col-span-full text-center py-8 text-slate-500">
              No products added yet.
            </div>
          </div>
        </div><!-- Workload Tab -->
        <div id="content-workload" class="tab-content hidden animate-fade-in">
          <div class="card-gradient rounded-xl shadow-lg p-4 border border-slate-200 mb-6">
            <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><span>üë∑</span> Workload Prediction</h2>
            <p class="text-slate-600 mb-4">Based on pending orders and their due dates, here's the estimated workload
              distribution:</p>
            <div id="workload-prediction" class="space-y-4">
              <p class="text-slate-500 text-center py-8">No pending orders to analyze.</p>
            </div>
          </div>
          <div class="card-gradient rounded-xl shadow-lg p-4 border border-slate-200">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2"><span>‚è∞</span> Upcoming Due Dates</h2>
            <div id="upcoming-dues" class="space-y-3">
              <p class="text-slate-500 text-center py-8">No upcoming payment due dates.</p>
            </div>
          </div>
        </div>
      </div>
    </main><!-- Modal -->
    <div id="modal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4">
      <div class="bg-white rounded-xl shadow-2xl w-full max-w-md max-h-[90%] overflow-auto animate-fade-in">
        <div class="p-4 border-b border-slate-200 flex items-center justify-between">
          <h3 id="modal-title" class="text-lg font-bold">Add Item</h3><button onclick="closeModal()"
            class="text-slate-400 hover:text-slate-600 transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg></button>
        </div>
        <form id="modal-form" class="p-4 space-y-4" onsubmit="handleFormSubmit(event)">
          <div id="modal-fields"></div>
          <div class="flex gap-3 pt-2"><button type="button" onclick="closeModal()"
              class="btn-secondary flex-1 py-2 rounded-lg font-medium">Cancel</button> <button type="submit"
              id="modal-submit" class="btn-primary flex-1 text-white py-2 rounded-lg font-medium">Save</button>
          </div>
        </form>
      </div>
    </div><!-- Delete Confirmation -->
    <div id="delete-confirm" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4">
      <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 animate-fade-in">
        <div class="text-center">
          <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center mx-auto mb-4">
            <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewbox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
          </div>
          <h3 class="text-lg font-bold mb-2">Delete Item?</h3>
          <p class="text-slate-600 mb-6">This action cannot be undone.</p>
          <div class="flex gap-3"><button onclick="cancelDelete()"
              class="btn-secondary flex-1 py-2 rounded-lg font-medium">Cancel</button> <button onclick="confirmDelete()"
              class="bg-red-600 hover:bg-red-700 flex-1 text-white py-2 rounded-lg font-medium transition-colors">Delete</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Payment Recording Modal -->
    <div id="payment-modal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4">
      <div class="bg-white rounded-xl shadow-2xl w-full max-w-md animate-fade-in">
        <div class="p-4 border-b border-slate-200 flex items-center justify-between">
          <h3 class="text-lg font-bold">üí∞ Record Payment</h3>
          <button onclick="closePaymentModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div class="p-6">
          <div id="payment-order-info" class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
            <!-- Order info will be populated here -->
          </div>
          <form id="payment-form" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Payment Amount *</label>
              <input type="number" id="payment-amount" step="0.01" required
                class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="0.00">
              <div id="payment-balance-hint" class="text-xs text-slate-500 mt-1"></div>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Payment Date *</label>
                <input type="date" id="payment-date" required
                  class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Time *</label>
                <input type="time" id="payment-time" required
                  class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Payment Mode *</label>
              <select id="payment-mode" required onchange="togglePaymentProof()"
                class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Select payment mode...</option>
                <option value="cash">üíµ Cash</option>
                <option value="phonepay">üì± PhonePe</option>
                <option value="gpay">üí≥ Google Pay</option>
                <option value="paytm">üí∞ Paytm</option>
                <option value="bank">üè¶ Bank Transfer</option>
              </select>
            </div>
            <div id="payment-proof-section" class="hidden">
              <label class="block text-sm font-medium text-slate-700 mb-1">Payment Proof (Optional)</label>
              <input type="file" id="payment-proof" accept="image/*"
                class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
              <div id="payment-proof-preview" class="mt-2"></div>
              <p class="text-xs text-slate-500 mt-1">Upload screenshot of transaction</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Note (Optional)</label>
              <input type="text" id="payment-note"
                class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="e.g., Second installment">
            </div>
            <div class="flex gap-3 pt-2">
              <button type="button" onclick="closePaymentModal()"
                class="btn-secondary flex-1 py-2 rounded-lg font-medium">Cancel</button>
              <button type="submit" class="btn-primary flex-1 text-white py-2 rounded-lg font-medium">Record
                Payment</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Order Receipt Modal -->
    <div id="receipt-modal"
      class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4 overflow-y-auto">
      <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl animate-fade-in my-8"
        style="max-height: 90vh; display: flex; flex-direction: column;">
        <div class="p-4 border-b border-slate-200 flex items-center justify-between no-print flex-shrink-0">
          <h3 class="text-lg font-bold">üìÑ Order Receipt</h3>
          <div class="flex gap-2">
            <button onclick="shareReceiptContent()"
              class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors">
              üì§ Share
            </button>
            <button onclick="printReceipt()"
              class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors">
              üñ®Ô∏è Print
            </button>
            <button onclick="closeReceiptModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
        </div>
        <div id="receipt-content" class="p-8 bg-white relative overflow-y-auto flex-1"
          style="min-height: 400px; max-width: 800px; margin: 0 auto; width: 100%;">
          <!-- Receipt will be generated here -->
        </div>
      </div>
    </div>

    <!-- Worker Detail Modal -->
    <div id="worker-detail-modal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4">
      <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg animate-fade-in">
        <div class="p-4 border-b border-slate-200 flex items-center justify-between">
          <h3 class="text-lg font-bold">üë§ Worker Details</h3>
          <button onclick="closeWorkerDetails()" class="text-slate-400 hover:text-slate-600 transition-colors">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div id="worker-detail-content" class="p-6">
          <!-- Populated by showWorkerDetails() -->
        </div>
      </div>
    </div><!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-80 hidden z-50 flex items-center justify-center">
      <div class="flex flex-col items-center">
        <div class="w-10 h-10 border-4 border-slate-200 border-t-slate-600 rounded-full animate-spin"></div>
        <p class="mt-3 text-slate-600 font-medium">Loading...</p>
      </div>
    </div>
  </div>
  <script>
    // Application State
    let allData = [];
    let currentTab = 'dashboard';
    // Highlight the correct tab as active on page load
    window.addEventListener('DOMContentLoaded', () => {
      // If a tab is specified in the URL hash, use it
      let initialTab = 'dashboard';
      const hash = window.location.hash.replace('#', '');
      if ([
        'dashboard', 'orders', 'attendance', 'workers', 'investments', 'products'
      ].includes(hash)) {
        initialTab = hash;
      }
      currentTab = initialTab;
      // Remove all tab-active classes
      document.querySelectorAll('.tab-btn').forEach(el => {
        el.classList.remove('tab-active');
        el.classList.add('bg-slate-100', 'hover:bg-slate-200');
        el.style.background = '';
        el.style.color = '';
      });
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
      // Show the correct tab content and highlight the tab
      const activeBtn = document.getElementById(`tab-${initialTab}`);
      if (activeBtn) {
        activeBtn.classList.add('tab-active');
        activeBtn.classList.remove('bg-slate-100', 'hover:bg-slate-200');
        activeBtn.style.background = `linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%)`;
        activeBtn.style.color = '#ffffff';
      }
      const activeContent = document.getElementById(`content-${initialTab}`);
      if (activeContent) activeContent.classList.remove('hidden');
    });
    let currentModalType = null;
    let editingItem = null;
    let deleteTarget = null;
    let isLoading = false;

    const defaultConfig = {
      app_title: 'Business Manager Pro',
      currency_symbol: '‚Çπ',
      primary_color: '#1e3a5f',
      secondary_color: '#ffffff',
      text_color: '#1e293b',
      accent_color: '#2d5a87',
      danger_color: '#dc2626',
      font_family: 'DM Sans'
    };

    // Data Handler for SDK
    const dataHandler = {
      onDataChanged(data) {
        allData = data || [];
        migrateProductionData(); // Fix any old production records
        cleanupOrphanedAttendance(); // Remove orphaned attendance records
        migrateOrderUnits(); // Add default units to old orders
        migrateWorkerUnits(); // Add default units to old worker records
        renderAll();
      }
    };
    // Ensure polling and SDK use the same handler
    window.dataHandler = dataHandler;

    // Migration: Add default units to orders without quantity_unit
    async function migrateOrderUnits() {
      const orders = allData.filter(d => d.type === 'order');

      for (const order of orders) {
        if (!order.quantity_unit) {
          order.quantity_unit = 'pcs'; // Default to pieces
          await window.dataSdk.update(order);
          console.log(`Migrated order: ${order.customer_name} - ${order.product_name}, added quantity_unit: pcs`);
        }
      }
    }

    // Migration: Add default units to worker records without production_unit
    async function migrateWorkerUnits() {
      const workers = allData.filter(d => d.type === 'worker');

      for (const worker of workers) {
        if (!worker.production_unit) {
          worker.production_unit = 'pcs'; // Default to pieces
          await window.dataSdk.update(worker);
          console.log(`Migrated worker production: ${worker.worker_name}, added production_unit: pcs`);
        }
      }
    }

    // Cleanup: Remove orphaned attendance records with "Unknown Worker"
    async function cleanupOrphanedAttendance() {
      const attendanceRecords = allData.filter(d => d.type === 'attendance');
      const masterWorkers = allData.filter(d => d.type === 'master_worker');

      for (const record of attendanceRecords) {
        // Check if worker exists
        const workerExists = masterWorkers.find(w => w.__backendId === record.worker_id);

        // If worker doesn't exist and name is Unknown, delete the record
        if (!workerExists && (!record.worker_name || record.worker_name === 'Unknown Worker' || record.worker_name === 'Unknown')) {
          console.log('Cleaning up orphaned attendance record:', record);
          await window.dataSdk.delete(record);
        }
      }
    }

    // Migration: Fix production records missing total_cost
    async function migrateProductionData() {
      const production = allData.filter(d => d.type === 'production');
      let needsUpdate = false;

      for (const prod of production) {
        // If total_cost is missing or zero, recalculate it
        if (!prod.total_cost || prod.total_cost === 0) {
          const rawCost = prod.raw_material_cost || 0;
          const wastage = prod.wastage_percent || 0;
          const calculatedCost = rawCost * (1 + wastage / 100);

          if (calculatedCost > 0) {
            prod.total_cost = calculatedCost;
            needsUpdate = true;
            console.log(`Migrated production record: ${prod.product_name}, total_cost: ${calculatedCost}`);

            // Update in backend
            await window.dataSdk.update(prod);
          }
        }
      }

      if (needsUpdate) {
        console.log('Production data migration completed');
      }
    }

    // Auto-create monthly worker wages in households
    let isCreatingWages = false; // Prevent concurrent executions
    let wagesChecked = false; // Only check once per app load

    async function checkAndCreateMonthlyWages() {
      if (isCreatingWages || wagesChecked) return; // Already running or already checked
      isCreatingWages = true;
      wagesChecked = true; // Mark as checked

      try {
        const today = new Date();
        const currentMonth = today.toISOString().substring(0, 7); // YYYY-MM

        const workers = getMasterWorkers();

        // Update wages for all workers based on their attendance
        for (const worker of workers) {
          if (!worker.monthly_wage || worker.monthly_wage <= 0) continue;
          await updateWorkerMonthlySalary(worker, currentMonth);
        }
      } finally {
        isCreatingWages = false;
      }
    }

    async function updateWorkerMonthlySalary(worker, month) {
      // TODO: Implement salary calculation and wage record creation for worker
      // This function was previously corrupted by misplaced code. Add your logic here.
    }

    // Initialize SDKs
    async function initApp() {
      showLoading(true);

      // Load and display user info
      try {
        const user = api.user;
        const userNameElem = document.getElementById('user-name');
        const roleBadge = document.getElementById('user-role-badge');
        if (userNameElem) userNameElem.textContent = (user && (user.fullName || user.username)) || '';
        if (roleBadge && user && user.role) {
          roleBadge.textContent = user.role.toUpperCase();
          roleBadge.className = user.role === 'admin'
            ? 'text-xs px-2 py-1 rounded-full bg-purple-600 text-white font-semibold'
            : 'text-xs px-2 py-1 rounded-full bg-green-600 text-white font-semibold';
        }
        // Apply role-based UI restrictions
        if (user && user.role) applyRoleRestrictions(user.role);
      } catch (error) {
        console.error('Failed to load user info:', error);
      }

      // Initialize Element SDK
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (config) => {
            applyConfig(config);
          },
          mapToCapabilities: (config) => ({
            recolorables: [
              {
                get: () => config.primary_color || defaultConfig.primary_color,
                set: (v) => window.elementSdk.setConfig({ primary_color: v })
              },
              {
                get: () => config.secondary_color || defaultConfig.secondary_color,
                set: (v) => window.elementSdk.setConfig({ secondary_color: v })
              },
              {
                get: () => config.text_color || defaultConfig.text_color,
                set: (v) => window.elementSdk.setConfig({ text_color: v })
              },
              {
                get: () => config.accent_color || defaultConfig.accent_color,
                set: (v) => window.elementSdk.setConfig({ accent_color: v })
              },
              {
                get: () => config.danger_color || defaultConfig.danger_color,
                set: (v) => window.elementSdk.setConfig({ danger_color: v })
              }
            ],
            borderables: [],
            fontEditable: {
              get: () => config.font_family || defaultConfig.font_family,
              set: (v) => window.elementSdk.setConfig({ font_family: v })
            },
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (config) => new Map([
            ['app_title', config.app_title || defaultConfig.app_title],
            ['currency_symbol', config.currency_symbol || defaultConfig.currency_symbol]
          ])
        });
      }

      // Initialize Data SDK
      if (window.dataSdk) {
        const result = await window.dataSdk.init(dataHandler);
        if (!result.isOk) {
          console.error('Failed to initialize Data SDK');
        } else {
          // Check and create monthly wages only once after data is loaded
          await checkAndCreateMonthlyWages();
        }
      }

      populateMonthSelector();
      showLoading(false);
    }

    
    function populateMonthSelector() {
      const selector = document.getElementById('month-selector');
      const today = new Date();
      const months = [];

      // Add "All Time" option
      months.push('<option value="all">All Time</option>');

      // Generate last 12 months
      for (let i = 0; i < 12; i++) {
        const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const monthValue = `${year}-${month}`; // YYYY-MM format without timezone issues
        const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        const isSelected = i === 0 ? 'selected' : '';
        months.push(`<option value="${monthValue}" ${isSelected}>${monthName}</option>`);
      }

      if (selector) {
        selector.innerHTML = months.join('');
        selectedMonth = selector.value; // Use selector value to ensure sync
        console.log('Month selector populated. Selected month:', selectedMonth);
      }
    }

    function applyConfig(config) {
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const secondaryColor = config.secondary_color || defaultConfig.secondary_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const accentColor = config.accent_color || defaultConfig.accent_color;
      const dangerColor = config.danger_color || defaultConfig.danger_color;
      const fontFamily = config.font_family || defaultConfig.font_family;
      const appTitle = config.app_title || defaultConfig.app_title;
      const currency = config.currency_symbol || defaultConfig.currency_symbol;

      // Apply font
      document.body.style.fontFamily = `${fontFamily}, sans-serif`;

      // Apply title
      document.getElementById('app-title').textContent = appTitle;

      // Apply colors to stat cards
      document.querySelectorAll('.stat-card').forEach(el => {
        el.style.background = `linear-gradient(135deg, ${primaryColor} 0%, ${accentColor} 100%)`;
      });

      // Apply colors to buttons
      document.querySelectorAll('.btn-primary').forEach(el => {
        el.style.background = `linear-gradient(135deg, ${primaryColor} 0%, ${accentColor} 100%)`;
      });

      // Apply tab active color
      document.querySelectorAll('.tab-active').forEach(el => {
        el.style.background = `linear-gradient(135deg, ${primaryColor} 0%, ${accentColor} 100%)`;
      });

      // Apply text color
      document.body.style.color = textColor;

      // Apply pending/danger colors
      document.querySelectorAll('.pending-card').forEach(el => {
        el.style.background = `linear-gradient(135deg, ${dangerColor} 0%, ${lightenColor(dangerColor, 20)} 100%)`;
      });

      // Re-render with new currency
      renderAll();
    }

    function lightenColor(color, percent) {
      const num = parseInt(color.replace('#', ''), 16);
      const amt = Math.round(2.55 * percent);
      const R = (num >> 16) + amt;
      const G = (num >> 8 & 0x00FF) + amt;
      const B = (num & 0x0000FF) + amt;
      return '#' + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 + (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 + (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
    }

    function getCurrency() {
      if (window.elementSdk && window.elementSdk.config) {
        return window.elementSdk.config.currency_symbol || defaultConfig.currency_symbol;
      }
      return defaultConfig.currency_symbol;
    }

    function showLoading(show) {
      isLoading = show;
      const overlay = document.getElementById('loading-overlay');
      if (overlay) overlay.classList.toggle('hidden', !show);
    }

    // Tab Navigation
    function showAllInvestments() {
      switchTab('investments');
      // Show modal with investment breakdown
      showInvestmentBreakdown();
    }

    function showInvestmentBreakdown() {
      const currency = getCurrency();
      const investments = allData.filter(d => d.type === 'investment');
      const households = allData.filter(d => d.type === 'household');

      const investTotal = investments.reduce((sum, i) => sum + (i.cost || 0), 0);
      const householdTotal = households.reduce((sum, h) => sum + (h.cost || 0), 0);
      const grandTotal = investTotal + householdTotal;

      const modal = document.getElementById('modal');
      const title = document.getElementById('modal-title');
      const fields = document.getElementById('modal-fields');

      title.textContent = 'Investment Breakdown';
      fields.innerHTML = `
        <div class="space-y-4">
          <div class="bg-blue-50 rounded-lg p-4">
            <div class="flex justify-between items-center mb-2">
              <span class="font-semibold text-slate-700">Product Investments</span>
              <span class="font-bold text-blue-600">${currency}${investTotal.toLocaleString()}</span>
            </div>
            <div class="text-sm text-slate-600">${investments.length} records</div>
          </div>
          <div class="bg-amber-50 rounded-lg p-4">
            <div class="flex justify-between items-center mb-2">
              <span class="font-semibold text-slate-700">Household Expenses</span>
              <span class="font-bold text-amber-600">${currency}${householdTotal.toLocaleString()}</span>
            </div>
            <div class="text-sm text-slate-600">${households.length} records</div>
          </div>
          <div class="bg-slate-100 rounded-lg p-4 border-2 border-slate-300">
            <div class="flex justify-between items-center">
              <span class="font-bold text-slate-800">Total Invested</span>
              <span class="font-bold text-2xl text-slate-800">${currency}${grandTotal.toLocaleString()}</span>
            </div>
          </div>
          <div class="pt-2">
            <button onclick="closeModal(); setInvestmentsView('investments')" class="w-full btn-primary text-white py-2 rounded-lg font-medium mb-2">View Product Investments</button>
            <button onclick="closeModal(); setInvestmentsView('households')" class="w-full btn-secondary py-2 rounded-lg font-medium">View Household Expenses</button>
          </div>
        </div>
      `;

      // Hide form submit buttons
      document.getElementById('modal-submit').style.display = 'none';
      document.querySelector('#modal-form button[onclick="closeModal()"]').textContent = 'Close';

      modal.classList.remove('hidden');
    }

    function switchTab(tab) {
      // Check role permissions
      if (api.isUser()) {
        if (tab !== 'workers') {
          alert('‚õî Access Denied: You can only access the Production tab.');
          return;
        }
      }

      currentTab = tab;
      document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
      document.querySelectorAll('.tab-btn').forEach(el => {
        el.classList.remove('tab-active');
        el.classList.add('bg-slate-100', 'hover:bg-slate-200');
        // clear any inline styles applied earlier so only the active tab has the colored background
        el.style.background = '';
        el.style.color = '';
      });

      document.getElementById(`content-${tab}`).classList.remove('hidden');
      const activeBtn = document.getElementById(`tab-${tab}`);
      activeBtn.classList.add('tab-active');
      activeBtn.classList.remove('bg-slate-100', 'hover:bg-slate-200');

      // Re-apply config colors to active tab
      if (window.elementSdk && window.elementSdk.config) {
        const config = window.elementSdk.config;
        const primaryColor = config.primary_color || defaultConfig.primary_color;
        const accentColor = config.accent_color || defaultConfig.accent_color;
        activeBtn.style.background = `linear-gradient(135deg, ${primaryColor} 0%, ${accentColor} 100%)`;
        activeBtn.style.color = '#ffffff';
      }

      // Initialize attendance tab settings
      if (tab === 'attendance') {
        const paidLeavesInput = document.getElementById('global-paid-leaves');
        if (paidLeavesInput) {
          paidLeavesInput.value = getGlobalPaidLeaves();
        }
        // Initialize history filter
        updateHistoryDateInputs();
        filterAttendanceHistory();
      }

      // Re-render production summary when switching to workers tab
      if (tab === 'workers') {
        // Initialize production filter
        updateProductionDateInputs();
        const currentMonth = new Date().toISOString().slice(0, 7);
        productionFilterState = { type: 'month', value: currentMonth };
        renderProduction();
        renderWorkers();
      }
    }

    // Apply role-based UI restrictions
    function applyRoleRestrictions(role) {
      if (role === 'user') {
        // Hide all tabs except Production for regular users
        const tabs = ['dashboard', 'orders', 'attendance', 'investments', 'products', 'rolls', 'master-workers'];
        tabs.forEach(tabId => {
          const tabBtn = document.getElementById(`tab-${tabId}`);
          if (tabBtn) {
            tabBtn.style.opacity = '0.5';
            tabBtn.style.cursor = 'not-allowed';
            tabBtn.onclick = function(e) {
              e.preventDefault();
              alert('‚õî Access Denied: You can only access the Production tab.');
              return false;
            };
          }
        });

        // Automatically switch to workers tab (Production)
        setTimeout(() => switchTab('workers'), 0);

        // Restrict worker tab to show only today's data and hide edit/delete buttons
        restrictWorkerTabForUsers();
      }
    }

    // Restrict worker tab features for regular users
    function restrictWorkerTabForUsers() {
      if (!api.isUser()) return;

      // Override delete function for users
      const originalDeleteItem = window.deleteItem;
      window.deleteItem = function (id) {
        if (typeof shouldLockProductionUI === 'function' && shouldLockProductionUI()) {
          alert('‚õî You cannot delete records after submitting today\'s production.');
          return;
        }
        alert('‚õî You do not have permission to delete records.');
      };

      // Filter to show only today's production
      const today = new Date().toISOString().split('T')[0];
      window.userProductionDateFilter = today;
    }

    // Confirm logout with user
    function confirmLogout() {
      if (confirm('Are you sure you want to logout?')) {
        if (api.logout instanceof Function) {
          const result = api.logout();
          if (result && typeof result.then === 'function') {
            result.then(() => {}).catch(() => {});
          }
        }
      }
    }

    // Calculate total cost for roll based on weight and per kg cost
    function calculateRollTotalCost() {
      const weight = parseFloat(document.getElementById('roll-weight-input')?.value) || 0;
      const costPerKg = parseFloat(document.getElementById('roll-cost-per-kg')?.value) || 0;
      const totalCost = weight * costPerKg;

      document.getElementById('roll-total-cost').textContent = '‚Çπ' + totalCost.toFixed(2);
      document.getElementById('roll-total-cost-hidden').value = totalCost;
    }

    // Update current stock to match roll weight for new rolls
    function updateCurrentStock() {
      const weight = parseFloat(document.getElementById('roll-weight-input')?.value) || 0;
      const currentStockInput = document.getElementById('roll-current-stock');
      if (currentStockInput) {
        currentStockInput.value = weight;
      }
    }

    // Data Helpers
    function getProducts() {
      return allData.filter(d => d.type === 'product' && d.active);
    }

    // investments include both normal investments and household expenses
    function getInvestments() {
      return allData.filter(d => d.type === 'investment' || d.type === 'household');
    }

    function getSales() {
      return allData.filter(d => d.type === 'sale');
    }

    function getOrders() {
      return allData.filter(d => d.type === 'order');
    }

    function getProduction() {
      return allData.filter(d => d.type === 'production');
    }

    function getWorkers() {
      return allData.filter(d => d.type === 'worker');
    }

    function getMasterWorkers() {
      return allData.filter(d => d.type === 'master_worker');
    }

    // Convert between material units and product units using conversion factor
    function convertMaterialToProduct(productName, materialQuantity, materialUnit) {
      const product = getProducts().find(p => p.name === productName);
      if (!product || !product.material_quantity || !product.material_unit || !product.produces_quantity || !product.produces_unit) {
        return null; // No conversion set
      }

      // Check if units match
      if (product.material_unit !== materialUnit) {
        console.warn(`Material unit mismatch: expected ${product.material_unit}, got ${materialUnit}`);
        return null;
      }

      // Calculate how many product units can be produced
      const conversionRate = product.produces_quantity / product.material_quantity;
      const producedQuantity = materialQuantity * conversionRate;

      return {
        quantity: producedQuantity,
        unit: product.produces_unit,
        conversionRate: conversionRate
      };
    }

    // Convert product quantity back to material quantity
    function convertProductToMaterial(productName, productQuantity, productUnit) {
      const product = getProducts().find(p => p.name === productName);
      if (!product || !product.material_quantity || !product.material_unit || !product.produces_quantity || !product.produces_unit) {
        return null; // No conversion set
      }

      // Check if units match
      if (product.produces_unit !== productUnit) {
        console.warn(`Product unit mismatch: expected ${product.produces_unit}, got ${productUnit}`);
        return null;
      }

      // Calculate how much material is needed
      const conversionRate = product.material_quantity / product.produces_quantity;
      const materialNeeded = productQuantity * conversionRate;

      return {
        quantity: materialNeeded,
        unit: product.material_unit,
        conversionRate: conversionRate
      };
    }

    function getTodayPresentWorkers() {
      const today = new Date().toISOString().split('T')[0];
      const attendanceRecords = getAttendance();
      const todayAttendance = attendanceRecords.filter(a => a.date === today && a.status === 'present');
      const presentWorkerIds = new Set(todayAttendance.map(a => a.worker_id));

      const masterWorkers = getMasterWorkers();
      return masterWorkers.filter(w => presentWorkerIds.has(w.__backendId));
    }

    async function createProductionPlaceholder(workerId, date) {
      try {
        const workers = getWorkers();
        const existingProduction = workers.find(w => w.worker_id === workerId && w.date === date);

        if (existingProduction) return; // Already exists

        const masterWorker = getMasterWorkers().find(w => w.__backendId === workerId);
        if (!masterWorker) return;

        const dailyWage = masterWorker.monthly_wage ? (masterWorker.monthly_wage / 26) : 0;

        const record = {
          type: 'worker',
          worker_id: workerId,
          worker_name: masterWorker.name,
          product_name: '',
          order_id: null,
          units_produced: 0,
          hours_worked: 0,
          wage: dailyWage,
          order_length: null,
          order_width: null,
          date: date,
          is_placeholder: true,
          created_at: new Date().toISOString()
        };

        await window.dataSdk.create(record);
      } catch (error) {
        console.error('Failed to create production placeholder:', error);
      }
    }

    function showTodayProductionView() {
      if (typeof shouldLockProductionUI === 'function' && shouldLockProductionUI()) {
        alert('‚õî You have reached the maximum of 2 edits for today. Editing is now locked.');
        return;
      }
      const today = new Date().toISOString().split('T')[0];
      const attendanceRecords = getAttendance().filter(a => a.date === today);

      if (attendanceRecords.length === 0) {
        alert('‚ö†Ô∏è Please mark attendance first.\n\nGo to the Attendance tab to mark who is present/absent today.');
        return;
      }

      renderTodayProductionModal();
    }

    function renderTodayProductionModal() {
      const today = new Date().toISOString().split('T')[0];
      const attendanceRecords = getAttendance().filter(a => a.date === today);
      const productionRecords = getWorkers().filter(w => w.date === today);
      const masterWorkers = getMasterWorkers();

      const modal = document.getElementById('modal');
      const title = document.getElementById('modal-title');
      const fields = document.getElementById('modal-fields');
      const submitBtn = document.getElementById('modal-submit');

      title.textContent = `üìã Today's Production - ${new Date(today).toLocaleDateString()}`;
      submitBtn.style.display = 'none';

      fields.innerHTML = `
        <div class="space-y-3">
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm text-blue-700">
            ‚ÑπÔ∏è Click on any worker to edit their production details. Present workers are highlighted.
          </div>
          <div class="space-y-2 max-h-96 overflow-y-auto">
            ${masterWorkers.map(worker => {
        const attendance = attendanceRecords.find(a => a.worker_id === worker.__backendId);
        const production = productionRecords.find(p => p.worker_id === worker.__backendId);
        const isPresent = attendance?.status === 'present';
        const hasProduction = production && (production.units_produced > 0 || production.product_name);

        return `
                <div class="border rounded-lg p-3 cursor-pointer hover:shadow-md transition-all ${isPresent ? 'bg-white border-green-300' : 'bg-slate-50 border-slate-300 opacity-60'
          }" onclick="${isPresent ? `editWorkerProduction('${production?.__backendId || ''}', '${worker.__backendId}', '${today}')` : ''}">  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                      <div class="w-10 h-10 rounded-full flex items-center justify-center text-lg ${isPresent ? 'bg-green-100 text-green-700' : 'bg-slate-200 text-slate-500'
          }">
                        ${isPresent ? '‚úì' : '‚úó'}
                      </div>
                      <div>
                        <div class="font-semibold ${isPresent ? 'text-slate-800' : 'text-slate-500'}">
                          ${escapeHtml(worker.name)}
                        </div>
                        <div class="text-xs text-slate-500">
                          ${isPresent ? '‚úì Present' : '‚úó Absent'} | ‚Çπ${worker.monthly_wage || 0}/month
                        </div>
                      </div>
                    </div>
                    <div class="text-right">
                      ${hasProduction ? `
                        <div class="text-sm font-semibold text-green-600">‚úì Logged</div>
                        <div class="text-xs text-slate-600">${production.units_produced} units | ${production.hours_worked}h</div>
                      ` : isPresent ? `
                        <div class="text-sm font-semibold text-amber-600">‚ö† Pending</div>
                        <div class="text-xs text-slate-500">Click to add</div>
                      ` : `
                        <div class="text-sm text-slate-400">-</div>
                      `}
                    </div>
                  </div>
                </div>
              `;
      }).join('')}
          </div>
        </div>
      `;

      modal.classList.remove('hidden');
    }

    function editWorkerProduction(productionId, workerId, date) {
      // Only allow one add per user per day
      if (typeof shouldHideCompanyData === 'function' && shouldHideCompanyData()) {
        alert('‚õî You have already added production for today. You cannot add, edit, or delete further.');
        return;
      }
      closeModal();
      setTimeout(() => {
        if (productionId && productionId !== '') {
          const production = allData.find(d => d.__backendId === productionId);
          if (production) {
            openModal('worker', production);
          } else {
            console.error('Production record not found:', productionId);
            openModal('worker', null);
          }
        } else {
          // New production - don't pass item so it creates new record
          openModal('worker', null);
          // Pre-select worker and date after modal opens
          setTimeout(() => {
            const workerSelect = document.querySelector('select[name="worker_name"]');
            const dateInput = document.querySelector('input[name="date"]');
            const masterWorker = getMasterWorkers().find(w => w.__backendId === workerId);

            if (workerSelect && masterWorker) {
              workerSelect.value = masterWorker.name;
              calculateWorkerWage();
            }
            if (dateInput) {
              dateInput.value = date;
            }
          }, 50);
        }
      }, 100);
    }

    function getRolls() {
      return allData.filter(d => d.type === 'roll');
    }

    // Month Filtering
    let selectedMonth = '2026-01'; // Default to January 2026

    // Production daily records pagination and filtering
    let productionDailyPage = 1;
    let productionDailyViewMode = 'all'; // 'all', 'week', 'month'
    const RECORDS_PER_PAGE = 5; // Number of days to show per page

    function filterByMonth() {
      const selector = document.getElementById('month-selector');
      const oldMonth = selectedMonth;
      selectedMonth = selector.value;
      console.log('Month filter changed from:', oldMonth, 'to:', selectedMonth, '| Selector value:', selector.value, '| Selected option text:', selector.options[selector.selectedIndex].text);
      renderAll();
    }

    function getFilteredData(dataArray, debugLabel = '') {
      if (selectedMonth === 'all') {
        console.log(`[${debugLabel}] All time mode - returning all ${dataArray.length} items`);
        return dataArray;
      }
      const filtered = dataArray.filter(item => {
        const itemDate = item.date || item.issue_date || item.created_at;
        if (!itemDate) {
          console.log(`[${debugLabel}] Item has no date:`, item.type, item.__backendId);
          return false;
        }
        const itemMonth = itemDate.substring(0, 7); // YYYY-MM
        const matches = itemMonth === selectedMonth;
        if (!matches && debugLabel) {
          console.log(`[${debugLabel}] Item date ${itemDate} (${itemMonth}) doesn't match ${selectedMonth}`);
        }
        return matches;
      });
      console.log(`[${debugLabel}] Filtering ${dataArray.length} items for month ${selectedMonth}, found ${filtered.length} matches`);
      return filtered;
    }

    // Render Functions
    let investmentsView = 'investments';
    function setInvestmentsView(v) {
      investmentsView = v;
      // toggle active styles
      document.getElementById('inv-view-investments').classList.toggle('tab-active', v === 'investments');
      document.getElementById('inv-view-households').classList.toggle('tab-active', v === 'households');
      document.getElementById('inv-view-rolls').classList.toggle('tab-active', v === 'rolls');

      // toggle add buttons
      document.getElementById('btn-add-investment').style.display = v === 'investments' ? 'flex' : 'none';
      document.getElementById('btn-add-household').style.display = v === 'households' ? 'flex' : 'none';

      // toggle sections
      const investmentsTable = document.querySelector('#investments-table').closest('.card-gradient');
      const rollsSection = document.getElementById('rolls-section');

      if (v === 'rolls') {
        investmentsTable.style.display = 'none';
        rollsSection.classList.remove('hidden');
        renderRolls();
      } else {
        investmentsTable.style.display = 'block';
        rollsSection.classList.add('hidden');
        renderInvestments();
      }
    }
    function renderAll() {
      if (typeof renderStats === 'function') renderStats();
      if (typeof renderInvestments === 'function') renderInvestments();
      if (typeof renderSales === 'function') renderSales();
      if (typeof renderProducts === 'function') renderProducts();
      if (typeof renderOrders === 'function') renderOrders();
      if (typeof renderRolls === 'function') renderRolls();
      if (typeof renderAttendanceWorkers === 'function') renderAttendanceWorkers();
      if (typeof renderAttendanceForDate === 'function') renderAttendanceForDate(); // Also render daily attendance grid
      if (typeof renderPendingOrdersCard === 'function') renderPendingOrdersCard();
      if (typeof renderProduction === 'function') renderProduction();
      if (typeof renderWorkers === 'function') renderWorkers();
      if (typeof renderProductionTargets === 'function') renderProductionTargets();
      if (typeof renderPricingRecommendations === 'function') renderPricingRecommendations();
      if (typeof renderMonthlyBreakdown === 'function') renderMonthlyBreakdown();
      if (typeof renderProductAnalysisDropdown === 'function') renderProductAnalysisDropdown();
      if (typeof updateAlerts === 'function') updateAlerts();
    }

    function renderStats() {
      const currency = getCurrency();
      const investments = getFilteredData(getInvestments(), 'STATS-investments');
      const orders = getFilteredData(getOrders(), 'STATS-orders');
      const production = getFilteredData(getProduction(), 'STATS-production');
      const households = getFilteredData(allData.filter(d => d.type === 'household'), 'STATS-households');

      const totalInvested = investments.reduce((sum, i) => sum + (i.cost || 0), 0);

      // Calculate total revenue from orders (total price)
      const totalRevenue = orders.reduce((sum, o) => sum + (o.price || 0), 0);

      // Calculate total pending collection from orders (balance)
      const totalPending = orders.reduce((sum, o) => {
        const balance = (o.balance !== undefined) ? o.balance : (o.price - (o.amount_paid || 0));
        return sum + balance;
      }, 0);

      // Calculate total cost: investments + production raw materials + household expenses (including worker wages)
      // Raw materials = cost of all rolls purchased + production raw material costs
      const rollsCost = getRolls().reduce((sum, r) => sum + (r.cost || 0), 0);
      const productionRawMaterialCost = production.reduce((sum, p) => {
        const cost = p.total_cost || p.raw_material_cost || 0;
        return sum + cost;
      }, 0);
      const rawMaterialCost = rollsCost + productionRawMaterialCost;
      const householdExpenses = households.reduce((sum, h) => sum + (h.cost || 0), 0);
      const totalCost = totalInvested + rawMaterialCost + householdExpenses;

      // Debug: Log production data
      console.log('Rolls Cost:', rollsCost);
      console.log('Production Raw Material Cost:', productionRawMaterialCost);
      console.log('Total Raw Material Cost:', rawMaterialCost);
      console.log('Total Invested:', totalInvested);
      console.log('Household Expenses:', householdExpenses);
      console.log('Total Cost:', totalCost);

      const profitLoss = totalRevenue - totalCost;

      document.getElementById('stat-invested').textContent = `${currency}${totalCost.toLocaleString()}`;
      document.getElementById('stat-revenue').textContent = `${currency}${totalRevenue.toLocaleString()}`;
      document.getElementById('stat-profit').textContent = `${currency}${Math.abs(profitLoss).toLocaleString()}`;
      document.getElementById('stat-pending').textContent = `${currency}${totalPending.toLocaleString()}`;
      document.getElementById('total-pending').textContent = `${currency}${totalPending.toLocaleString()}`;

      // Update breakdown cards
      document.getElementById('breakdown-raw-materials').textContent = `${currency}${rawMaterialCost.toLocaleString()}`;
      document.getElementById('breakdown-wages').textContent = `${currency}${householdExpenses.toLocaleString()}`;
      document.getElementById('breakdown-investments').textContent = `${currency}${totalInvested.toLocaleString()}`;

      const profitCard = document.getElementById('profit-loss-card');
      if (profitLoss >= 0) {
        profitCard.className = 'profit-card rounded-xl p-4 text-white shadow-lg';
        profitCard.querySelector('.text-sm').textContent = 'Profit';
      } else {
        profitCard.className = 'loss-card rounded-xl p-4 text-white shadow-lg';
        profitCard.querySelector('.text-sm').textContent = 'Loss';
      }

      // Render Material Usage vs Production
      renderMaterialUsage();
    }

    function renderMaterialUsage() {
      const currency = getCurrency();
      const products = getProducts();
      const workers = getFilteredData(getWorkers(), 'MATERIAL-USAGE-workers');
      const investments = getFilteredData(getInvestments().filter(i => i.type === 'investment'), 'MATERIAL-USAGE-investments');

      // Find products with conversion factors
      const productsWithConversion = products.filter(p =>
        p.material_quantity && p.material_unit && p.produces_quantity && p.produces_unit
      );

      if (productsWithConversion.length === 0) {
        document.getElementById('material-usage-card').style.display = 'none';
        return;
      }

      document.getElementById('material-usage-card').style.display = 'block';

      let usageHTML = '';

      productsWithConversion.forEach(product => {
        // Calculate total production for this product
        const productWorkers = workers.filter(w => w.product_name === product.name);
        const totalProduced = productWorkers.reduce((sum, w) => sum + (w.units_produced || 0), 0);
        const productionUnit = productWorkers.length > 0 ? (productWorkers[0].production_unit || 'pcs') : product.produces_unit;

        // Calculate material needed based on production
        const materialNeeded = convertProductToMaterial(product.name, totalProduced, productionUnit);

        // Calculate material purchased for this product
        const productInvestments = investments.filter(i => i.name === product.name);
        const totalMaterialPurchased = productInvestments.reduce((sum, i) => sum + (i.quantity || 0), 0);
        const materialUnit = productInvestments.length > 0 ? productInvestments[0].unit : product.material_unit;
        const totalMaterialCost = productInvestments.reduce((sum, i) => sum + (i.cost || 0), 0);

        if (totalProduced === 0 && totalMaterialPurchased === 0) return;

        const materialUsed = materialNeeded ? materialNeeded.quantity : 0;
        const materialRemaining = totalMaterialPurchased - materialUsed;
        const utilizationPercent = totalMaterialPurchased > 0 ? (materialUsed / totalMaterialPurchased * 100) : 0;

        usageHTML += `
          <div class="bg-gradient-to-r from-orange-50 to-amber-50 border border-orange-200 rounded-lg p-4">
            <div class="flex justify-between items-start mb-3">
              <h3 class="font-bold text-slate-800">${escapeHtml(product.name)}</h3>
              <span class="text-xs px-2 py-1 rounded-full ${utilizationPercent > 100 ? 'bg-red-100 text-red-700' : utilizationPercent > 80 ? 'bg-orange-100 text-orange-700' : 'bg-green-100 text-green-700'}">
                ${utilizationPercent.toFixed(0)}% utilized
              </span>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
              <div class="bg-white rounded-lg p-2 border border-slate-200">
                <div class="text-xs text-slate-600">Material Purchased</div>
                <div class="text-lg font-bold text-blue-700">${totalMaterialPurchased.toFixed(2)} ${materialUnit}</div>
                <div class="text-xs text-slate-500">${currency}${totalMaterialCost.toLocaleString()}</div>
              </div>
              <div class="bg-white rounded-lg p-2 border border-slate-200">
                <div class="text-xs text-slate-600">Material Used</div>
                <div class="text-lg font-bold text-purple-700">${materialUsed.toFixed(2)} ${materialUnit}</div>
                <div class="text-xs text-slate-500">for ${totalProduced} ${productionUnit}</div>
              </div>
              <div class="bg-white rounded-lg p-2 border border-slate-200">
                <div class="text-xs text-slate-600">Material Remaining</div>
                <div class="text-lg font-bold ${materialRemaining < 0 ? 'text-red-700' : 'text-green-700'}">${materialRemaining.toFixed(2)} ${materialUnit}</div>
                <div class="text-xs text-slate-500">${materialRemaining < 0 ? 'Over-utilized!' : 'Available'}</div>
              </div>
            </div>
            
            <div class="bg-white border border-slate-300 rounded p-2 text-xs text-slate-600">
              <strong>Conversion:</strong> ${product.material_quantity} ${product.material_unit} = ${product.produces_quantity} ${product.produces_unit}
              <span class="text-slate-500">(${(product.produces_quantity / product.material_quantity).toFixed(2)} ${product.produces_unit}/${product.material_unit})</span>
            </div>
          </div>
        `;
      });

      document.getElementById('material-usage-content').innerHTML = usageHTML || '<p class="text-slate-500 text-center py-4">No material usage data available for this period</p>';
    }

    function renderSales() {
      const currency = getCurrency();
      const sales = getFilteredData(getSales(), 'SALES');
      const tbody = document.getElementById('sales-table');

      if (sales.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-slate-500">No sales recorded yet.</td></tr>';
        return;
      }

      tbody.innerHTML = sales.map(sale => {
        const isPending = (sale.pending_balance || 0) > 0;
        const isOverdue = isPending && sale.payment_due_date && new Date(sale.payment_due_date) < new Date();

        return `
          <tr class="table-row border-b border-slate-100 ${isOverdue ? 'bg-red-50' : ''}">
            <td class="px-4 py-3 font-medium">${escapeHtml(sale.name || '')}</td>
            <td class="px-4 py-3">${escapeHtml(sale.customer_name || '-')}</td>
            <td class="px-4 py-3">${sale.quantity || 0} ${escapeHtml(sale.unit || '')}</td>
            <td class="px-4 py-3 font-semibold text-green-600">${currency}${(sale.selling_price || 0).toLocaleString()}</td>
            <td class="px-4 py-3 ${isPending ? 'text-red-600 font-semibold' : 'text-slate-600'}">${currency}${(sale.pending_balance || 0).toLocaleString()}</td>
            <td class="px-4 py-3 ${isOverdue ? 'text-red-600 font-semibold' : 'text-slate-600'}">${sale.payment_due_date ? formatDate(sale.payment_due_date) : '-'}</td>
            <td class="px-4 py-3">
              <div class="flex gap-2">
                <button onclick="editItem('${sale.__backendId}', 'sale')" class="text-blue-600 hover:text-blue-800 transition-colors">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                </button>
                <button onclick="deleteItem('${sale.__backendId}')" class="text-red-600 hover:text-red-800 transition-colors">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                  </svg>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function renderProducts() {
      const products = allData.filter(d => d.type === 'product');
      const grid = document.getElementById('products-grid');

      if (products.length === 0) {
        grid.innerHTML = '<div class="col-span-full text-center py-8 text-slate-500">No products added yet.</div>';
        return;
      }

      grid.innerHTML = products.map(prod => `
        <div class="card-gradient rounded-xl shadow-lg border border-slate-200 p-4 ${!prod.active ? 'opacity-60' : ''}">
          <div class="flex items-start justify-between mb-3">
            <div>
              <h3 class="font-bold text-lg">${escapeHtml(prod.name || '')}</h3>
              <span class="text-xs px-2 py-1 rounded-full ${prod.active ? 'bg-green-100 text-green-700' : 'bg-slate-200 text-slate-600'}">
                ${prod.active ? 'Active' : 'Inactive'}
              </span>
            </div>
            <div class="flex gap-1">
              <button onclick="toggleProduct('${prod.__backendId}')" class="p-1 ${prod.active ? 'text-amber-600 hover:text-amber-800' : 'text-green-600 hover:text-green-800'} transition-colors" title="${prod.active ? 'Deactivate' : 'Activate'}">
                ${prod.active ?
          '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/></svg>' :
          '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>'
        }
              </button>
              <button onclick="deleteItem('${prod.__backendId}')" class="p-1 text-red-600 hover:text-red-800 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
              </button>
            </div>
          </div>
          <p class="text-sm text-slate-600 mb-2">Unit: ${escapeHtml(prod.unit || 'piece')}</p>
          ${prod.material_quantity && prod.material_unit && prod.produces_quantity && prod.produces_unit ? `
            <div class="mt-3 pt-3 border-t border-slate-200">
              <div class="text-xs font-semibold text-orange-700 mb-1">‚öñÔ∏è Material Conversion:</div>
              <div class="text-xs text-slate-600">
                ${prod.material_quantity} ${prod.material_unit} = ${prod.produces_quantity} ${prod.produces_unit}
              </div>
              <div class="text-xs text-slate-500 mt-1">
                (${(prod.produces_quantity / prod.material_quantity).toFixed(2)} ${prod.produces_unit} per ${prod.material_unit})
              </div>
            </div>
          ` : ''}
        </div>
      `).join('');
    }

    function renderOrders() {
      const currency = getCurrency();
      let orders = getFilteredData(getOrders(), 'ORDERS');
      const tbody = document.getElementById('orders-table');
      const paginationDiv = document.getElementById('orders-pagination');
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // Apply search filter
      const searchTerm = document.getElementById('orders-search')?.value.toLowerCase() || '';
      if (searchTerm) {
        orders = orders.filter(o => {
          // Search customer name
          if (o.customer_name && o.customer_name.toLowerCase().includes(searchTerm)) return true;

          // Search legacy product_name
          if (o.product_name && o.product_name.toLowerCase().includes(searchTerm)) return true;

          // Search in products array for multi-product orders
          if (o.products && o.products.length > 0) {
            return o.products.some(p => p.product_name && p.product_name.toLowerCase().includes(searchTerm));
          }

          return false;
        });
      }

      filteredOrders = orders;
      const totalPages = Math.ceil(orders.length / ordersPerPage);
      const start = (currentOrdersPage - 1) * ordersPerPage;
      const end = start + ordersPerPage;
      const paginatedOrders = orders.slice(start, end);

      if (orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center py-8 text-slate-500">No orders found.</td></tr>';
        if (paginationDiv) paginationDiv.innerHTML = '';
        return;
      }

      tbody.innerHTML = paginatedOrders.map(order => {
        const deliveryDate = order.delivery_date ? new Date(order.delivery_date) : null;
        const isOverdue = deliveryDate && deliveryDate < today && !order.settled;
        const isDueSoon = deliveryDate && !order.settled && deliveryDate >= today && deliveryDate <= new Date(today.getTime() + 3 * 24 * 60 * 60 * 1000);
        const balance = (order.balance !== undefined) ? order.balance : (order.price - (order.amount_paid || 0));

        // Handle multi-product orders
        let productDisplay = '';
        let quantityDisplay = '';
        if (order.products && order.products.length > 0) {
          // Multi-product order
          productDisplay = order.products.map(p => escapeHtml(p.product_name || 'N/A')).join(', ');
          if (order.products.length > 2) {
            productDisplay = order.products.slice(0, 2).map(p => escapeHtml(p.product_name || 'N/A')).join(', ') + ` +${order.products.length - 2} more`;
          }
          const firstProduct = order.products[0];
          if (firstProduct.length && firstProduct.width) {
            productDisplay += `<div class="text-xs text-slate-500">Size: ${firstProduct.length}√ó${firstProduct.width}${firstProduct.dimension_unit || 'cm'}</div>`;
          }
          quantityDisplay = order.products.map(p => `${p.quantity || 0} ${p.quantity_unit || 'pcs'}`).join(', ');
        } else {
          // Legacy single-product order
          productDisplay = escapeHtml(order.product_name || 'N/A');
          if (order.length && order.width) {
            productDisplay += `<div class="text-xs text-slate-500">Size: ${order.length}√ó${order.width}${order.dimension_unit || 'cm'}${order.cutting_length && order.cutting_width ? ` ‚Ä¢ Cut: ${order.cutting_length}√ó${order.cutting_width}${order.cutting_unit || 'cm'}` : ''}</div>`;
          }
          quantityDisplay = `${order.quantity || 0} ${escapeHtml(order.quantity_unit || 'pcs')}`;
        }

        return `
          <tr class="table-row border-b border-slate-100 ${isOverdue ? 'bg-red-50' : isDueSoon ? 'bg-amber-50' : order.settled ? 'opacity-60' : ''}">
            <td class="px-4 py-3 font-medium">${escapeHtml(order.customer_name || '')}</td>
            <td class="px-4 py-3">
              <div>${productDisplay}</div>
            </td>
            <td class="px-4 py-3">${quantityDisplay}</td>
            <td class="px-4 py-3 font-semibold text-slate-700">${currency}${(order.price || 0).toLocaleString()}</td>
            <td class="px-4 py-3 text-green-600">${currency}${(order.amount_paid || 0).toLocaleString()}</td>
            <td class="px-4 py-3">
              <div class="font-semibold ${balance > 0 ? 'text-red-600' : 'text-green-600'}">${currency}${balance.toLocaleString()}</div>
              ${order.promised_payment_date && balance > 0 ? `<div class="text-xs text-orange-600 font-medium">üóìÔ∏è Due: ${formatDate(order.promised_payment_date)}</div>` : ''}
            </td>
            <td class="px-4 py-3 text-slate-600">${formatDate(order.issue_date)}</td>
            <td class="px-4 py-3 ${isOverdue ? 'text-red-600 font-semibold' : isDueSoon ? 'text-amber-600 font-semibold' : 'text-slate-600'}">${formatDate(order.delivery_date) || '-'} ${isOverdue ? '‚ö†Ô∏è' : isDueSoon ? '‚è∞' : ''}</td>
            <td class="px-4 py-3">
              <div class="flex gap-2">
                ${balance > 0 && !order.settled ? `<button onclick="recordPayment('${order.__backendId}')" class="text-purple-600 hover:text-purple-800 transition-colors" title="Record Payment">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
                  </svg>
                </button>` : ''}
                ${!order.settled ? `<button onclick="markOrderSettled('${order.__backendId}')" class="text-green-600 hover:text-green-800 transition-colors" title="Mark as Settled">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                </button>` : `<button onclick="markOrderUnsettled('${order.__backendId}')" class="text-orange-600 hover:text-orange-800 transition-colors" title="Mark as Unsettled">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                </button>`}
                <button onclick="editItem('${order.__backendId}', 'order')" class="text-blue-600 hover:text-blue-800 transition-colors">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                </button>
                <button onclick="deleteItem('${order.__backendId}')" class="text-red-600 hover:text-red-800 transition-colors">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                  </svg>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      // Render pagination
      if (paginationDiv && totalPages > 1) {
        let paginationHTML = `
          <div class="text-sm text-slate-600">
            Showing ${start + 1}-${Math.min(end, orders.length)} of ${orders.length} orders
          </div>
          <div class="flex gap-2">
            <button onclick="changeOrdersPage(${currentOrdersPage - 1})" ${currentOrdersPage === 1 ? 'disabled' : ''} class="px-3 py-1 border border-slate-300 rounded ${currentOrdersPage === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-slate-100'}">Previous</button>
            ${Array.from({ length: totalPages }, (_, i) => i + 1).map(page =>
          `<button onclick="changeOrdersPage(${page})" class="px-3 py-1 border rounded ${page === currentOrdersPage ? 'bg-blue-600 text-white border-blue-600' : 'border-slate-300 hover:bg-slate-100'}">${page}</button>`
        ).join('')}
            <button onclick="changeOrdersPage(${currentOrdersPage + 1})" ${currentOrdersPage === totalPages ? 'disabled' : ''} class="px-3 py-1 border border-slate-300 rounded ${currentOrdersPage === totalPages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-slate-100'}">Next</button>
          </div>
        `;
        paginationDiv.innerHTML = paginationHTML;
      } else if (paginationDiv) {
        paginationDiv.innerHTML = '';
      }

      // Render payment history
      renderPaymentHistory();
    }

    function renderPaymentHistory() {
      const container = document.getElementById('payment-history-container');
      const paginationDiv = document.getElementById('payments-pagination');
      if (!container) return;

      const currency = getCurrency();
      let orders = getFilteredData(getOrders(), 'PAYMENT-HISTORY');

      // Apply search filter
      const searchTerm = document.getElementById('payments-search')?.value.toLowerCase() || '';

      // Group orders by customer
      const byCustomer = {};
      orders.forEach(order => {
        const customer = order.customer_name || 'Unknown';
        if (!searchTerm || customer.toLowerCase().includes(searchTerm)) {
          if (!byCustomer[customer]) {
            byCustomer[customer] = [];
          }
          byCustomer[customer].push(order);
        }
      });

      if (Object.keys(byCustomer).length === 0) {
        container.innerHTML = '<div class="text-center py-8 text-slate-500">No payment records found</div>';
        if (paginationDiv) paginationDiv.innerHTML = '';
        return;
      }

      const customers = Object.entries(byCustomer);
      const totalPages = Math.ceil(customers.length / paymentsPerPage);
      const start = (currentPaymentsPage - 1) * paymentsPerPage;
      const end = start + paymentsPerPage;
      const paginatedCustomers = customers.slice(start, end);

      container.innerHTML = paginatedCustomers.map(([customer, customerOrders]) => {
        // Calculate totals for this customer
        const totalOrders = customerOrders.length;
        const totalAmount = customerOrders.reduce((sum, o) => sum + (o.price || 0), 0);
        const totalPaid = customerOrders.reduce((sum, o) => sum + (o.amount_paid || 0), 0);
        const totalBalance = totalAmount - totalPaid;

        // Check if all orders are settled
        const allSettled = customerOrders.every(o => o.settled);

        // Get payment transactions from all orders
        const allPayments = [];
        customerOrders.forEach(order => {
          if (order.payment_history && Array.isArray(order.payment_history)) {
            order.payment_history.forEach(payment => {
              allPayments.push({
                ...payment,
                orderId: order.__backendId,
                orderProduct: order.product_name,
                orderDate: order.issue_date,
                orderSettled: order.settled
              });
            });
          } else if (order.amount_paid > 0) {
            // Legacy: single payment
            allPayments.push({
              amount: order.amount_paid,
              date: order.issue_date,
              note: 'Initial payment',
              orderId: order.__backendId,
              orderProduct: order.product_name,
              orderDate: order.issue_date,
              orderSettled: order.settled
            });
          }
        });

        // Sort payments by date (newest first)
        allPayments.sort((a, b) => new Date(b.date) - new Date(a.date));

        const customerId = customer.replace(/[^a-zA-Z0-9]/g, '_');

        // MOBILE-FIRST CARD LAYOUT
        return `
        <div class="bg-white border border-slate-200 rounded-2xl shadow-sm mb-4 px-0 pt-0 pb-2 ${allSettled ? 'opacity-60' : ''}">
          <div class="flex flex-col gap-2 p-4 pb-2">
            <div class="flex items-center gap-3 mb-1 cursor-pointer select-none" onclick="togglePaymentHistory('${customerId}')">
              <div class="w-11 h-11 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-xl">
                ${escapeHtml(customer).charAt(0).toUpperCase()}
              </div>
              <div class="flex-1 min-w-0">
                <div class="font-semibold text-base truncate">${escapeHtml(customer)} ${allSettled ? '<span class=\"text-xs text-green-600 font-normal\">‚úì Settled</span>' : ''}</div>
                <div class="text-xs text-slate-500 mt-0.5">${totalOrders} ${totalOrders === 1 ? 'order' : 'orders'} ‚Ä¢ ${allPayments.length} ${allPayments.length === 1 ? 'payment' : 'payments'}</div>
              </div>
              <button onclick="shareReceipt('${customer.replace(/'/g, "\\'")}'); event.stopPropagation();" class="ml-2 p-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors" title="Share Receipt">
                <svg class="w-5 h-5 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                </svg>
              </button>
              <svg id="chevron-${customerId}" class="w-5 h-5 text-slate-400 transform transition-transform ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
              </svg>
            </div>
            <div class="flex flex-col gap-1 mt-1">
              <div class="flex items-center justify-between">
                <span class="text-xs text-slate-500">Total Paid</span>
                <span class="text-base font-bold text-green-600">${currency}${totalPaid.toLocaleString()}</span>
              </div>
              <div class="flex items-center justify-between">
                <span class="text-xs text-slate-500">Balance</span>
                <span class="text-base font-bold ${totalBalance > 0 ? 'text-red-600' : 'text-green-600'}">${currency}${totalBalance.toLocaleString()}</span>
              </div>
            </div>
          </div>
          <div id="payments-${customerId}" class="hidden" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out;">
            <div class="p-3 pt-0 bg-slate-50 border-t border-slate-200">
              <!-- Orders Section -->
              <div class="mb-3">
                <h4 class="font-semibold text-slate-700 mb-2 text-sm">Orders</h4>
                <div class="flex flex-col gap-2">
                  ${customerOrders.map((order, idx) => `
                    <div class="bg-white border border-slate-200 rounded-xl p-3 ${order.settled ? 'opacity-60' : ''} flex flex-col gap-1">
                      <div class="font-semibold text-slate-800 text-sm">${escapeHtml(order.product_name || 'N/A')}</div>
                      <div class="text-xs text-slate-500">
                        üìÖ ${formatDate(order.issue_date)}
                        ${order.delivery_date ? `‚Ä¢ üöö ${formatDate(order.delivery_date)}` : ''}
                        ‚Ä¢ üì¶ Qty: ${order.quantity || 0} ${order.length && order.width ? `(${order.length}√ó${order.width}${order.dimension_unit || 'cm'})` : ''}
                        ${order.cutting_length && order.cutting_width ? `‚Ä¢ ‚úÇÔ∏è ${order.cutting_length}√ó${order.cutting_width}${order.cutting_unit || 'cm'}` : ''}
                      </div>
                      <div class="flex flex-col gap-0.5 mt-1 text-xs">
                        <span class="text-slate-600">Amount: ${currency}${(order.price || 0).toLocaleString()}</span>
                        <span class="text-green-600">Paid: ${currency}${(order.amount_paid || 0).toLocaleString()}</span>
                        ${order.balance > 0 ? `<span class="text-red-600">Balance: ${currency}${(order.balance || 0).toLocaleString()}</span>` : '<span class="text-green-600 font-semibold">‚úì Settled</span>'}
                      </div>
                      ${order.promised_payment_date && order.balance > 0 ? `<div class="text-xs text-orange-600 font-semibold mt-1">üóìÔ∏è To collect by: ${formatDate(order.promised_payment_date)}</div>` : ''}
                    </div>
                  `).join('')}
                </div>
              </div>
              <!-- Payment Transactions Section -->
              <h4 class="font-semibold text-slate-700 mb-2 text-sm">Payment Transactions</h4>
              ${allPayments.length > 0 ? `
                <div class="flex flex-col gap-2">
                  ${allPayments.map((payment, index) => {
                    const order = customerOrders.find(o => o.__backendId === payment.orderId);
                    const isSettled = order?.settled || false;
                    return `
                      <div class="bg-white border border-slate-200 rounded-xl p-3 flex flex-col gap-1 ${isSettled ? 'opacity-60' : ''}">
                        <div class="flex items-center gap-2">
                          <div class="w-8 h-8 bg-green-100 text-green-600 rounded-full flex items-center justify-center font-bold text-sm">
                            ${index + 1}
                          </div>
                          <div class="flex-1 min-w-0">
                            <div class="font-semibold text-green-600 text-sm truncate">${currency}${(payment.amount || 0).toLocaleString()}</div>
                            <div class="text-xs text-slate-500">
                              ${formatDate(payment.date)}${payment.time ? ' at ' + payment.time : ''}
                              ${payment.mode ? ` ‚Ä¢ ${payment.mode === 'cash' ? 'üíµ Cash' : payment.mode === 'phonepay' ? 'üì± PhonePe' : payment.mode === 'gpay' ? 'üí≥ Google Pay' : payment.mode === 'paytm' ? 'üí∞ Paytm' : 'üè¶ Bank'}` : ''}
                              ${payment.note ? ' ‚Ä¢ ' + escapeHtml(payment.note) : ''}
                            </div>
                            ${payment.orderProduct ? `<div class="text-xs text-slate-400">Order: ${escapeHtml(payment.orderProduct)} ${isSettled ? '‚úì Settled' : ''}</div>` : ''}
                            ${payment.proof ? `<button onclick=\"showPaymentProof('${payment.proof}')\" class=\"text-xs text-blue-600 hover:text-blue-800 mt-1\">üìé View Proof</button>` : ''}
                          </div>
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
              ` : '<div class="text-center text-slate-500 py-4">No payments recorded</div>'}
              <div class="mt-4 pt-4 border-t border-slate-300 flex flex-col gap-2">
                <div class="flex items-center justify-between">
                  <div class="text-xs text-blue-600">Total Amount</div>
                  <div class="text-base font-bold text-blue-700">${currency}${totalAmount.toLocaleString()}</div>
                </div>
                <div class="flex items-center justify-between">
                  <div class="text-xs text-green-600">Total Paid</div>
                  <div class="text-base font-bold text-green-700">${currency}${totalPaid.toLocaleString()}</div>
                </div>
                <div class="flex items-center justify-between">
                  <div class="text-xs ${totalBalance > 0 ? 'text-red-600' : 'text-green-600'}">${totalBalance > 0 ? 'Balance Due' : 'Settled'}</div>
                  <div class="text-base font-bold ${totalBalance > 0 ? 'text-red-700' : 'text-green-700'}">${currency}${Math.abs(totalBalance).toLocaleString()}</div>
                </div>
              </div>
            </div>
          </div>
        </div>
        `;
      }).join('');

      // Render pagination
      if (paginationDiv && totalPages > 1) {
        let paginationHTML = `
          <div class="text-sm text-slate-600">
            Showing ${start + 1}-${Math.min(end, customers.length)} of ${customers.length} customers
          </div>
          <div class="flex gap-2">
            <button onclick="changePaymentsPage(${currentPaymentsPage - 1})" ${currentPaymentsPage === 1 ? 'disabled' : ''} class="px-3 py-1 border border-slate-300 rounded ${currentPaymentsPage === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-slate-100'}">Previous</button>
            ${Array.from({ length: totalPages }, (_, i) => i + 1).map(page =>
          `<button onclick="changePaymentsPage(${page})" class="px-3 py-1 border rounded ${page === currentPaymentsPage ? 'bg-blue-600 text-white border-blue-600' : 'border-slate-300 hover:bg-slate-100'}">${page}</button>`
        ).join('')}
            <button onclick="changePaymentsPage(${currentPaymentsPage + 1})" ${currentPaymentsPage === totalPages ? 'disabled' : ''} class="px-3 py-1 border border-slate-300 rounded ${currentPaymentsPage === totalPages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-slate-100'}">Next</button>
          </div>
        `;
        paginationDiv.innerHTML = paginationHTML;
      } else if (paginationDiv) {
        paginationDiv.innerHTML = '';
      }
    }

    function changeOrdersPage(page) {
      if (page < 1 || page > Math.ceil(filteredOrders.length / ordersPerPage)) return;
      currentOrdersPage = page;
      renderOrders();
    }

    function changePaymentsPage(page) {
      const totalCustomers = Object.keys(document.querySelectorAll('[id^="payments-"]')).length;
      if (page < 1) return;
      currentPaymentsPage = page;
      renderPaymentHistory();
    }

    function togglePaymentHistory(customerId) {
      const paymentsDiv = document.getElementById(`payments-${customerId}`);
      const chevron = document.getElementById(`chevron-${customerId}`);

      if (paymentsDiv.classList.contains('hidden')) {
        // Expand
        paymentsDiv.classList.remove('hidden');
        paymentsDiv.style.maxHeight = paymentsDiv.scrollHeight + 'px';
        chevron.style.transform = 'rotate(180deg)';
      } else {
        // Collapse
        paymentsDiv.style.maxHeight = '0';
        setTimeout(() => {
          paymentsDiv.classList.add('hidden');
        }, 300);
        chevron.style.transform = 'rotate(0deg)';
      }
    }

    function showPaymentProof(proofData) {
      if (!proofData) return;

      // Create modal to show image
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4';
      modal.onclick = () => modal.remove();

      modal.innerHTML = `
        <div class="relative max-w-4xl max-h-screen">
          <button class="absolute -top-10 right-0 text-white text-3xl hover:text-gray-300">&times;</button>
          <img src="${proofData}" class="max-w-full max-h-screen rounded-lg shadow-2xl" alt="Payment Proof">
        </div>
      `;

      document.body.appendChild(modal);
    }

    async function shareReceipt(customerName) {
      const currency = getCurrency();
      const orders = getOrders();
      const customerOrders = orders.filter(o => o.customer_name === customerName);

      if (customerOrders.length === 0) {
        showToast('No orders found for this customer', 'error');
        return;
      }

      // If only one order, just show the receipt modal for that order
      if (customerOrders.length === 1) {
        showOrderReceipt(customerOrders[0].__backendId);
        return;
      }

      // For multiple orders, show the first unsettled order or the most recent one
      const unsettledOrder = customerOrders.find(o => !o.settled);
      const orderToShow = unsettledOrder || customerOrders[customerOrders.length - 1];
      showOrderReceipt(orderToShow.__backendId);
    }

    // Order Receipt Functions
    let currentReceiptOrderId = null;

    function showOrderReceipt(orderId) {
      currentReceiptOrderId = orderId;
      const order = allData.find(d => d.__backendId === orderId);
      if (!order) return;

      const currency = getCurrency();
      const balance = (order.balance !== undefined) ? order.balance : (order.price - (order.amount_paid || 0));
      const now = new Date();
      const paymentHistory = order.payment_history || [];

      // Generate receipt HTML
      const receiptHTML = `
        <div class="relative z-10" style="max-width: 100%; overflow: hidden;">
          <!-- Header with Logo and Brand -->
          <div class="flex items-start justify-between mb-6 pb-4 border-b-2 border-slate-300" style="flex-wrap: wrap; gap: 1rem;">
            <div class="flex items-center gap-4" style="min-width: 0; flex: 1;">
              <img src="logo.jpg" alt="Shri Mata Logo" class="object-contain" style="width: 60px; height: 60px; max-width: 60px; flex-shrink: 0;" onerror="this.style.display='none'">
              <div style="min-width: 0;">
                <h1 class="text-3xl font-bold text-slate-800" style="font-size: 1.5rem; line-height: 1.2;">SHRI MATA</h1>
                <p class="text-sm text-green-600 font-medium" style="font-size: 0.875rem;">Eco-Friendly Bliss</p>
              </div>
            </div>
            <div class="text-right text-sm text-slate-600" style="font-size: 0.875rem;">
              <div class="font-semibold">Contact: +918328501239</div>
            </div>
          </div>
          
          <!-- Title -->
          <h2 class="text-2xl font-bold text-center text-slate-800 mb-6 uppercase tracking-wide" style="font-size: 1.5rem;">Order Receipt</h2>
          
          <!-- Customer Details -->
          <div class="mb-6 bg-slate-50 bg-opacity-50 rounded-lg p-4">
            <div class="grid grid-cols-2 gap-y-2 text-sm">
              <div class="text-slate-600">Customer:</div>
              <div class="font-semibold text-slate-800">${escapeHtml(order.customer_name || 'N/A')}</div>
              
              <div class="text-slate-600">Order Date:</div>
              <div class="font-semibold text-slate-800">${formatDate(order.issue_date) || 'N/A'}</div>
              
              <div class="text-slate-600">Delivery Date:</div>
              <div class="font-semibold text-slate-800">${formatDate(order.delivery_date) || 'N/A'}</div>
            </div>
          </div>
          
          <!-- Items Section -->
          <div class="mb-6">
            <h3 class="font-bold text-slate-700 mb-3 pb-2 border-b border-slate-300">Items</h3>
            ${order.products && order.products.length > 0 ? `
              <div class="space-y-3">
                ${order.products.map((prod, idx) => `
                  <div class="bg-white bg-opacity-50 border border-slate-200 rounded-lg p-4">
                    <div class="flex justify-between items-start mb-2">
                      <div class="flex-1">
                        <div class="font-semibold text-slate-800">${idx + 1}. ${escapeHtml(prod.product_name || 'N/A')}</div>
                        ${prod.length && prod.width ? `<div class="text-sm text-slate-600">Size: ${prod.length}√ó${prod.width}${prod.dimension_unit || 'cm'}</div>` : ''}
                        ${prod.cutting_length && prod.cutting_width ? `<div class="text-sm text-slate-600">Cut: ${prod.cutting_length}√ó${prod.cutting_width}${prod.cutting_unit || 'cm'}</div>` : ''}
                        ${prod.quantity ? `<div class="text-sm text-slate-600">Quantity: ${prod.quantity} ${prod.quantity_unit || 'pcs'}</div>` : ''}
                        ${prod.unit_price ? `<div class="text-sm text-slate-600">Unit Price: ${currency}${prod.unit_price}</div>` : ''}
                      </div>
                      <div class="text-right font-semibold text-slate-800">${currency}${(prod.price || 0).toLocaleString()}</div>
                    </div>
                  </div>
                `).join('')}
                ${order.design_charge > 0 ? `
                  <div class="bg-purple-50 bg-opacity-50 border border-purple-200 rounded-lg p-3">
                    <div class="flex justify-between items-center">
                      <div class="font-semibold text-purple-800">üí∞ Design Charges (One-time)</div>
                      <div class="text-right font-semibold text-purple-800">${currency}${order.design_charge.toLocaleString()}</div>
                    </div>
                  </div>
                ` : ''}
              </div>
            ` : `
              <div class="bg-white bg-opacity-50 border border-slate-200 rounded-lg p-4">
                <div class="flex justify-between items-start mb-2">
                  <div class="flex-1">
                    <div class="font-semibold text-slate-800">${escapeHtml(order.product_name || 'N/A')}</div>
                    ${order.length && order.width ? `<div class="text-sm text-slate-600">(${order.length}√ó${order.width}${order.dimension_unit || 'cm'})</div>` : ''}
                    ${order.quantity ? `<div class="text-sm text-slate-600">Quantity: ${order.quantity}</div>` : ''}
                  </div>
                  <div class="text-right font-semibold text-slate-800">${currency}${(order.price || 0).toLocaleString()}</div>
                </div>
              </div>
            `}
          </div>
          
          <!-- Payment History Section -->
          ${paymentHistory.length > 0 ? `
            <div class="mb-6">
              <h3 class="font-bold text-slate-700 mb-3 pb-2 border-b border-slate-300">Payment History</h3>
              <div class="space-y-2">
                ${paymentHistory.map((payment, idx) => `
                  <div class="bg-green-50 bg-opacity-50 border border-green-200 rounded-lg p-3 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                      <div class="w-8 h-8 bg-green-600 text-white rounded-full flex items-center justify-center font-bold text-sm">
                        ${idx + 1}
                      </div>
                      <div>
                        <div class="font-semibold text-green-700">${currency}${(payment.amount || 0).toLocaleString()}</div>
                        <div class="text-xs text-slate-600">
                          ${formatDate(payment.date)}${payment.time ? ' at ' + payment.time : ''}
                          ${payment.mode ? ` ‚Ä¢ ${payment.mode === 'cash' ? 'üíµ Cash' : payment.mode === 'phonepay' ? 'üì± PhonePe' : payment.mode === 'gpay' ? 'üí≥ GPay' : payment.mode === 'paytm' ? 'üí∞ Paytm' : 'üè¶ Bank'}` : ''}
                          ${payment.note ? ' ‚Ä¢ ' + escapeHtml(payment.note) : ''}
                        </div>
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}
          
          <!-- Summary Section -->
          <div class="mb-6 bg-slate-100 bg-opacity-50 rounded-lg p-4">
            <h3 class="font-bold text-slate-700 mb-3">Summary</h3>
            <div class="space-y-2">
              <div class="flex justify-between text-slate-700">
                <span>Total Price:</span>
                <span class="font-bold">${currency}${(order.price || 0).toLocaleString()}</span>
              </div>
              <div class="flex justify-between text-green-600">
                <span>Amount paid:</span>
                <span class="font-bold">${currency}${(order.amount_paid || 0).toLocaleString()}</span>
              </div>
              <div class="h-px bg-slate-300 my-2"></div>
              <div class="flex justify-between text-lg ${balance > 0 ? 'text-red-600' : 'text-green-600'}">
                <span class="font-bold">Remaining:</span>
                <span class="font-bold">${currency}${balance.toLocaleString()}</span>
              </div>
              ${order.promised_payment_date && balance > 0 ? `
                <div class="mt-3 p-3 bg-orange-50 border-2 border-orange-300 rounded-lg">
                  <div class="text-orange-800 font-bold text-center">
                    üóìÔ∏è To be collected by: ${formatDate(order.promised_payment_date)}
                  </div>
                </div>
              ` : ''}
            </div>
          </div>
          
          <!-- Footer -->
          <div class="text-center py-4 border-t-2 border-slate-300">
            <p class="text-sm text-slate-600 mb-3">
              For any other queries please contact<br>
              <span class="font-semibold text-slate-800">Shri Mata +918328501239</span>
            </p>
            <div class="text-xs text-slate-500">
              Generated on: ${now.toLocaleDateString()} at ${now.toLocaleTimeString()}
            </div>
          </div>
        </div>
      `;

      document.getElementById('receipt-content').innerHTML = receiptHTML;
      document.getElementById('receipt-modal').classList.remove('hidden');
    }

    function closeReceiptModal() {
      document.getElementById('receipt-modal').classList.add('hidden');
    }

    function printReceipt() {
      window.print();
    }

    async function shareReceiptContent() {
      if (!currentReceiptOrderId) return;

      const order = allData.find(d => d.__backendId === currentReceiptOrderId);
      if (!order) return;

      // Check if html2canvas is available
      if (typeof html2canvas === 'undefined') {
        showToast('Image library not loaded. Please refresh the page.', 'error');
        return;
      }

      const receiptContent = document.getElementById('receipt-content');
      if (!receiptContent) return;

      showToast('Generating image...', 'info');

      try {
        // Temporarily hide the watermark to avoid CORS issues
        const style = document.createElement('style');
        style.id = 'temp-hide-watermark';
        style.textContent = '#receipt-content::before { display: none !important; }';
        document.head.appendChild(style);

        // Find and temporarily hide the logo image
        const logoImg = receiptContent.querySelector('img[alt="Shri Mata Logo"]');
        const originalDisplay = logoImg ? logoImg.style.display : null;
        if (logoImg) logoImg.style.display = 'none';

        // Wait a moment
        await new Promise(resolve => setTimeout(resolve, 100));

        // Capture the receipt as canvas
        const canvas = await html2canvas(receiptContent, {
          backgroundColor: '#ffffff',
          scale: 2,
          logging: false,
          allowTaint: true,
          useCORS: false
        });

        // Restore the logo and watermark
        if (logoImg && originalDisplay !== null) logoImg.style.display = originalDisplay;
        const tempStyle = document.getElementById('temp-hide-watermark');
        if (tempStyle) tempStyle.remove();

        // Convert canvas to base64 PNG and Blob
        const pngData = canvas.toDataURL('image/png');
        const fileName = `receipt-${order.customer_name || 'order'}.png`;

        // Try to use Web Share API for image sharing (mobile)
        let shared = false;
        if (navigator.canShare && window.File && typeof navigator.share === 'function') {
          try {
            // Convert base64 to Blob
            const res = await fetch(pngData);
            const blob = await res.blob();
            const file = new File([blob], fileName, { type: 'image/png' });
            if (navigator.canShare({ files: [file] })) {
              await navigator.share({
                title: `Receipt - ${order.customer_name}`,
                text: 'Order receipt from Shri Mata',
                files: [file]
              });
              showToast('Receipt shared!', 'success');
              shared = true;
              return;
            }
          } catch (error) {
            if (error.name !== 'AbortError') {
              showToast('Failed to share via app. Uploading to server...', 'warning');
            } else {
              return;
            }
          }
        }
        if (!shared && /Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
          // Fallback: copy receipt text to clipboard
          let receiptText = '';
          receiptText += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
          receiptText += `   SHRI MATA\n`;
          receiptText += `   Eco-Friendly Bliss\n`;
          receiptText += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
          receiptText += `   ORDER RECEIPT\n`;
          receiptText += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
          receiptText += `Customer: ${order.customer_name || 'N/A'}\n`;
          receiptText += `Order Date: ${formatDate(order.issue_date) || 'N/A'}\n`;
          receiptText += `Delivery Date: ${formatDate(order.delivery_date) || 'N/A'}\n`;
          receiptText += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
          receiptText += `ITEMS\n`;
          receiptText += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
          receiptText += `Product: ${order.product_name || 'N/A'}\n`;
          if (order.length && order.width) {
            receiptText += `Size: ${order.length}√ó${order.width}${order.dimension_unit || 'cm'}\n`;
          }
          if (order.quantity) {
            receiptText += `Quantity: ${order.quantity}\n`;
          }
          receiptText += `Price: ${getCurrency()}${(order.price || 0).toLocaleString()}\n`;
          if (order.payment_history && order.payment_history.length > 0) {
            receiptText += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            receiptText += `PAYMENT HISTORY\n`;
            receiptText += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            order.payment_history.forEach((payment, idx) => {
              receiptText += `${idx + 1}. ${getCurrency()}${(payment.amount || 0).toLocaleString()}`;
              receiptText += ` - ${formatDate(payment.date)}`;
              if (payment.time) receiptText += ` at ${payment.time}`;
              if (payment.mode) {
                const modes = { cash: 'üíµ Cash', phonepay: 'üì± PhonePe', gpay: 'üí≥ GPay', paytm: 'üí∞ Paytm' };
                receiptText += ` (${modes[payment.mode] || 'üè¶ Bank'})`;
              }
              if (payment.note) receiptText += ` - ${payment.note}`;
              receiptText += `\n`;
            });
          }
          receiptText += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
          receiptText += `SUMMARY\n`;
          receiptText += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
          receiptText += `Total Price: ${getCurrency()}${(order.price || 0).toLocaleString()}\n`;
          receiptText += `Amount Paid: ${getCurrency()}${(order.amount_paid || 0).toLocaleString()}\n`;
          const balance = (order.balance !== undefined) ? order.balance : (order.price - (order.amount_paid || 0));
          receiptText += `Remaining: ${getCurrency()}${balance.toLocaleString()}\n`;
          if (order.promised_payment_date && balance > 0) {
            receiptText += `\nüóìÔ∏è To be collected by: ${formatDate(order.promised_payment_date)}\n`;
          }
          receiptText += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
          receiptText += `For queries contact:\n`;
          receiptText += `Shri Mata +918328501239\n`;
          receiptText += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
          copyToClipboard(receiptText);
          showToast('Sharing to WhatsApp or other apps is not supported on this device/browser. Receipt text copied to clipboard. You can paste it in WhatsApp or any app.', 'info');
        }
        // Fallback: upload to server as before
        try {
          const result = await api.createShareReceipt({ pngData, fileName });
          if (result.success) {
            showToast('Receipt shared to server!', 'success');
          } else {
            showToast('Failed to share receipt: ' + (result.message || 'Unknown error'), 'error');
          }
        } catch (error) {
          console.error('API error:', error);
          showToast('Failed to share receipt. Error: ' + error.message, 'error');
        }
      } catch (error) {
        console.error('Error capturing or sharing receipt:', error);
        showToast('Failed to share receipt. Error: ' + error.message, 'error');
      }
    }

    function downloadImage(canvas, filename) {
      const link = document.createElement('a');
      link.download = filename;
      link.href = canvas.toDataURL('image/png');
      link.click();
      showToast('Receipt image downloaded!', 'success');
    }

    async function shareReceiptAsText() {
      if (!currentReceiptOrderId) return;

      const order = allData.find(d => d.__backendId === currentReceiptOrderId);
      if (!order) return;

      const currency = getCurrency();
      const balance = (order.balance !== undefined) ? order.balance : (order.price - (order.amount_paid || 0));
      const paymentHistory = order.payment_history || [];

      // Generate shareable text receipt
      let receipt = `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
      receipt += `   SHRI MATA\n`;
      receipt += `   Eco-Friendly Bliss\n`;
      receipt += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
      receipt += `   ORDER RECEIPT\n`;
      receipt += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;

      receipt += `Customer: ${order.customer_name || 'N/A'}\n`;
      receipt += `Order Date: ${formatDate(order.issue_date) || 'N/A'}\n`;
      receipt += `Delivery Date: ${formatDate(order.delivery_date) || 'N/A'}\n`;
      receipt += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
      receipt += `ITEMS\n`;
      receipt += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
      receipt += `Product: ${order.product_name || 'N/A'}\n`;

      if (order.length && order.width) {
        receipt += `Size: ${order.length}√ó${order.width}${order.dimension_unit || 'cm'}\n`;
      }
      if (order.quantity) {
        receipt += `Quantity: ${order.quantity}\n`;
      }
      receipt += `Price: ${currency}${(order.price || 0).toLocaleString()}\n`;

      if (paymentHistory.length > 0) {
        receipt += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
        receipt += `PAYMENT HISTORY\n`;
        receipt += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
        paymentHistory.forEach((payment, idx) => {
          receipt += `${idx + 1}. ${currency}${(payment.amount || 0).toLocaleString()}`;
          receipt += ` - ${formatDate(payment.date)}`;
          if (payment.time) receipt += ` at ${payment.time}`;
          if (payment.mode) {
            const modes = { cash: 'üíµ Cash', phonepay: 'üì± PhonePe', gpay: 'üí≥ GPay', paytm: 'üí∞ Paytm' };
            receipt += ` (${modes[payment.mode] || 'üè¶ Bank'})`;
          }
          if (payment.note) receipt += ` - ${payment.note}`;
          receipt += `\n`;
        });
      }

      receipt += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
      receipt += `SUMMARY\n`;
      receipt += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
      receipt += `Total Price: ${currency}${(order.price || 0).toLocaleString()}\n`;
      receipt += `Amount Paid: ${currency}${(order.amount_paid || 0).toLocaleString()}\n`;
      receipt += `Remaining: ${currency}${balance.toLocaleString()}\n`;

      if (order.promised_payment_date && balance > 0) {
        receipt += `\nüóìÔ∏è To be collected by: ${formatDate(order.promised_payment_date)}\n`;
      }

      receipt += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
      receipt += `For queries contact:\n`;
      receipt += `Shri Mata +918328501239\n`;
      receipt += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;

      // Try to share using Web Share API
      if (navigator.share) {
        try {
          await navigator.share({
            title: `Receipt - ${order.customer_name}`,
            text: receipt
          });
        } catch (error) {
          if (error.name !== 'AbortError') {
            copyToClipboard(receipt);
          }
        }
      } else {
        copyToClipboard(receipt);
      }
    }

    function copyToClipboard(text) {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
          showToast('Receipt copied to clipboard!', 'success');
        }).catch(() => {
          showToast('Failed to copy receipt', 'error');
        });
      } else {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        document.body.appendChild(textArea);
        textArea.select();
        try {
          document.execCommand('copy');
          showToast('Receipt copied to clipboard!', 'success');
        } catch (err) {
          showToast('Failed to copy receipt', 'error');
        }
        document.body.removeChild(textArea);
      }
    }

    function renderPendingOrdersCard() {
      const orders = getOrders().filter(o => !o.settled && o.delivery_date);
      const card = document.getElementById('pending-orders-card');
      const container = document.getElementById('pending-orders-list');
      const currency = getCurrency();
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // Filter orders due within next 7 days
      const upcomingOrders = orders.filter(o => {
        const deliveryDate = new Date(o.delivery_date);
        const daysUntil = Math.ceil((deliveryDate - today) / (1000 * 60 * 60 * 24));
        return daysUntil >= -1 && daysUntil <= 7;
      }).sort((a, b) => new Date(a.delivery_date) - new Date(b.delivery_date));

      if (upcomingOrders.length === 0) {
        card.style.display = 'none';
        return;
      }

      card.style.display = 'block';
      container.innerHTML = upcomingOrders.map(order => {
        const deliveryDate = new Date(order.delivery_date);
        const daysUntil = Math.ceil((deliveryDate - today) / (1000 * 60 * 60 * 24));
        const isOverdue = daysUntil < 0;
        const isToday = daysUntil === 0;

        return `
          <div class="flex items-center justify-between p-3 rounded-lg border ${isOverdue ? 'bg-red-50 border-red-300' : isToday ? 'bg-amber-50 border-amber-300' : 'bg-blue-50 border-blue-300'}">
            <div class="flex-1">
              <div class="font-medium ${isOverdue ? 'text-red-700' : isToday ? 'text-amber-700' : 'text-blue-700'}">
                ${escapeHtml(order.customer_name || 'Unknown')} - ${escapeHtml(order.product_name || '')}
              </div>
              <div class="text-sm text-slate-600">${order.quantity || 0} items ‚Ä¢ ${formatDate(order.delivery_date)} ${isOverdue ? '‚ö†Ô∏è Overdue' : isToday ? 'üìå Today' : daysUntil === 1 ? '‚è∞ Tomorrow' : `(in ${daysUntil} days)`}</div>
            </div>
            <div class="text-right">
              <div class="font-bold text-slate-800">${currency}${(order.price || 0).toLocaleString()}</div>
              <button onclick="switchTab('orders')" class="text-xs text-blue-600 hover:underline">View</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Production daily view helpers
    function changeProductionViewMode(mode) {
      productionDailyViewMode = mode;
      productionDailyPage = 1;
      renderProduction();
    }

    function changeProductionPage(direction) {
      if (direction === 'prev' && productionDailyPage > 1) {
        productionDailyPage--;
        renderProduction();
      } else if (direction === 'next') {
        // Will increment, renderProduction will handle bounds
        productionDailyPage++;
        renderProduction();
      }
    }

    // --- Helper: Get today's production edit count for current user ---
    function getTodayProductionEditCount() {
      const user = api.user;
      const today = new Date().toISOString().split('T')[0];
      let count = 0;
      if (allData && user && user.username) {
        count = allData.filter(d => d.type === 'worker' && d.date === today && d.lastEditedBy === user.username).length;
      }
      return count;

      // Helper: Should hide all company data for user?
      function shouldHideCompanyData() {
        const user = api.user;
        // Only restrict non-admin users
        if (!user || user.role === 'admin') return false;
        return getTodayProductionEditCount() >= 1;
      }
    }

    // --- Helper: Should lock/blur production for user? ---
    function shouldLockProductionUI() {
      const user = api.user;
      if (!user || user.role !== 'user') return false;
      return getTodayProductionEditCount() >= 2;
    }

    function renderProduction() {
            // Blur daily production records and production summary for user logins
            const user = api.user;
            // Ensure blur is applied after DOM updates
            setTimeout(() => {
              const summaryCard = document.getElementById('production-summary-card');
              const detailsCard = document.getElementById('production-details-card');
              if (user && user.role === 'user') {
                if (summaryCard) {
                  summaryCard.style.filter = 'blur(6px)';
                  summaryCard.style.pointerEvents = 'none';
                  summaryCard.innerHTML = '<div class="text-center text-slate-400 py-8 text-lg font-semibold">üîí Production summary is hidden for users</div>';
                }
                if (detailsCard) {
                  detailsCard.style.filter = 'blur(6px)';
                  detailsCard.style.pointerEvents = 'none';
                  detailsCard.innerHTML = '<div class="text-center text-slate-400 py-8 text-lg font-semibold">üîí Production records are hidden for users</div>';
                }
              } else if (user && user.role === 'admin') {
                if (summaryCard) {
                  summaryCard.style.filter = '';
                  summaryCard.style.pointerEvents = '';
                }
                if (detailsCard) {
                  detailsCard.style.filter = '';
                  detailsCard.style.pointerEvents = '';
                }
              }
            }, 300);
      const currency = getCurrency();
      const allWorkers = getWorkers();
      // Exclude placeholder records (empty production entries)
      const workersWithProduction = allWorkers.filter(w => !w.is_placeholder && (w.units_produced > 0 || w.hours_worked > 0));
      const workers = getFilteredData(workersWithProduction, 'PRODUCTION');
      const oldProduction = getFilteredData(getProduction(), 'OLD PRODUCTION');
      const products = getProducts();
      const orders = getOrders().filter(o => !o.settled);
      const investments = getFilteredData(getInvestments());
      // Get both sets of containers (Production tab and Workers tab)
      const overviewContainer = document.getElementById('production-monthly-overview');
      const detailsContainer = document.getElementById('production-details-container');
      const workersOverviewContainer = document.getElementById('workers-production-monthly-overview');
      const workersDetailsContainer = document.getElementById('workers-production-details-container');

      console.log('renderProduction called', {
        totalWorkers: allWorkers.length,
        workersWithProduction: workersWithProduction.length,
        filteredWorkers: workers.length,
        oldProductionCount: oldProduction.length,
        selectedMonth: selectedMonth,
        hasContainers: !!overviewContainer && !!detailsContainer
      });

      // If containers don't exist yet, skip rendering (will be called again when tab is switched)
      if ((!overviewContainer || !detailsContainer) && (!workersOverviewContainer || !workersDetailsContainer)) {
        console.log('Production containers not found, skipping render');
        return;
      }

      // Hide all company data for user after one add
      if (typeof shouldHideCompanyData === 'function' && shouldHideCompanyData()) {
        const lockedMessage = `<div class=\"fixed inset-0 z-50 flex items-center justify-center modal-backdrop\" style=\"backdrop-filter: blur(8px); background: rgba(255,255,255,0.95);\">\n  <div class=\"bg-white rounded-xl shadow-2xl p-8 text-center\">\n    <h2 class=\"text-2xl font-bold text-red-600 mb-4\">üîí Company Data Locked</h2>\n    <p class=\"text-lg text-slate-700 mb-2\">You have already added production for today.</p>\n    <p class=\"text-md text-slate-500\">You cannot view, edit, or delete any company data until tomorrow.</p>\n  </div>\n</div>`;
        if (overviewContainer) overviewContainer.innerHTML = lockedMessage;
        if (detailsContainer) detailsContainer.innerHTML = '';
        if (workersOverviewContainer) workersOverviewContainer.innerHTML = lockedMessage;
        if (workersDetailsContainer) workersDetailsContainer.innerHTML = '';
        return;
      }

      // Aggregate by product from workers
      const byProduct = {};
      let totalUnits = 0;
      let totalHours = 0;
      const uniqueWorkers = new Set();

      workers.forEach(w => {
        const product = w.product_name || 'Unspecified';
        if (!product || product.trim() === '') {
          console.warn('Worker record without product name:', w);
          return; // Skip records without product name
        }
        if (!byProduct[product]) {
          byProduct[product] = {
            totalUnits: 0,
            totalHours: 0,
            totalRawCost: 0,
            workers: new Set(),
            dailyRecords: []
          };
        }
        byProduct[product].totalUnits += w.units_produced || 0;
        byProduct[product].totalHours += w.hours_worked || 0;
        byProduct[product].workers.add(w.worker_name);
        byProduct[product].dailyRecords.push(w);

        totalUnits += w.units_produced || 0;
        totalHours += w.hours_worked || 0;
        uniqueWorkers.add(w.worker_name);
      });

      console.log('Production aggregation:', {
        byProduct: Object.keys(byProduct),
        totalUnits,
        totalHours,
        uniqueWorkers: uniqueWorkers.size
      });

      // Add old production records to the totals
      let totalRawMaterialCost = 0;
      oldProduction.forEach(prod => {
        const product = prod.product_name;
        if (!byProduct[product]) {
          byProduct[product] = {
            totalUnits: 0,
            totalHours: 0,
            totalRawCost: 0,
            workers: new Set(),
            dailyRecords: []
          };
        }
        byProduct[product].totalUnits += prod.units_produced || 0;
        byProduct[product].totalRawCost += prod.raw_material_cost || 0;
        totalUnits += prod.units_produced || 0;
        totalRawMaterialCost += prod.raw_material_cost || 0;
      });

      // Get monthly worker wages from households
      const householdExpenses = getFilteredData(allData.filter(d => d.type === 'household' && d.category === 'Worker Wages'));
      const totalMonthlyWages = householdExpenses.reduce((sum, h) => sum + (h.cost || 0), 0);

      // Calculate overhead from investments (excluding worker wages)
      const overheadCost = investments.reduce((sum, i) => sum + ((i.cost || 0) + (i.transport_cost || 0)), 0);
      const overheadPerUnit = totalUnits > 0 ? overheadCost / totalUnits : 0;
      const totalCost = totalMonthlyWages + overheadCost + totalRawMaterialCost;
      const costPerUnit = totalUnits > 0 ? totalCost / totalUnits : 0;
      const avgProductivity = totalHours > 0 ? totalUnits / totalHours : 0;

      // Monthly Overview Cards
      const overviewHTML = `
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
          <div class="text-sm text-blue-600 mb-1">Total Production</div>
          <div class="text-2xl font-bold text-blue-700">${totalUnits.toLocaleString()}</div>
          <div class="text-xs text-blue-600">${Object.keys(byProduct).length} product${Object.keys(byProduct).length !== 1 ? 's' : ''}</div>
        </div>
        <div class="bg-green-50 border border-green-200 rounded-lg p-3">
          <div class="text-sm text-green-600 mb-1">Active Workers</div>
          <div class="text-2xl font-bold text-green-700">${uniqueWorkers.size}</div>
          <div class="text-xs text-green-600">${totalHours.toFixed(1)} total hours</div>
        </div>
        <div class="bg-orange-50 border border-orange-200 rounded-lg p-3">
          <div class="text-sm text-orange-600 mb-1">Total Cost</div>
          <div class="text-2xl font-bold text-orange-700">${currency}${totalCost.toLocaleString()}</div>
          <div class="text-xs text-orange-600">${currency}${costPerUnit.toFixed(2)}/unit</div>
        </div>
        <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
          <div class="text-sm text-purple-600 mb-1">Avg Productivity</div>
          <div class="text-2xl font-bold text-purple-700">${avgProductivity.toFixed(1)}</div>
          <div class="text-xs text-purple-600">units/hour</div>
        </div>
      `;
      if (overviewContainer) overviewContainer.innerHTML = overviewHTML;
      if (workersOverviewContainer) workersOverviewContainer.innerHTML = overviewHTML;

      // Blur/lock production summary and worker performance if needed
      function applyLockToCard(cardId) {
        const card = document.getElementById(cardId);
        if (!card) return;
        card.style.position = 'relative';
        card.style.filter = 'blur(4px)';
        if (!card.querySelector('.locked-overlay')) {
          const overlay = document.createElement('div');
          overlay.className = 'locked-overlay';
          overlay.style = 'position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.7);z-index:50;display:flex;align-items:center;justify-content:center;font-size:1.2rem;font-weight:bold;color:#1e293b;backdrop-filter:blur(2px);pointer-events:auto;';
          overlay.innerHTML = 'üîí Editing locked after 2 changes';
          card.appendChild(overlay);
        }
      }
      function removeLockFromCard(cardId) {
        const card = document.getElementById(cardId);
        if (!card) return;
        card.style.filter = '';
        const overlay = card.querySelector('.locked-overlay');
        if (overlay) overlay.remove();
      }
      if (shouldLockProductionUI()) {
        applyLockToCard('production-summary-card');
        applyLockToCard('worker-summary-card');
      } else {
        removeLockFromCard('production-summary-card');
        removeLockFromCard('worker-summary-card');
      }

      // Product-wise details
      let detailsHtml = '';
      Object.keys(byProduct).sort().forEach(productName => {
        const data = byProduct[productName];
        const product = products.find(p => p.name === productName);
        const sellingPrice = product?.price || 0;

        // Calculate product's share of wages based on proportion of total units produced
        const productWageShare = totalUnits > 0 ? (data.totalUnits / totalUnits) * totalMonthlyWages : 0;
        const productRawCost = data.totalRawCost || 0;
        const productOverhead = data.totalUnits * overheadPerUnit;
        const productTotalCost = productWageShare + productRawCost + productOverhead;
        const productCostPerUnit = data.totalUnits > 0 ? productTotalCost / data.totalUnits : 0;

        const profitPerUnit = sellingPrice - productCostPerUnit;
        const profitMargin = sellingPrice > 0 ? (profitPerUnit / sellingPrice * 100) : 0;
        const isProfitable = profitPerUnit > 0;
        const productivity = data.totalHours > 0 ? data.totalUnits / data.totalHours : 0;

        // Check pending orders
        const productOrders = orders.filter(o => o.product_name === productName);
        const orderQuantity = productOrders.reduce((sum, o) => sum + (o.quantity || 0), 0);
        const fulfillmentPercent = orderQuantity > 0 ? (data.totalUnits / orderQuantity * 100) : 0;

        detailsHtml += `
          <div class="card-gradient rounded-xl shadow-lg border-2 ${isProfitable ? 'border-green-300' : 'border-red-300'} p-4 mb-4">
            <div class="flex justify-between items-start mb-4">
              <div>
                <h3 class="text-xl font-bold text-slate-800">${escapeHtml(productName)}</h3>
                <p class="text-sm text-slate-600">${data.workers.size} worker${data.workers.size !== 1 ? 's' : ''}: ${[...data.workers].map(escapeHtml).join(', ')}</p>
              </div>
              <div class="text-right">
                <div class="text-2xl font-bold ${isProfitable ? 'text-green-600' : 'text-red-600'}">
                  ${isProfitable ? '‚úì' : '‚ö†'} ${currency}${profitPerUnit.toFixed(2)}/unit
                </div>
                <div class="text-xs ${isProfitable ? 'text-green-600' : 'text-red-600'}">
                  ${profitMargin.toFixed(1)}% margin
                </div>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
              <div class="bg-white rounded-lg p-3 border border-slate-200">
                <div class="text-xs text-slate-600 mb-1">Units Produced</div>
                <div class="text-xl font-bold text-blue-600">${data.totalUnits.toLocaleString()}</div>
              </div>
              <div class="bg-white rounded-lg p-3 border border-slate-200">
                <div class="text-xs text-slate-600 mb-1">Hours Worked</div>
                <div class="text-xl font-bold text-purple-600">${data.totalHours.toFixed(1)}h</div>
              </div>
              <div class="bg-white rounded-lg p-3 border border-slate-200">
                <div class="text-xs text-slate-600 mb-1">Productivity</div>
                <div class="text-xl font-bold text-orange-600">${productivity.toFixed(1)}/h</div>
              </div>
            </div>

            ${orderQuantity > 0 ? `
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3">
                <div class="flex justify-between items-center mb-2">
                  <span class="text-sm font-semibold text-blue-800">Order Fulfillment</span>
                  <span class="text-sm font-bold ${fulfillmentPercent >= 100 ? 'text-green-600' : 'text-orange-600'}">${fulfillmentPercent.toFixed(0)}%</span>
                </div>
                <div class="w-full bg-blue-200 rounded-full h-2 mb-1">
                  <div class="${fulfillmentPercent >= 100 ? 'bg-green-500' : 'bg-orange-500'} h-2 rounded-full" style="width: ${Math.min(100, fulfillmentPercent)}%"></div>
                </div>
                <div class="text-xs text-blue-700">${data.totalUnits} of ${orderQuantity} units ordered</div>
              </div>
            ` : ''}

            <div class="bg-gradient-to-r ${isProfitable ? 'from-green-50 to-emerald-50 border-green-200' : 'from-red-50 to-rose-50 border-red-200'} border rounded-lg p-3">
              <div class="grid grid-cols-2 gap-2 text-sm">
                <div>
                  <span class="text-slate-600">Cost per Unit:</span>
                  <span class="font-bold ml-2">${currency}${productCostPerUnit.toFixed(2)}</span>
                </div>
                <div>
                  <span class="text-slate-600">Selling Price:</span>
                  <span class="font-bold ml-2">${currency}${sellingPrice.toFixed(2)}</span>
                </div>
                <div class="col-span-2 pt-2 border-t border-slate-300">
                  <span class="text-slate-600">Total Profit:</span>
                  <span class="font-bold text-lg ml-2 ${isProfitable ? 'text-green-600' : 'text-red-600'}">
                    ${isProfitable ? '+' : ''}${currency}${(profitPerUnit * data.totalUnits).toFixed(2)}
                  </span>
                  <span class="text-xs text-slate-500 ml-1">(${data.totalUnits} units √ó ${currency}${profitPerUnit.toFixed(2)})</span>
                </div>
              </div>
            </div>
          </div>
        `;
      });

      // Add daily production records grouped by date
      if (workers.length > 0) {
        // Group all daily records by date
        const recordsByDate = {};
        workers.forEach(w => {
          const date = w.date || 'No Date';
          if (!recordsByDate[date]) {
            recordsByDate[date] = [];
          }
          recordsByDate[date].push(w);
        });

        // Sort dates in descending order (newest first)
        let sortedDates = Object.keys(recordsByDate).sort((a, b) => b.localeCompare(a));

        // Apply view mode filter
        const now = new Date();
        const currentMonth = now.toISOString().slice(0, 7);
        const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

        if (productionDailyViewMode === 'month') {
          sortedDates = sortedDates.filter(date => date.startsWith(currentMonth));
        } else if (productionDailyViewMode === 'week') {
          sortedDates = sortedDates.filter(date => new Date(date) >= oneWeekAgo);
        }

        // Pagination
        const totalPages = Math.ceil(sortedDates.length / RECORDS_PER_PAGE);
        const startIdx = (productionDailyPage - 1) * RECORDS_PER_PAGE;
        const endIdx = startIdx + RECORDS_PER_PAGE;
        const paginatedDates = sortedDates.slice(startIdx, endIdx);

        // Add daily records section with filters and pagination
        detailsHtml += `
          <div class="mt-8 mb-4">
            <div class="flex flex-wrap justify-between items-center mb-4 gap-3">
              <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                Daily Production Records
              </h3>
              
              <!-- View Mode Filters -->
              <div class="flex gap-2">
                <button onclick="changeProductionViewMode('all')" 
                  class="px-4 py-2 rounded-lg font-medium transition-all ${productionDailyViewMode === 'all' ? 'bg-blue-600 text-white shadow-md' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}">
                  All Time
                </button>
                <button onclick="changeProductionViewMode('month')" 
                  class="px-4 py-2 rounded-lg font-medium transition-all ${productionDailyViewMode === 'month' ? 'bg-blue-600 text-white shadow-md' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}">
                  This Month
                </button>
                <button onclick="changeProductionViewMode('week')" 
                  class="px-4 py-2 rounded-lg font-medium transition-all ${productionDailyViewMode === 'week' ? 'bg-blue-600 text-white shadow-md' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}">
                  Last 7 Days
                </button>
              </div>
            </div>
            
            ${paginatedDates.length === 0 ? `
              <div class="text-center py-8 text-slate-500">
                No records found for the selected period
              </div>
            ` : ''}
        `;

        paginatedDates.forEach((date, idx) => {
          const dayRecords = recordsByDate[date];
          const dayTotal = dayRecords.reduce((sum, r) => sum + (r.units_produced || 0), 0);
          const dayHours = dayRecords.reduce((sum, r) => sum + (r.hours_worked || 0), 0);

          detailsHtml += `
            ${idx > 0 ? `
              <!-- Page Break / Visual Separator -->
              <div class="relative my-8">
                <div class="absolute inset-0 flex items-center">
                  <div class="w-full border-t-2 border-slate-300"></div>
                </div>
                <div class="relative flex justify-center">
                  <span class="bg-white px-4 text-sm text-slate-500 font-medium">
                    <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"/></svg>
                  </span>
                </div>
              </div>
            ` : ''}
            
            <div class="mb-8 bg-gradient-to-br from-slate-50 to-blue-50 rounded-xl p-6 shadow-lg border-2 border-blue-200">
              <!-- Date Header with Strong Visual Identity -->
              <div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl p-5 mb-4 shadow-md">
                <div class="flex justify-between items-center text-white">
                  <div class="flex items-center gap-4">
                    <div class="bg-white text-blue-600 rounded-full w-14 h-14 flex flex-col items-center justify-center font-bold shadow-lg">
                      <div class="text-2xl">${new Date(date).getDate()}</div>
                      <div class="text-xs uppercase">${new Date(date).toLocaleDateString('en-US', { month: 'short' })}</div>
                    </div>
                    <div>
                      <div class="text-2xl font-bold">${formatDate(date)}</div>
                      <div class="text-sm text-blue-100">${new Date(date).toLocaleDateString('en-US', { weekday: 'long' })}</div>
                    </div>
                  </div>
                  <div class="text-right">
                    <div class="text-3xl font-bold">${dayTotal.toLocaleString()}</div>
                    <div class="text-sm text-blue-100">units produced</div>
                    <div class="text-xs text-blue-200 mt-1">${dayHours.toFixed(1)} hours ‚Ä¢ ${dayRecords.length} worker${dayRecords.length !== 1 ? 's' : ''}</div>
                  </div>
                </div>
              </div>

              <!-- Worker Records for this Day -->
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                ${dayRecords.map(record => `
                  <div class="bg-white rounded-lg border-2 border-slate-200 p-4 hover:shadow-xl hover:border-blue-400 transition-all">
                    <div class="flex justify-between items-start mb-3">
                      <div class="font-bold text-slate-800 text-lg">${escapeHtml(record.worker_name || 'Unknown')}</div>
                      <div class="text-xs bg-blue-600 text-white px-3 py-1 rounded-full font-semibold">${escapeHtml(record.product_name || 'N/A')}</div>
                    </div>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                      <div class="bg-blue-50 rounded-lg p-3">
                        <div class="text-xs text-slate-600 mb-1">Units</div>
                        <div class="text-xl font-bold text-blue-600">${(record.units_produced || 0).toLocaleString()}</div>
                      </div>
                      <div class="bg-purple-50 rounded-lg p-3">
                        <div class="text-xs text-slate-600 mb-1">Hours</div>
                        <div class="text-xl font-bold text-purple-600">${(record.hours_worked || 0).toFixed(1)}h</div>
                      </div>
                    </div>
                    ${record.hours_worked > 0 ? `
                      <div class="text-sm text-slate-600 pt-3 border-t border-slate-200">
                        <span class="text-orange-600 font-bold">${((record.units_produced || 0) / record.hours_worked).toFixed(1)}</span> units/hour
                      </div>
                    ` : ''}
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        });

        // Pagination controls
        if (totalPages > 1) {
          detailsHtml += `
            <div class="flex justify-center items-center gap-3 mt-6 mb-4">
              <button onclick="changeProductionPage('prev')" 
                ${productionDailyPage === 1 ? 'disabled' : ''}
                class="px-4 py-2 rounded-lg font-medium ${productionDailyPage === 1 ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700'} transition-all">
                ‚Üê Previous
              </button>
              
              <div class="text-slate-700 font-medium">
                Page ${productionDailyPage} of ${totalPages}
              </div>
              
              <button onclick="changeProductionPage('next')" 
                ${productionDailyPage === totalPages ? 'disabled' : ''}
                class="px-4 py-2 rounded-lg font-medium ${productionDailyPage === totalPages ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700'} transition-all">
                Next ‚Üí
              </button>
            </div>
          `;
        }

        detailsHtml += '</div>';
      }

      try {
        if (detailsContainer) detailsContainer.innerHTML = detailsHtml;
        if (workersDetailsContainer) workersDetailsContainer.innerHTML = detailsHtml;
        // Blur/lock production details if needed
        function applyLockToDetails(cardId) {
          const card = document.getElementById(cardId);
          if (!card) return;
          card.style.position = 'relative';
          card.style.filter = 'blur(4px)';
          let overlay = card.querySelector('.locked-overlay');
          if (!overlay) {
            overlay = document.createElement('div');
            overlay.className = 'locked-overlay';
            overlay.style = 'position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.85);z-index:9999;display:flex;align-items:center;justify-content:center;font-size:1.4rem;font-weight:bold;color:#1e293b;backdrop-filter:blur(2px);pointer-events:auto;border:2px solid red;';
            overlay.innerHTML = '<span style="background:rgba(255,255,255,0.95);padding:1.5rem 2.5rem;border-radius:1rem;box-shadow:0 2px 12px #0002;">üîí Editing locked after 2 changes<br><span style="font-size:1rem;color:#b91c1c;">(Debug: Overlay is visible)</span></span>';
            card.appendChild(overlay);
          } else {
            card.appendChild(overlay); // ensure it's last child
          }
        }
        function removeLockFromDetails(cardId) {
          const card = document.getElementById(cardId);
          if (!card) return;
          card.style.filter = '';
          const overlay = card.querySelector('.locked-overlay');
          if (overlay) overlay.remove();
        }
        if (shouldLockProductionUI()) {
          applyLockToDetails('production-details-card');
          applyLockToDetails('worker-details-card');
        } else {
          removeLockFromDetails('production-details-card');
          removeLockFromDetails('worker-details-card');
        }
        console.log('Details HTML rendered successfully, products:', Object.keys(byProduct).length);
        console.log('Overview container has content:', overviewContainer.innerHTML.length, 'chars');
        console.log('Details container has content:', detailsContainer.innerHTML.length, 'chars');
        // Verify DOM elements are actually rendered
        setTimeout(() => {
          const overviewCards = overviewContainer.querySelectorAll('.bg-blue-50, .bg-green-50, .bg-purple-50, .bg-orange-50');
          const detailsCards = detailsContainer.querySelectorAll('.card-gradient');
          console.log('DOM Verification:', {
            overviewCardsFound: overviewCards.length,
            detailsCardsFound: detailsCards.length,
            overviewVisible: overviewContainer.offsetHeight > 0,
            detailsVisible: detailsContainer.offsetHeight > 0
          });
          if (overviewCards.length === 0) {
            console.error('‚ö†Ô∏è Overview cards not found in DOM!');
            console.log('Overview innerHTML:', overviewContainer.innerHTML.substring(0, 200));
          }
        }, 100);
      } catch (error) {
        console.error('Error rendering details:', error);
        detailsContainer.innerHTML = '<div class="text-red-600">Error rendering product details</div>';
      }

      // Show old production records if they exist
      if (oldProduction.length > 0) {
        detailsContainer.innerHTML += `
          <div class="card-gradient rounded-xl shadow-lg border border-blue-300 p-4 mb-4">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-bold text-slate-800">üìã Previous Production Records</h3>
              <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">${oldProduction.length} records</span>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm">
                <thead class="bg-slate-50 border-b border-slate-200">
                  <tr>
                    <th class="text-left px-3 py-2 text-slate-600">Date</th>
                    <th class="text-left px-3 py-2 text-slate-600">Product</th>
                    <th class="text-right px-3 py-2 text-slate-600">Units</th>
                    <th class="text-right px-3 py-2 text-slate-600">Raw Cost</th>
                    <th class="text-right px-3 py-2 text-slate-600">Wastage</th>
                    <th class="text-right px-3 py-2 text-slate-600">Total Cost</th>
                    <th class="text-center px-3 py-2 text-slate-600">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  ${oldProduction.map(prod => {
          const costPerUnit = prod.units_produced > 0 ? (prod.total_cost / prod.units_produced) : 0;
          return `
                      <tr class="border-b border-slate-100 hover:bg-slate-50">
                        <td class="px-3 py-2 text-slate-600">${formatDate(prod.date)}</td>
                        <td class="px-3 py-2 font-medium">${escapeHtml(prod.product_name)}</td>
                        <td class="px-3 py-2 text-right font-semibold text-blue-600">${(prod.units_produced || 0).toLocaleString()}</td>
                        <td class="px-3 py-2 text-right text-green-600">${currency}${(prod.raw_material_cost || 0).toLocaleString()}</td>
                        <td class="px-3 py-2 text-right ${prod.wastage_percent > 10 ? 'text-red-600 font-semibold' : 'text-slate-600'}">${prod.wastage_percent || 0}%</td>
                        <td class="px-3 py-2 text-right font-bold text-purple-600">${currency}${(prod.total_cost || 0).toLocaleString()}</td>
                        <td class="px-3 py-2 text-center">
                          <button onclick="deleteItem('${prod.__backendId}')" class="text-red-600 hover:text-red-800" title="Delete">
                            <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                          </button>
                        </td>
                      </tr>
                    `;
        }).join('')}
                </tbody>
              </table>
            </div>
            <div class="mt-3 text-xs text-slate-500">
              üí° These are manually entered production records. New production is tracked via Workers tab.
            </div>
          </div>
        `;
      }
    }

    function renderAttendanceWorkers() {
      const masterWorkers = getMasterWorkers();
      const grid = document.getElementById('attendance-workers-grid');

      if (!grid) return;

      if (masterWorkers.length === 0) {
        grid.innerHTML = '<div class="col-span-full text-center py-4 text-slate-500">No workers added yet. Click "Add Worker" to start.</div>';
        return;
      }

      const currentMonth = new Date().toISOString().slice(0, 7);
      const attendanceRecords = getAttendance();

      grid.innerHTML = masterWorkers.map(worker => {
        // Get current month attendance for this worker
        const monthRecords = attendanceRecords.filter(a =>
          a.worker_id === worker.__backendId &&
          a.date &&
          a.date.startsWith(currentMonth)
        );
        const presentDays = monthRecords.filter(r => r.status === 'present').length;
        const absentDays = monthRecords.filter(r => r.status === 'absent').length;
        const remainingLeaves = getRemainingPaidLeaves(worker.__backendId, currentMonth);
        const globalPaidLeaves = getGlobalPaidLeaves();

        return `
        <div class="bg-white border border-slate-200 rounded-lg p-4 hover:shadow-lg transition-all cursor-pointer relative" onclick="showWorkerDetails('${worker.__backendId}')">
          <!-- Days Worked Badge -->
          <div class="absolute top-2 right-2 bg-gradient-to-r from-green-500 to-blue-500 text-white px-3 py-1 rounded-full text-xs font-bold shadow-md">
            ${presentDays} Days Worked
          </div>
          
          <div class="flex items-center justify-between mt-6">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-xl">
                ${escapeHtml(worker.name || '').charAt(0).toUpperCase()}
              </div>
              <div>
                <div class="font-semibold text-slate-800">${escapeHtml(worker.name || '')}</div>
                <div class="text-xs text-slate-500">${escapeHtml(worker.contact || 'No contact')}</div>
                <div class="text-xs font-semibold mt-1 ${remainingLeaves === 0 ? 'text-red-600' : remainingLeaves <= 1 ? 'text-orange-600' : 'text-blue-600'}">
                  Paid Leaves: ${remainingLeaves}/${globalPaidLeaves}
                </div>
              </div>
            </div>
            <div class="flex gap-1" onclick="event.stopPropagation()">
              <button onclick="editItem('${worker.__backendId}', 'master_worker')" class="p-1 text-blue-600 hover:text-blue-800" title="Edit">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
              </button>
              <button onclick="deleteItem('${worker.__backendId}')" class="p-1 text-red-600 hover:text-red-800" title="Delete">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      `;
      }).join('');

      // Initialize attendance date picker
      const dateInput = document.getElementById('attendance-date');
      if (dateInput && !dateInput.value) {
        dateInput.value = new Date().toISOString().split('T')[0];
        renderAttendanceForDate();
      }
    }

    async function renderAttendanceForDate() {
      const dateInput = document.getElementById('attendance-date');
      const grid = document.getElementById('attendance-marking-grid');
      if (!dateInput || !grid) return;

      const selectedDate = dateInput.value;
      const selectedDateObj = new Date(selectedDate);
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      selectedDateObj.setHours(0, 0, 0, 0);

      // Get current month and year
      const currentMonth = today.toISOString().substring(0, 7); // YYYY-MM
      const selectedMonth = selectedDate.substring(0, 7); // YYYY-MM

      const masterWorkers = getMasterWorkers(); // Active workers only
      const attendanceRecords = getAttendance();

      // For current month and past months, include deleted workers who have attendance records
      let workersToShow = [...masterWorkers];

      if (selectedMonth <= currentMonth) {
        // Include deleted workers who have attendance records for this month or earlier
        const allWorkerIds = [...new Set(attendanceRecords
          .filter(r => r.date && r.date.substring(0, 7) <= currentMonth)
          .map(r => r.worker_id))];

        allWorkerIds.forEach(workerId => {
          // If worker is not in the active list, add them as deleted worker
          if (!masterWorkers.find(w => w.__backendId === workerId)) {
            const workerRecords = attendanceRecords.filter(r => r.worker_id === workerId);
            if (workerRecords.length > 0) {
              // Find the first record with a valid worker name
              const workerName = workerRecords.find(r => r.worker_name && r.worker_name !== 'Unknown Worker' && r.worker_name !== 'Unknown')?.worker_name
                || workerRecords[0].worker_name
                || 'Unknown Worker';

              // Skip if name is still "Unknown Worker" - these are likely orphaned records
              if (workerName === 'Unknown Worker' || workerName === 'Unknown') {
                return;
              }

              workersToShow.push({
                __backendId: workerId,
                name: `${workerName} (Deleted)`,
                isDeleted: true
              });
            }
          }
        });
      }

      if (workersToShow.length === 0) {
        grid.innerHTML = '<div class="text-center py-4 text-slate-500">No workers available</div>';
        return;
      }

      grid.innerHTML = workersToShow.map(worker => {
        const record = attendanceRecords.find(a => a.worker_id === worker.__backendId && a.date === selectedDate);
        const isPresent = record?.status === 'present';
        const isHalfDay = record?.status === 'half-day';
        const isAbsent = record?.status === 'absent';
        const isDeleted = worker.isDeleted;

        return `
          <div class="flex items-center justify-between p-3 bg-white border border-slate-200 rounded-lg ${isDeleted ? 'opacity-60' : ''}">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold">
                ${escapeHtml(worker.name || '').charAt(0).toUpperCase()}
              </div>
              <span class="font-medium">${escapeHtml(worker.name || '')}</span>
            </div>
            <div class="flex gap-2">
              <button onclick="markAttendance('${worker.__backendId}', '${selectedDate}', 'present')" 
                class="px-3 py-2 rounded-lg font-medium text-sm transition-colors ${isPresent ? 'bg-green-600 text-white' : 'bg-green-100 text-green-700 hover:bg-green-200'}">
                ‚úì Full
              </button>
              <button onclick="markAttendance('${worker.__backendId}', '${selectedDate}', 'half-day')" 
                class="px-3 py-2 rounded-lg font-medium text-sm transition-colors ${isHalfDay ? 'bg-orange-600 text-white' : 'bg-orange-100 text-orange-700 hover:bg-orange-200'}">
                ‚óê Half
              </button>
              <button onclick="markAttendance('${worker.__backendId}', '${selectedDate}', 'absent')" 
                class="px-3 py-2 rounded-lg font-medium text-sm transition-colors ${isAbsent ? 'bg-red-600 text-white' : 'bg-red-100 text-red-700 hover:bg-red-200'}">
                ‚úó Absent
              </button>
            </div>
          </div>
        `;
      }).join('');

      renderAttendanceHistory();
    }

    function renderAttendanceHistory(filteredRecords = null, dateRange = null) {
      const container = document.getElementById('attendance-history-container');
      if (!container) return;

      const attendanceRecords = filteredRecords || getAttendance();
      const masterWorkers = getMasterWorkers();

      // Get all unique worker IDs from attendance records (includes deleted workers)
      const allWorkerIds = [...new Set(attendanceRecords.map(r => r.worker_id))];

      if (allWorkerIds.length === 0) {
        container.innerHTML = '<div class="text-center py-8 text-slate-500">No attendance records yet</div>';
        return;
      }

      // Group by worker (including deleted workers)
      const byWorker = {};
      allWorkerIds.forEach(workerId => {
        const worker = masterWorkers.find(w => w.__backendId === workerId);
        const workerRecords = attendanceRecords.filter(r => r.worker_id === workerId);

        // Get worker name from records if worker is deleted
        // Try to find a valid name from any of the records
        let workerName = worker ? worker.name : null;
        if (!workerName) {
          const recordWithName = workerRecords.find(r => r.worker_name && r.worker_name !== 'Unknown Worker' && r.worker_name !== 'Unknown');
          workerName = recordWithName?.worker_name || workerRecords[0]?.worker_name || 'Unknown Worker';
        }

        // Skip if name is still "Unknown Worker" - these are likely orphaned records
        if (!worker && (workerName === 'Unknown Worker' || workerName === 'Unknown')) {
          return;
        }

        const isDeleted = !worker;

        byWorker[workerId] = {
          worker: worker || { name: workerName, __backendId: workerId },
          isDeleted: isDeleted,
          records: workerRecords
        };
      });

      container.innerHTML = Object.values(byWorker).map((data, index) => {
        const worker = data.worker;
        const workerId = worker.__backendId;

        // Only count the last status per day for each worker
        const recordsByDate = {};
        data.records.forEach(r => {
          recordsByDate[r.date] = r; // Overwrite, so last record for date remains
        });
        const lastRecords = Object.values(recordsByDate);
        const presentCount = lastRecords.filter(r => r.status === 'present').length;
        const halfDayCount = lastRecords.filter(r => r.status === 'half-day').length;
        const absentCount = lastRecords.filter(r => r.status === 'absent').length;

        // Get the month from records for salary calculation
        const month = lastRecords.length > 0 && lastRecords[0].date
          ? lastRecords[0].date.substring(0, 7)
          : new Date().toISOString().substring(0, 7);

        // Build calendar view if dateRange is provided
        let calendarHTML = '';
        if (dateRange && dateRange.dates && dateRange.dates.length > 0) {
          calendarHTML = `
            <div class="border-t border-slate-200 pt-3 mt-3">
              <div class="grid grid-cols-7 gap-1">
                ${dateRange.dates.map(dateStr => {
            const record = lastRecords.find(r => r.date === dateStr);
            const status = record?.status;
            const date = new Date(dateStr);
            const day = date.getDate();
            const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });

            let bgColor = 'bg-slate-100';
            let textColor = 'text-slate-400';
            let badge = '';

            if (status === 'present') {
              bgColor = 'bg-green-500';
              textColor = 'text-white';
              badge = '‚úì';
            } else if (status === 'absent') {
              bgColor = 'bg-red-500';
              textColor = 'text-white';
              badge = '‚úó';
            } else if (status === 'half-day') {
              bgColor = 'bg-orange-500';
              textColor = 'text-white';
              badge = '‚óê';
            }

            return `
                    <div class="text-center">
                      <div class="text-xs text-slate-500 mb-1">${dayName}</div>
                      <div class="${bgColor} ${textColor} rounded-lg p-2 font-bold text-sm">
                        ${day}
                        ${badge ? `<div class="text-xs">${badge}</div>` : ''}
                      </div>
                    </div>
                  `;
          }).join('')}
              </div>
            </div>
          `;
        }

        return `
          <div class="card-gradient shadow-lg border ${data.isDeleted ? 'border-orange-300' : 'border-slate-200'} rounded-xl overflow-hidden mb-4">
            <div class="p-4 cursor-pointer hover:opacity-90 transition-opacity" onclick="toggleWorkerHistory('${workerId}')">
              <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 bg-gradient-to-br ${data.isDeleted ? 'from-orange-400 to-red-500' : 'from-blue-500 to-purple-600'} rounded-full flex items-center justify-center text-white font-bold">
                    ${escapeHtml(worker?.name || 'U').charAt(0).toUpperCase()}
                  </div>
                  <div>
                    <div class="font-semibold text-lg">${escapeHtml(worker?.name || 'Unknown')}</div>
                    ${data.isDeleted ? '<div class="text-xs text-orange-600 font-semibold">‚ö†Ô∏è Worker Deleted</div>' : ''}
                  </div>
                </div>
                <div class="flex items-center gap-3">
                  <div class="text-sm text-slate-600">
                    <span class="text-green-600 font-semibold">${presentCount}‚úì</span> / 
                    <span class="text-orange-600 font-semibold">${halfDayCount}‚óê</span> / 
                    <span class="text-red-600 font-semibold">${absentCount}‚úó</span>
                  </div>
                  <svg id="chevron-${workerId}" class="w-5 h-5 text-slate-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                  </svg>
                </div>
              </div>
            </div>
            <div id="history-${workerId}" class="hidden" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out;">
              <div class="p-4 bg-gradient-to-br from-purple-50 to-pink-50 border-t border-slate-200">
                <div class="grid grid-cols-3 gap-3 mb-3">
                  <div class="bg-white border border-green-200 rounded-lg p-3 shadow-sm">
                    <div class="text-xs text-green-600 font-medium">Present</div>
                    <div class="text-xl font-bold text-green-700">${presentCount}</div>
                  </div>
                  <div class="bg-white border border-orange-200 rounded-lg p-3 shadow-sm">
                    <div class="text-xs text-orange-600 font-medium">Half Day</div>
                    <div class="text-xl font-bold text-orange-700">${halfDayCount}</div>
                  </div>
                  <div class="bg-white border border-red-200 rounded-lg p-3 shadow-sm">
                    <div class="text-xs text-red-600 font-medium">Absent</div>
                    <div class="text-xl font-bold text-red-700">${absentCount}</div>
                  </div>
                </div>
                <div class="bg-white border border-blue-200 rounded-lg p-3 mb-3 shadow-sm">
                  <div class="text-xs text-blue-600">Calculated Salary (for tracked days)</div>
                  <div class="text-lg font-bold text-blue-700">${getCurrency()}${calculateMonthlySalary(worker, presentCount, halfDayCount, absentCount, month).toLocaleString()}</div>
                </div>
                ${calendarHTML}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function toggleWorkerHistory(workerId) {
      const historyDiv = document.getElementById(`history-${workerId}`);
      const chevron = document.getElementById(`chevron-${workerId}`);

      if (historyDiv.classList.contains('hidden')) {
        // Expand
        historyDiv.classList.remove('hidden');
        historyDiv.style.maxHeight = historyDiv.scrollHeight + 'px';
        chevron.style.transform = 'rotate(180deg)';
      } else {
        // Collapse
        historyDiv.style.maxHeight = '0';
        chevron.style.transform = 'rotate(0deg)';
        setTimeout(() => {
          historyDiv.classList.add('hidden');
        }, 300);
      }
    }

    function updateHistoryDateInputs() {
      const filterType = document.getElementById('history-filter-type').value;
      const container = document.getElementById('history-date-container');

      if (filterType === 'all') {
        container.innerHTML = '';
      } else if (filterType === 'date') {
        container.innerHTML = `
          <div>
           <label class="block text-xs font-medium text-slate-600 mb-1">Select Date</label>
           <input type="date" id="history-date" class="input-field px-3 py-2 border border-slate-300 rounded-lg">
          </div>
        `;
      } else if (filterType === 'week') {
        container.innerHTML = `
          <div>
           <label class="block text-xs font-medium text-slate-600 mb-1">Week Starting From</label>
           <input type="date" id="history-week-start" class="input-field px-3 py-2 border border-slate-300 rounded-lg">
          </div>
        `;
      } else if (filterType === 'month') {
        const currentMonth = new Date().toISOString().slice(0, 7);
        container.innerHTML = `
          <div>
           <label class="block text-xs font-medium text-slate-600 mb-1">Select Month</label>
           <input type="month" id="history-month" value="${currentMonth}" class="input-field px-3 py-2 border border-slate-300 rounded-lg">
          </div>
        `;
      }
    }

    function filterAttendanceHistory() {
      const filterType = document.getElementById('history-filter-type').value;
      const allRecords = getAttendance();
      let filteredRecords = [];
      let dateRange = null;

      if (filterType === 'all') {
        filteredRecords = allRecords;
      } else if (filterType === 'date') {
        const selectedDate = document.getElementById('history-date')?.value;
        if (!selectedDate) {
          showToast('Please select a date', 'error');
          return;
        }
        filteredRecords = allRecords.filter(r => r.date === selectedDate);
        dateRange = { dates: [selectedDate] };
      } else if (filterType === 'week') {
        const weekStart = document.getElementById('history-week-start')?.value;
        if (!weekStart) {
          showToast('Please select week start date', 'error');
          return;
        }
        const startDate = new Date(weekStart);
        const endDate = new Date(startDate);
        endDate.setDate(endDate.getDate() + 6);

        // Generate all dates in the week
        const weekDates = [];
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
          weekDates.push(d.toISOString().split('T')[0]);
        }
        dateRange = { dates: weekDates };

        filteredRecords = allRecords.filter(r => {
          if (!r.date) return false;
          const recordDate = new Date(r.date);
          return recordDate >= startDate && recordDate <= endDate;
        });
      } else if (filterType === 'month') {
        const selectedMonth = document.getElementById('history-month')?.value;
        if (!selectedMonth) {
          showToast('Please select a month', 'error');
          return;
        }

        // Generate all dates in the month
        const [year, month] = selectedMonth.split('-');
        const daysInMonth = new Date(year, month, 0).getDate();
        const monthDates = [];
        for (let day = 1; day <= daysInMonth; day++) {
          monthDates.push(`${selectedMonth}-${String(day).padStart(2, '0')}`);
        }
        dateRange = { dates: monthDates };

        filteredRecords = allRecords.filter(r => r.date && r.date.startsWith(selectedMonth));
      }

      renderAttendanceHistory(filteredRecords, dateRange);
    }

    function updateProductionDateInputs() {
      const filterType = document.getElementById('production-filter-type').value;
      const container = document.getElementById('production-date-container');

      if (filterType === 'all') {
        container.innerHTML = '';
      } else if (filterType === 'date') {
        container.innerHTML = `
          <div>
           <label class="block text-xs font-medium text-slate-600 mb-1">Select Date</label>
           <input type="date" id="production-date" class="input-field px-3 py-2 border border-slate-300 rounded-lg">
          </div>
        `;
      } else if (filterType === 'week') {
        container.innerHTML = `
          <div>
           <label class="block text-xs font-medium text-slate-600 mb-1">Week Starting From</label>
           <input type="date" id="production-week-start" class="input-field px-3 py-2 border border-slate-300 rounded-lg">
          </div>
        `;
      } else if (filterType === 'month') {
        const currentMonth = new Date().toISOString().slice(0, 7);
        container.innerHTML = `
          <div>
           <label class="block text-xs font-medium text-slate-600 mb-1">Select Month</label>
           <input type="month" id="production-month" value="${currentMonth}" class="input-field px-3 py-2 border border-slate-300 rounded-lg">
          </div>
        `;
      }
    }

    let productionFilterState = { type: 'month', value: null };

    function filterProductionRecords() {
      const filterType = document.getElementById('production-filter-type').value;

      if (filterType === 'all') {
        productionFilterState = { type: 'all', value: null };
      } else if (filterType === 'date') {
        const selectedDate = document.getElementById('production-date')?.value;
        if (!selectedDate) {
          showToast('Please select a date', 'error');
          return;
        }
        productionFilterState = { type: 'date', value: selectedDate };
      } else if (filterType === 'week') {
        const weekStart = document.getElementById('production-week-start')?.value;
        if (!weekStart) {
          showToast('Please select week start date', 'error');
          return;
        }
        const startDate = new Date(weekStart);
        const endDate = new Date(startDate);
        endDate.setDate(endDate.getDate() + 6);
        productionFilterState = { type: 'week', start: startDate, end: endDate };
      } else if (filterType === 'month') {
        const selectedMonth = document.getElementById('production-month')?.value;
        if (!selectedMonth) {
          showToast('Please select a month', 'error');
          return;
        }
        productionFilterState = { type: 'month', value: selectedMonth };
      }

      renderWorkers();
    }

    function calculateMonthlySalary(worker, presentCount, halfDayCount, absentCount, month) {
      if (!worker || !worker.monthly_wage) {
        console.warn('calculateMonthlySalary: Worker has no monthly_wage set', worker);
        return 0;
      }

      const monthlyWage = parseFloat(worker.monthly_wage);
      if (monthlyWage <= 0) {
        console.warn('calculateMonthlySalary: Monthly wage is 0 or negative', monthlyWage);
        return 0;
      }

      // Get actual number of days in the month
      const [year, monthNum] = month.split('-').map(Number);
      const daysInMonth = new Date(year, monthNum, 0).getDate();
      const perDayWage = monthlyWage / daysInMonth;

      // Calculate salary: Pay only for days actually worked
      // Present days = full day wage
      // Half days = 50% of day wage
      // Absent days = no pay (paid leaves just prevent extra deduction, not add payment)
      const presentSalary = presentCount * perDayWage;
      const halfDaySalary = halfDayCount * (perDayWage * 0.5);

      const totalSalary = presentSalary + halfDaySalary;

      console.log('Salary calculation:', {
        worker: worker.name,
        monthlyWage,
        daysInMonth,
        perDayWage: perDayWage.toFixed(2),
        presentCount,
        halfDayCount,
        absentCount,
        presentSalary: presentSalary.toFixed(2),
        halfDaySalary: halfDaySalary.toFixed(2),
        totalSalary: totalSalary.toFixed(2)
      });

      return Math.max(0, totalSalary);
    }

    async function markAttendance(workerId, date, status) {
      try {
        const attendanceRecords = getAttendance();
        // Remove all other attendance records for this worker and date except the one being updated/created
        let existingRecord = attendanceRecords.find(a => a.worker_id === workerId && a.date === date);
        const duplicates = attendanceRecords.filter(a => a.worker_id === workerId && a.date === date && a !== existingRecord);
        for (const dup of duplicates) {
          if (dup.__backendId) await window.dataSdk.delete(dup.__backendId);
        }
        const oldStatus = existingRecord?.status;

        // Get worker name to store in attendance record
        // First check active workers, then check existing attendance records for deleted workers
        const activeWorker = getMasterWorkers().find(w => w.__backendId === workerId);
        const workerName = activeWorker?.name || existingRecord?.worker_name ||
          attendanceRecords.find(a => a.worker_id === workerId)?.worker_name ||
          'Unknown Worker';

        if (existingRecord) {
          // If status is unchanged, do nothing
          if (existingRecord.status === status) {
            showToast('Attendance already marked as ' + status, 'info');
            return;
          }
          // Update existing - preserve the worker name if it exists
          const result = await window.dataSdk.update({
            ...existingRecord,
            status: status,
            worker_name: existingRecord.worker_name || workerName
          });
          if (!result.isOk) throw new Error('Failed to update');
        } else {
          // Create new
          const record = {
            type: 'attendance',
            worker_id: workerId,
            worker_name: workerName,
            date: date,
            status: status,
            created_at: new Date().toISOString()
          };
          const result = await window.dataSdk.create(record);
          if (!result.isOk) throw new Error('Failed to create');
        }

        // Auto-create production placeholder for present and half-day workers
        if ((status === 'present' || status === 'half-day') && !oldStatus) {
          await createProductionPlaceholder(workerId, date);
        }

        // Update used paid leaves for the month
        if (status === 'absent' || status === 'half-day' || (oldStatus === 'absent' && status === 'present')) {
          await updateWorkerPaidLeaves(workerId, date);
        }

        // Update monthly salary in household after attendance change
        const month = date.substring(0, 7);
        if (activeWorker) {
          await updateWorkerMonthlySalary(activeWorker, month);
        }

        showToast('Attendance marked successfully!', 'success');
        renderAttendanceForDate();
        updatePendingBadges();
      } catch (error) {
        showToast('Failed to mark attendance', 'error');
      }
    }

    function saveGlobalPaidLeaves(value) {
      localStorage.setItem('global_paid_leaves', value);
      showToast('Paid leaves setting saved', 'success');
      renderAttendanceHistory(); // Refresh history with new calculation
    }

    async function updateWorkerPaidLeaves(workerId, date) {
      const month = date.substring(0, 7); // YYYY-MM
      const key = `paid_leaves_used_${workerId}_${month}`;

      // Count absences for this worker this month
      const attendanceRecords = getAttendance();
      const monthRecords = attendanceRecords.filter(a =>
        a.worker_id === workerId &&
        a.date &&
        a.date.startsWith(month)
      );

      const absentCount = monthRecords.filter(r => r.status === 'absent').length;
      const globalPaidLeaves = getGlobalPaidLeaves();
      const usedPaidLeaves = Math.min(absentCount, globalPaidLeaves);

      localStorage.setItem(key, usedPaidLeaves.toString());
    }

    function getUsedPaidLeaves(workerId, month) {
      const key = `paid_leaves_used_${workerId}_${month}`;
      return parseInt(localStorage.getItem(key) || '0');
    }

    function getRemainingPaidLeaves(workerId, month) {
      const globalPaidLeaves = getGlobalPaidLeaves();
      const usedPaidLeaves = getUsedPaidLeaves(workerId, month);
      return Math.max(0, globalPaidLeaves - usedPaidLeaves);
    }

    async function resetAllPaidLeaves() {
      if (!confirm('Reset paid leaves for all workers for the current month? This will set everyone back to the full allocation.')) {
        return;
      }

      try {
        const masterWorkers = getMasterWorkers();
        const currentMonth = new Date().toISOString().slice(0, 7);

        masterWorkers.forEach(worker => {
          const key = `paid_leaves_used_${worker.__backendId}_${currentMonth}`;
          localStorage.setItem(key, '0');
        });

        showToast('Paid leaves reset for all workers', 'success');
        renderAttendanceHistory();
        renderAttendanceWorkers();
      } catch (error) {
        showToast('Failed to reset paid leaves', 'error');
      }
    }

    function getGlobalPaidLeaves() {
      return parseInt(localStorage.getItem('global_paid_leaves') || '4');
    }

    function showWorkerDetails(workerId) {
      const worker = getMasterWorkers().find(w => w.__backendId === workerId);
      if (!worker) return;

      const attendanceRecords = getAttendance().filter(a => a.worker_id === workerId);
      const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
      const currentMonthRecords = attendanceRecords.filter(a => a.date && a.date.startsWith(currentMonth));

      const presentDays = currentMonthRecords.filter(r => r.status === 'present').length;
      const absentDays = currentMonthRecords.filter(r => r.status === 'absent').length;
      const globalPaidLeaves = getGlobalPaidLeaves();
      const usedPaidLeaves = Math.min(absentDays, globalPaidLeaves); // Paid leaves used
      const remainingPaidLeaves = Math.max(0, globalPaidLeaves - usedPaidLeaves);
      const currency = getCurrency();

      // Calculate salary for current month
      // Formula: If absences > paid leaves, deduct extra days
      // Deduction = (absences - paid leaves) √ó daily wage
      const extraUnpaidLeaves = Math.max(0, absentDays - globalPaidLeaves);
      const workingDays = 26;
      const dailyWage = (worker.monthly_wage || 0) / workingDays;
      const deduction = dailyWage * extraUnpaidLeaves;
      const calculatedSalary = Math.max(0, (worker.monthly_wage || 0) - deduction);

      const content = document.getElementById('worker-detail-content');
      content.innerHTML = `
        <div class="space-y-4">
          <div class="flex items-center gap-4 mb-4">
            <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-2xl">
              ${escapeHtml(worker.name || '').charAt(0).toUpperCase()}
            </div>
            <div>
              <h4 class="text-xl font-bold">${escapeHtml(worker.name || '')}</h4>
              <p class="text-slate-600">${escapeHtml(worker.contact || 'No contact')}</p>
            </div>
          </div>
          
          <div class="grid grid-cols-2 gap-3">
            <div class="bg-green-50 border border-green-200 rounded-lg p-3">
              <div class="text-xs text-green-600 mb-1">Monthly Wage</div>
              <div class="text-2xl font-bold text-green-700">${currency}${(worker.monthly_wage || 0).toLocaleString()}</div>
            </div>
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
              <div class="text-xs text-blue-600 mb-1">Paid Leaves Remaining</div>
              <div class="text-2xl font-bold text-blue-700">${remainingPaidLeaves}/${globalPaidLeaves}</div>
              <div class="text-xs text-slate-600 mt-1">${usedPaidLeaves} used</div>
            </div>
          </div>
          
          <div class="border-t border-slate-200 pt-4">
            <h5 class="font-semibold mb-3 text-slate-700">üìÖ Current Month Attendance (${new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' })})</h5>
            <div class="grid grid-cols-2 gap-3">
              <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                <div class="text-xs text-green-600 mb-1">‚úì Present Days</div>
                <div class="text-3xl font-bold text-green-700">${presentDays}</div>
              </div>
              <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                <div class="text-xs text-red-600 mb-1">‚úó Absent Days</div>
                <div class="text-3xl font-bold text-red-700">${absentDays}</div>
              </div>
            </div>
          </div>
          
          <div class="border-t border-slate-200 pt-4">
            <h5 class="font-semibold mb-2 text-slate-700">üí∞ Salary Calculation</h5>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-slate-600">Base Monthly Wage:</span>
                <span class="font-semibold">${currency}${(worker.monthly_wage || 0).toLocaleString()}</span>
              </div>
              <div class="flex justify-between">
                <span class="text-slate-600">Absent Days:</span>
                <span class="font-semibold">${absentDays} days</span>
              </div>
              <div class="flex justify-between">
                <span class="text-slate-600">Paid Leaves Used:</span>
                <span class="font-semibold text-blue-600">${usedPaidLeaves} / ${globalPaidLeaves} days</span>
              </div>
              <div class="flex justify-between">
                <span class="text-slate-600">Extra Unpaid Leaves:</span>
                <span class="font-semibold ${extraUnpaidLeaves > 0 ? 'text-red-600' : 'text-green-600'}">${extraUnpaidLeaves} days</span>
              </div>
              <div class="flex justify-between">
                <span class="text-slate-600">Daily Wage:</span>
                <span class="font-semibold">${currency}${dailyWage.toFixed(2)}/day</span>
              </div>
              <div class="flex justify-between">
                <span class="text-slate-600">Deduction (${extraUnpaidLeaves} √ó ${currency}${dailyWage.toFixed(2)}):</span>
                <span class="font-semibold text-red-600">-${currency}${deduction.toFixed(2)}</span>
              </div>
              <div class="flex justify-between border-t border-slate-300 pt-2 mt-2">
                <span class="text-slate-800 font-bold">Calculated Salary:</span>
                <span class="text-2xl font-bold text-blue-600">${currency}${calculatedSalary.toLocaleString()}</span>
              </div>
            </div>
          </div>
          
          ${worker.notes ? `
            <div class="border-t border-slate-200 pt-4">
              <h5 class="font-semibold mb-2 text-slate-700">üìù Notes</h5>
              <p class="text-sm text-slate-600">${escapeHtml(worker.notes)}</p>
            </div>
          ` : ''}
        </div>
      `;

      document.getElementById('worker-detail-modal').classList.remove('hidden');
    }

    function closeWorkerDetails() {
      document.getElementById('worker-detail-modal').classList.add('hidden');
    }

    function getAttendance() {
      return allData.filter(d => d.type === 'attendance');
    }

    function renderWorkers() {
      const currency = getCurrency();
      let workers = getFilteredData(getWorkers(), 'WORKERS');
      const tbody = document.getElementById('workers-table');

      // Apply additional filtering based on productionFilterState
      if (productionFilterState.type === 'date') {
        workers = workers.filter(w => w.date === productionFilterState.value);
      } else if (productionFilterState.type === 'week') {
        workers = workers.filter(w => {
          if (!w.date) return false;
          const recordDate = new Date(w.date);
          return recordDate >= productionFilterState.start && recordDate <= productionFilterState.end;
        });
      } else if (productionFilterState.type === 'month') {
        if (productionFilterState.value) {
          workers = workers.filter(w => w.date && w.date.startsWith(productionFilterState.value));
        }
      }
      // If type is 'all', show all workers (no additional filtering)

      // Update summary cards
      const uniqueWorkers = [...new Set(workers.map(w => w.worker_name))].length;
      const totalOutput = workers.reduce((sum, w) => sum + (w.units_produced || 0), 0);
      const totalHours = workers.reduce((sum, w) => sum + (w.hours_worked || 0), 0);
      const avgProductivity = totalHours > 0 ? (totalOutput / totalHours) : 0;

      // Get monthly wages from households
      const householdWages = getFilteredData(allData.filter(d => d.type === 'household' && d.category === 'Worker Wages'));
      const totalMonthlyWages = householdWages.reduce((sum, h) => sum + (h.cost || 0), 0);

      document.getElementById('total-workers').textContent = uniqueWorkers;
      document.getElementById('worker-output').textContent = totalOutput.toLocaleString();
      document.getElementById('total-wages').textContent = `${currency}${totalMonthlyWages.toLocaleString()}`;
      document.getElementById('avg-productivity').textContent = avgProductivity.toFixed(1);

      if (workers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-slate-500">No worker records yet.</td></tr>';
        return;
      }

      // Group workers by date (legacy, not used below)
      const workersByDate = {};
      workers.forEach(worker => {
        const date = worker.date || 'No Date';
        if (!workersByDate[date]) {
          workersByDate[date] = [];
        }
        workersByDate[date].push(worker);
      });

      // Prepare container and byWorker for attendance history rendering
      const container = document.getElementById('attendance-history-container');
      const byWorker = {};
      workers.forEach(worker => {
        if (!byWorker[worker.__backendId]) {
          byWorker[worker.__backendId] = { worker: worker, isDeleted: false, records: [] };
        }
        byWorker[worker.__backendId].records.push(worker);
      });

      // Render grouped by worker
      // Ensure dateRange is defined to avoid ReferenceError
      const dateRangeSafe = typeof dateRange !== 'undefined' ? dateRange : null;
      container.innerHTML = Object.values(byWorker).map((data, index) => {
        const worker = data.worker;
        const workerId = worker.__backendId;

        // Calculate attendance counts for this worker
        const presentCount = data.records.filter(r => r.status === 'present').length;
        const halfDayCount = data.records.filter(r => r.status === 'half-day').length;
        const absentCount = data.records.filter(r => r.status === 'absent').length;

        // Get the month from records for salary calculation
        const month = data.records.length > 0 && data.records[0].date
          ? data.records[0].date.substring(0, 7)
          : new Date().toISOString().substring(0, 7);

        // Build calendar view if dateRange is provided
        let calendarHTML = '';
        if (dateRangeSafe && dateRangeSafe.dates && dateRangeSafe.dates.length > 0) {
          calendarHTML = `
            <div class="border-t border-slate-200 pt-3 mt-3">
              <div class="grid grid-cols-7 gap-1">
                ${dateRangeSafe.dates.map(dateStr => {
            const record = data.records.find(r => r.date === dateStr);
            const status = record?.status;
            const date = new Date(dateStr);
            const day = date.getDate();
            const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });

            let bgColor = 'bg-slate-100';
            let textColor = 'text-slate-400';
            let badge = '';

            if (status === 'present') {
              bgColor = 'bg-green-500';
              textColor = 'text-white';
              badge = '‚úì';
            } else if (status === 'absent') {
              bgColor = 'bg-red-500';
              textColor = 'text-white';
              badge = '‚úó';
            } else if (status === 'half-day') {
              bgColor = 'bg-orange-500';
              textColor = 'text-white';
              badge = '‚óê';
            }

            return `
                    <div class="text-center">
                      <div class="text-xs text-slate-500 mb-1">${dayName}</div>
                      <div class="${bgColor} ${textColor} rounded-lg p-2 font-bold text-sm">
                        ${day}
                        ${badge ? `<div class="text-xs">${badge}</div>` : ''}
                      </div>
                    </div>
                  `;
          }).join('')}
              </div>
            </div>
          `;
        }

        return `
          <div class="card-gradient shadow-lg border ${data.isDeleted ? 'border-orange-300' : 'border-slate-200'} rounded-xl overflow-hidden mb-4">
            <div class="p-4 cursor-pointer hover:opacity-90 transition-opacity" onclick="toggleWorkerHistory('${workerId}')">
              <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 bg-gradient-to-br ${data.isDeleted ? 'from-orange-400 to-red-500' : 'from-blue-500 to-purple-600'} rounded-full flex items-center justify-center text-white font-bold">
                    ${escapeHtml(worker?.name || 'U').charAt(0).toUpperCase()}
                  </div>
                  <div>
                    <div class="font-semibold text-lg">${escapeHtml(worker?.name || 'Unknown')}</div>
                    ${data.isDeleted ? '<div class="text-xs text-orange-600 font-semibold">‚ö†Ô∏è Worker Deleted</div>' : ''}
                  </div>
                </div>
                <div class="flex items-center gap-3">
                  <div class="text-sm text-slate-600">
                    <span class="text-green-600 font-semibold">${presentCount}‚úì</span> / 
                    <span class="text-orange-600 font-semibold">${halfDayCount}‚óê</span> / 
                    <span class="text-red-600 font-semibold">${absentCount}‚úó</span>
                  </div>
                  <svg id="chevron-${workerId}" class="w-5 h-5 text-slate-400 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                  </svg>
                </div>
              </div>
            </div>
            <div id="history-${workerId}" class="hidden" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out;">
              <div class="p-4 bg-gradient-to-br from-purple-50 to-pink-50 border-t border-slate-200">
                <div class="grid grid-cols-3 gap-3 mb-3">
                  <div class="bg-white border border-green-200 rounded-lg p-3 shadow-sm">
                    <div class="text-xs text-green-600 font-medium">Present</div>
                    <div class="text-xl font-bold text-green-700">${presentCount}</div>
                  </div>
                  <div class="bg-white border border-orange-200 rounded-lg p-3 shadow-sm">
                    <div class="text-xs text-orange-600 font-medium">Half Day</div>
                    <div class="text-xl font-bold text-orange-700">${halfDayCount}</div>
                  </div>
                  <div class="bg-white border border-red-200 rounded-lg p-3 shadow-sm">
                    <div class="text-xs text-red-600 font-medium">Absent</div>
                    <div class="text-xl font-bold text-red-700">${absentCount}</div>
                  </div>
                </div>
                ${calendarHTML}
              </div>
            </div>
          </div>
        `;
        }).join('');

      // Calculate required production based on unsettled orders
      const ordersByProduct = {};
      const filteredOrders = getFilteredData(getOrders()).filter(o => !o.settled);
      filteredOrders.forEach(order => {
        const product = order.product_name;
        if (!ordersByProduct[product]) {
          ordersByProduct[product] = {
            required: 0,
            earliestDelivery: order.delivery_date || null
          };
        }
        ordersByProduct[product].required += order.quantity || 0;
        // Track earliest delivery date
        if (order.delivery_date && (!ordersByProduct[product].earliestDelivery || new Date(order.delivery_date) < new Date(ordersByProduct[product].earliestDelivery))) {
          ordersByProduct[product].earliestDelivery = order.delivery_date;
        }
      });

      // Calculate production completed from worker production records
      const productionByProduct = {};
      workers.forEach(workerProd => {
        const product = workerProd.product_name;
        if (!productionByProduct[product]) productionByProduct[product] = 0;
        productionByProduct[product] += workerProd.units_produced || 0;
      });

      // Calculate worker productivity - count only active master workers, not deleted ones
      // ...existing code...

      container.innerHTML = `
        <div class="space-y-4">
          ${Object.keys(ordersByProduct).map(product => {
        const data = ordersByProduct[product];
        const produced = productionByProduct[product] || 0;
        const remaining = data.required - produced;
        const progress = data.required > 0 ? (produced / data.required * 100) : 0;

        // Calculate days until delivery
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const deliveryDate = data.earliestDelivery ? new Date(data.earliestDelivery) : null;
        const daysRemaining = deliveryDate ? Math.ceil((deliveryDate - today) / (1000 * 60 * 60 * 24)) : null;

        // Calculate daily target
        const dailyTarget = daysRemaining > 0 && remaining > 0 ? Math.ceil(remaining / daysRemaining) : 0;
        const targetPerWorker = uniqueWorkers > 0 && dailyTarget > 0 ? Math.ceil(dailyTarget / uniqueWorkers) : 0;

        return `
              <div class="border rounded-lg p-4 ${remaining > 0 ? 'border-blue-300 bg-blue-50' : 'border-green-300 bg-green-50'}">
                <div class="flex items-center justify-between mb-2">
                  <div class="font-bold text-lg">${escapeHtml(product)}</div>
                  <div class="text-sm ${remaining > 0 ? 'text-blue-600' : 'text-green-600'} font-semibold">
                    ${remaining > 0 ? `${remaining} units remaining` : '‚úì Complete'}
                  </div>
                </div>
                <div class="mb-3">
                  <div class="flex justify-between text-sm text-slate-600 mb-1">
                    <span>Progress: ${produced} / ${data.required} units</span>
                    <span>${progress.toFixed(0)}%</span>
                  </div>
                  <div class="w-full bg-slate-200 rounded-full h-2 overflow-hidden">
                    <div class="h-2 rounded-full transition-all duration-300 ${remaining > 0 ? 'bg-blue-600' : 'bg-green-600'}" style="width: ${Math.min(Math.max(progress, 0), 100)}%"></div>
                  </div>
                </div>
                ${remaining > 0 ? `
                  <div class="grid grid-cols-2 gap-3 text-sm">
                    <div class="bg-white rounded p-2">
                      <div class="text-slate-600">Earliest Delivery</div>
                      <div class="font-semibold ${daysRemaining < 3 ? 'text-red-600' : 'text-slate-800'}">
                        ${deliveryDate ? formatDate(data.earliestDelivery) : 'Not set'}
                        ${daysRemaining !== null ? `(${daysRemaining}d)` : ''}
                      </div>
                    </div>
                    <div class="bg-white rounded p-2">
                      <div class="text-slate-600">Daily Target</div>
                      <div class="font-semibold text-slate-800">${dailyTarget} units/day</div>
                    </div>
                    ${uniqueWorkers > 0 ? `
                      <div class="bg-white rounded p-2 col-span-2">
                        <div class="text-slate-600">Per Worker Target (${uniqueWorkers} workers)</div>
                        <div class="font-semibold text-blue-700">${targetPerWorker} units/worker/day</div>
                        <div class="text-xs text-slate-500 mt-1">Est. ${(targetPerWorker / avgProductivity).toFixed(1)} hours/worker</div>
                      </div>
                    ` : ''}
                  </div>
                ` : ''}
              </div>
            `;
      }).join('')}
        </div>
      `;
    }

    function renderPricingRecommendations() {
      const currency = getCurrency();
      const production = getFilteredData(getProduction());
      const workers = getFilteredData(getWorkers());
      const investments = getFilteredData(getInvestments());
      const products = getProducts();
      const container = document.getElementById('pricing-recommendations');

      // Check if we have worker production data
      const workersWithProduction = workers.filter(w => !w.is_placeholder && (w.units_produced > 0 || w.hours_worked > 0));

      if (workersWithProduction.length === 0 && production.length === 0) {
        container.innerHTML = '<p class="text-slate-500 text-center py-8">Add production data to calculate recommended prices.</p>';
        return;
      }

      // Group by product from worker records
      const productData = {};

      // Add worker production data
      workersWithProduction.forEach(worker => {
        const product = worker.product_name;
        if (!product) return;

        if (!productData[product]) {
          productData[product] = { totalUnits: 0, rawMaterialCost: 0 };
        }
        productData[product].totalUnits += worker.units_produced || 0;
      });

      // Add old production data if exists
      production.forEach(prod => {
        const product = prod.product_name;
        if (!productData[product]) {
          productData[product] = { totalUnits: 0, rawMaterialCost: 0 };
        }
        productData[product].rawMaterialCost += prod.raw_material_cost || 0;
        productData[product].totalUnits += prod.units_produced || 0;
      });

      // Calculate total units produced across all products
      const totalProducedUnits = Object.values(productData).reduce((sum, p) => sum + p.totalUnits, 0);

      if (totalProducedUnits === 0) {
        container.innerHTML = '<p class="text-slate-500 text-center py-8">No production units found to calculate prices.</p>';
        return;
      }

      // Add labor costs from household worker wages
      const householdWages = getFilteredData(allData.filter(d => d.type === 'household' && d.category === 'Worker Wages'));
      const totalMonthlyWages = householdWages.reduce((sum, h) => sum + (h.cost || 0), 0);
      const laborCostPerUnit = totalProducedUnits > 0 ? totalMonthlyWages / totalProducedUnits : 0;

      // Add overhead (expenses) cost
      const overheadCost = investments.reduce((sum, i) => sum + ((i.cost || 0) + (i.transport_cost || 0)), 0);
      const overheadPerUnit = totalProducedUnits > 0 ? overheadCost / totalProducedUnits : 0;

      container.innerHTML = `
        <div class="space-y-4">
          ${Object.keys(productData).sort().map(productName => {
        const data = productData[productName];
        const rawMaterialPerUnit = data.totalUnits > 0 ? (data.rawMaterialCost / data.totalUnits) : 0;
        const totalCostPerUnit = rawMaterialPerUnit + laborCostPerUnit + overheadPerUnit;

        // Get current selling price from products
        const product = products.find(p => p.name === productName);
        const currentPrice = product?.price || 0;
        const currentMargin = totalCostPerUnit > 0 ? ((currentPrice - totalCostPerUnit) / totalCostPerUnit * 100) : 0;

        // Different profit margins
        const margins = [
          { name: 'Break-even', percent: 0, color: 'red' },
          { name: 'Conservative', percent: 15, color: 'orange' },
          { name: 'Standard', percent: 25, color: 'blue' },
          { name: 'Premium', percent: 40, color: 'green' }
        ];

        return `
              <div class="border border-slate-300 rounded-lg p-4">
                <div class="flex justify-between items-start mb-3">
                  <div class="font-bold text-lg">${escapeHtml(productName)}</div>
                  ${currentPrice > 0 ? `
                    <div class="text-right">
                      <div class="text-sm text-slate-600">Current Price</div>
                      <div class="font-bold ${currentPrice > totalCostPerUnit ? 'text-green-600' : 'text-red-600'}">
                        ${currency}${currentPrice.toFixed(2)}
                      </div>
                      <div class="text-xs ${currentMargin > 0 ? 'text-green-600' : 'text-red-600'}">
                        ${currentMargin > 0 ? '+' : ''}${currentMargin.toFixed(1)}% margin
                      </div>
                    </div>
                  ` : ''}
                </div>
                
                <div class="bg-slate-50 rounded-lg p-3 mb-3">
                  <div class="text-xs text-slate-600 mb-2">Cost Breakdown (per unit):</div>
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                    <div class="bg-white rounded p-2 border border-slate-200">
                      <div class="text-xs text-purple-600">Raw Material</div>
                      <div class="font-semibold text-purple-800">${currency}${rawMaterialPerUnit.toFixed(2)}</div>
                    </div>
                    <div class="bg-white rounded p-2 border border-slate-200">
                      <div class="text-xs text-orange-600">Labor</div>
                      <div class="font-semibold text-orange-800">${currency}${laborCostPerUnit.toFixed(2)}</div>
                    </div>
                    <div class="bg-white rounded p-2 border border-slate-200">
                      <div class="text-xs text-slate-600">Overhead</div>
                      <div class="font-semibold text-slate-800">${currency}${overheadPerUnit.toFixed(2)}</div>
                    </div>
                    <div class="bg-white rounded p-2 border-2 border-blue-300">
                      <div class="text-xs text-blue-600 font-semibold">Total Cost</div>
                      <div class="font-bold text-blue-800">${currency}${totalCostPerUnit.toFixed(2)}</div>
                    </div>
                  </div>
                </div>
                
                <div class="text-sm font-semibold mb-2">üí∞ Recommended Selling Prices:</div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                  ${margins.map(margin => {
          const price = totalCostPerUnit * (1 + margin.percent / 100);
          const profit = price - totalCostPerUnit;
          return `
                      <div class="bg-${margin.color}-50 border-2 border-${margin.color}-300 rounded-lg p-3 text-center hover:shadow-md transition-shadow">
                        <div class="text-xs text-${margin.color}-700 font-semibold mb-1">${margin.name}</div>
                        <div class="text-xs text-${margin.color}-600 mb-1">${margin.percent > 0 ? `+${margin.percent}%` : margin.percent + '%'} profit</div>
                        <div class="font-bold text-lg text-${margin.color}-700">${currency}${price.toFixed(2)}</div>
                        <div class="text-xs text-${margin.color}-600 mt-1">
                          ${margin.percent > 0 ? `+${currency}${profit.toFixed(2)}/unit` : 'No profit'}
                        </div>
                      </div>
                    `;
        }).join('')}
                </div>
                <div class="text-xs text-slate-500 mt-2">
                  üìä Based on ${data.totalUnits.toLocaleString()} units produced
                </div>
              </div>
            `;
      }).join('')}
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mt-4">
            <div class="text-sm text-blue-800">
              üí° <strong>Pricing Guide:</strong> Prices include raw material (${currency}${(totalProducedUnits > 0 ? Object.values(productData).reduce((sum, p) => sum + p.rawMaterialCost, 0) / totalProducedUnits : 0).toFixed(2)}/unit avg), 
              labor (${currency}${laborCostPerUnit.toFixed(2)}/unit), and overhead (${currency}${overheadPerUnit.toFixed(2)}/unit). 
              Choose margin based on market conditions and competition.
            </div>
          </div>
        </div>
      `;
    }

    function renderMonthlyBreakdown() {
      const currency = getCurrency();
      const investments = getInvestments();
      const sales = getSales();

      const monthlyData = {};

      investments.forEach(inv => {
        if (inv.date) {
          const month = inv.date.substring(0, 7);
          if (!monthlyData[month]) monthlyData[month] = { invested: 0, revenue: 0, pending: 0 };
          monthlyData[month].invested += inv.cost || 0;
        }
      });

      sales.forEach(sale => {
        if (sale.date) {
          const month = sale.date.substring(0, 7);
          if (!monthlyData[month]) monthlyData[month] = { invested: 0, revenue: 0, pending: 0 };
          monthlyData[month].revenue += sale.selling_price || 0;
          monthlyData[month].pending += sale.pending_balance || 0;
        }
      });

      const container = document.getElementById('monthly-breakdown');
      const months = Object.keys(monthlyData).sort().reverse();

      if (months.length === 0) {
        container.innerHTML = '<p class="text-slate-500 text-center py-8">No data available yet. Start by adding investments and sales.</p>';
        return;
      }

      container.innerHTML = `
        <table class="w-full">
          <thead class="bg-slate-50">
            <tr>
              <th class="text-left px-4 py-2 text-sm font-semibold text-slate-600">Month</th>
              <th class="text-right px-4 py-2 text-sm font-semibold text-slate-600">Invested</th>
              <th class="text-right px-4 py-2 text-sm font-semibold text-slate-600">Revenue</th>
              <th class="text-right px-4 py-2 text-sm font-semibold text-slate-600">Profit/Loss</th>
              <th class="text-right px-4 py-2 text-sm font-semibold text-slate-600">Pending</th>
            </tr>
          </thead>
          <tbody>
            ${months.map(month => {
        const data = monthlyData[month];
        const profit = data.revenue - data.invested;
        return `
                <tr class="border-b border-slate-100">
                  <td class="px-4 py-2 font-medium">${formatMonth(month)}</td>
                  <td class="px-4 py-2 text-right text-slate-600">${currency}${data.invested.toLocaleString()}</td>
                  <td class="px-4 py-2 text-right text-green-600">${currency}${data.revenue.toLocaleString()}</td>
                  <td class="px-4 py-2 text-right font-semibold ${profit >= 0 ? 'text-green-600' : 'text-red-600'}">${profit >= 0 ? '+' : '-'}${currency}${Math.abs(profit).toLocaleString()}</td>
                  <td class="px-4 py-2 text-right text-amber-600">${currency}${data.pending.toLocaleString()}</td>
                </tr>
              `;
      }).join('')}
          </tbody>
        </table>
      `;
    }

    function renderProductAnalysisDropdown() {
      const products = getProducts();
      const select = document.getElementById('product-analysis-select');
      const currentValue = select.value;

      select.innerHTML = '<option value="">Select a product...</option>' +
        products.map(p => `<option value="${p.__backendId}">${escapeHtml(p.name || '')}</option>`).join('');

      if (currentValue && products.find(p => p.__backendId === currentValue)) {
        select.value = currentValue;
        showProductAnalysis();
      }
    }

    function showProductAnalysis() {
      const currency = getCurrency();
      const select = document.getElementById('product-analysis-select');
      const container = document.getElementById('product-analysis');
      const productId = select.value;

      if (!productId) {
        container.innerHTML = '<p class="text-slate-500 text-center py-8">Select a product to view investment details and cost analysis.</p>';
        return;
      }

      const product = allData.find(d => d.__backendId === productId);
      if (!product) return;

      const investments = getInvestments().filter(i => i.name === product.name);
      const sales = getSales().filter(s => s.name === product.name);
      const orders = getOrders().filter(o => o.product_name === product.name);

      const totalInvested = investments.reduce((sum, i) => sum + (i.cost || 0), 0);
      const totalQuantity = investments.reduce((sum, i) => sum + (i.quantity || 0), 0);
      const avgCostPerUnit = totalQuantity > 0 ? totalInvested / totalQuantity : 0;

      // Calculate from both sales and orders
      const totalSoldFromSales = sales.reduce((sum, s) => sum + (s.quantity || 0), 0);
      const totalSoldFromOrders = orders.reduce((sum, o) => sum + (o.quantity || 0), 0);
      const totalSold = totalSoldFromSales + totalSoldFromOrders;

      const revenueFromSales = sales.reduce((sum, s) => sum + (s.selling_price || 0), 0);
      const revenueFromOrders = orders.reduce((sum, o) => sum + (o.price || 0), 0);
      const totalRevenue = revenueFromSales + revenueFromOrders;

      const avgSellingPrice = totalSold > 0 ? totalRevenue / totalSold : 0;

      // Calculate profit/loss
      const profitLoss = totalRevenue - totalInvested;
      const profitLossPerUnit = totalSold > 0 ? profitLoss / totalSold : 0;
      const profitMargin = totalRevenue > 0 ? (profitLoss / totalRevenue * 100) : 0;
      const isProfitable = profitLoss >= 0;

      container.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <div class="bg-slate-50 rounded-lg p-4">
            <div class="text-sm text-slate-600 mb-1">Total Invested</div>
            <div class="text-xl font-bold text-slate-800">${currency}${totalInvested.toLocaleString()}</div>
          </div>
          <div class="bg-slate-50 rounded-lg p-4">
            <div class="text-sm text-slate-600 mb-1">Total Qty Purchased</div>
            <div class="text-xl font-bold text-slate-800">${totalQuantity.toLocaleString()} ${product.unit || 'units'}</div>
          </div>
          <div class="bg-blue-50 rounded-lg p-4">
            <div class="text-sm text-blue-600 mb-1">Avg Cost per ${product.unit || 'unit'}</div>
            <div class="text-xl font-bold text-blue-800">${currency}${avgCostPerUnit.toFixed(2)}</div>
          </div>
          <div class="bg-green-50 rounded-lg p-4">
            <div class="text-sm text-green-600 mb-1">Total Revenue</div>
            <div class="text-xl font-bold text-green-800">${currency}${totalRevenue.toLocaleString()}</div>
          </div>
          <div class="bg-slate-50 rounded-lg p-4">
            <div class="text-sm text-slate-600 mb-1">Total Qty Sold</div>
            <div class="text-xl font-bold text-slate-800">${totalSold.toLocaleString()} ${product.unit || 'units'}</div>
          </div>
          <div class="bg-green-50 rounded-lg p-4">
            <div class="text-sm text-green-600 mb-1">Avg Selling Price per ${product.unit || 'unit'}</div>
            <div class="text-xl font-bold text-green-800">${currency}${avgSellingPrice.toFixed(2)}</div>
          </div>
        </div>
        
        <!-- Profit/Loss Section -->
        <div class="mt-4 p-5 rounded-xl border-2 ${isProfitable ? 'bg-gradient-to-br from-green-50 to-emerald-50 border-green-300' : 'bg-gradient-to-br from-red-50 to-rose-50 border-red-300'}">
          <div class="flex items-center justify-between mb-4">
            <h4 class="text-lg font-bold ${isProfitable ? 'text-green-800' : 'text-red-800'}">
              ${isProfitable ? '‚úÖ Profit' : '‚ö†Ô∏è Loss'} Analysis
            </h4>
            <div class="text-right">
              <div class="text-sm ${isProfitable ? 'text-green-600' : 'text-red-600'} mb-1">Profit Margin</div>
              <div class="text-2xl font-bold ${isProfitable ? 'text-green-700' : 'text-red-700'}">
                ${profitMargin >= 0 ? '+' : ''}${profitMargin.toFixed(1)}%
              </div>
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-white rounded-lg p-4 shadow-sm border ${isProfitable ? 'border-green-200' : 'border-red-200'}">
              <div class="text-sm ${isProfitable ? 'text-green-600' : 'text-red-600'} mb-1">Total Profit/Loss</div>
              <div class="text-2xl font-bold ${isProfitable ? 'text-green-700' : 'text-red-700'}">
                ${isProfitable ? '+' : ''}${currency}${profitLoss.toLocaleString()}
              </div>
              <div class="text-xs text-slate-500 mt-1">Revenue - Investment</div>
            </div>
            
            <div class="bg-white rounded-lg p-4 shadow-sm border ${isProfitable ? 'border-green-200' : 'border-red-200'}">
              <div class="text-sm ${isProfitable ? 'text-green-600' : 'text-red-600'} mb-1">Profit/Loss per ${product.unit || 'unit'}</div>
              <div class="text-2xl font-bold ${isProfitable ? 'text-green-700' : 'text-red-700'}">
                ${isProfitable ? '+' : ''}${currency}${profitLossPerUnit.toFixed(2)}
              </div>
              <div class="text-xs text-slate-500 mt-1">Per unit sold</div>
            </div>
            
            <div class="bg-white rounded-lg p-4 shadow-sm border border-blue-200">
              <div class="text-sm text-blue-600 mb-1">Break-even Price</div>
              <div class="text-2xl font-bold text-blue-700">
                ${currency}${avgCostPerUnit.toFixed(2)}
              </div>
              <div class="text-xs text-slate-500 mt-1">To avoid loss</div>
            </div>
          </div>
          
          ${!isProfitable ? `
            <div class="mt-4 p-3 bg-red-100 border border-red-300 rounded-lg">
              <div class="text-sm text-red-800">
                <strong>‚ö†Ô∏è You're losing money!</strong> Your current average selling price (${currency}${avgSellingPrice.toFixed(2)}) 
                is below your cost (${currency}${avgCostPerUnit.toFixed(2)}). Consider increasing your selling price.
              </div>
            </div>
          ` : ''}
        </div>
        
        <div class="mt-4 p-4 bg-amber-50 rounded-lg border border-amber-200">
          <h4 class="font-semibold text-amber-800 mb-2">üí° Pricing Recommendation for Next Month</h4>
          <div class="text-amber-700 space-y-2">
            <p>
              <strong>Current Status:</strong> You're ${isProfitable ? 'making a profit of' : 'losing'} 
              <strong class="${isProfitable ? 'text-green-700' : 'text-red-700'}">${currency}${Math.abs(profitLossPerUnit).toFixed(2)}</strong> 
              per ${product.unit || 'unit'} (${profitMargin >= 0 ? '+' : ''}${profitMargin.toFixed(1)}% margin).
            </p>
            <p>
              <strong>Suggested Selling Price:</strong> Based on your average cost of 
              <strong>${currency}${avgCostPerUnit.toFixed(2)}</strong> per ${product.unit || 'unit'}:
            </p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-2">
              <div class="bg-white p-3 rounded border border-orange-200">
                <div class="text-xs text-orange-600 font-semibold mb-1">Conservative (20%)</div>
                <div class="text-lg font-bold text-orange-700">${currency}${(avgCostPerUnit * 1.2).toFixed(2)}</div>
                <div class="text-xs text-slate-600">Profit: ${currency}${(avgCostPerUnit * 0.2).toFixed(2)}</div>
              </div>
              <div class="bg-white p-3 rounded border border-green-300 border-2">
                <div class="text-xs text-green-600 font-semibold mb-1">Standard (30%) ‚≠ê</div>
                <div class="text-lg font-bold text-green-700">${currency}${(avgCostPerUnit * 1.3).toFixed(2)}</div>
                <div class="text-xs text-slate-600">Profit: ${currency}${(avgCostPerUnit * 0.3).toFixed(2)}</div>
              </div>
              <div class="bg-white p-3 rounded border border-blue-200">
                <div class="text-xs text-blue-600 font-semibold mb-1">Premium (50%)</div>
                <div class="text-lg font-bold text-blue-700">${currency}${(avgCostPerUnit * 1.5).toFixed(2)}</div>
                <div class="text-xs text-slate-600">Profit: ${currency}${(avgCostPerUnit * 0.5).toFixed(2)}</div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderInvestments() {
      const currency = getCurrency();
      const allInvestments = getFilteredData(getInvestments(), 'INVESTMENTS');
      const investments = allInvestments.filter(d => investmentsView === 'investments' ? d.type === 'investment' : d.type === 'household');
      const tbody = document.getElementById('investments-table');
      const thead = document.getElementById('investments-table-header');

      // Update table headers based on view
      if (investmentsView === 'investments') {
        thead.innerHTML = `
          <tr>
            <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Product</th>
            <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Quantity</th>
            <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Cost</th>
            <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Transport</th>
            <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Total</th>
            <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Date</th>
            <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Place</th>
            <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Actions</th>
          </tr>
        `;
      } else {
        thead.innerHTML = `
          <tr>
            <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Category</th>
            <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Description</th>
            <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Amount</th>
            <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Date</th>
            <th class="text-left px-4 py-3 text-sm font-semibold text-slate-600">Actions</th>
          </tr>
        `;
      }

      if (investments.length === 0) {
        const colspan = investmentsView === 'investments' ? 8 : 5;
        tbody.innerHTML = `<tr><td colspan="${colspan}" class="text-center py-8 text-slate-500">No records found.</td></tr>`;
        return;
      }

      if (investmentsView === 'investments') {
        tbody.innerHTML = investments.map(inv => `
        <tr class="table-row border-b border-slate-100">
          <td class="px-4 py-3 font-medium">${escapeHtml(inv.name || '')}</td>
          <td class="px-4 py-3">${inv.quantity || 0} ${escapeHtml(inv.unit || '')}</td>
          <td class="px-4 py-3 font-semibold text-slate-700">${currency}${(inv.cost_base || 0).toLocaleString()}</td>
          <td class="px-4 py-3 font-semibold text-slate-700">${currency}${(inv.transport_charge || 0).toLocaleString()}</td>
          <td class="px-4 py-3 font-semibold text-slate-700">${currency}${(inv.cost || ((inv.cost_base || 0) + (inv.transport_charge || 0))).toLocaleString()}</td>
          <td class="px-4 py-3 text-slate-600">${formatDate(inv.date)}</td>
          <td class="px-4 py-3 text-slate-600">${escapeHtml(inv.place || '-')}</td>
          <td class="px-4 py-3">
            <div class="flex gap-2">
              <button onclick="editItem('${inv.__backendId}', 'investment')" class="text-blue-600 hover:text-blue-800 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
              </button>
              <button onclick="deleteItem('${inv.__backendId}')" class="text-red-600 hover:text-red-800 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
              </button>
            </div>
          </td>
        </tr>
      `).join('');
      } else {
        // households view
        tbody.innerHTML = investments.map(h => `
        <tr class="table-row border-b border-slate-100">
          <td class="px-4 py-3 font-medium">${escapeHtml(h.category || 'Household')}</td>
          <td class="px-4 py-3">${escapeHtml(h.description || '-')}</td>
          <td class="px-4 py-3 font-semibold text-slate-700">${currency}${(h.cost || 0).toLocaleString()}</td>
          <td class="px-4 py-3 text-slate-600">${formatDate(h.date)}</td>
          <td class="px-4 py-3">
            <div class="flex gap-2">
              <button onclick="editItem('${h.__backendId}', 'household')" class="text-blue-600 hover:text-blue-800 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
              </button>
              <button onclick="deleteItem('${h.__backendId}')" class="text-red-600 hover:text-red-800 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
              </button>
            </div>
          </td>
        </tr>
      `).join('');
      }
    }

    function renderWorkload() {
      const sales = getSales().filter(s => (s.pending_balance || 0) > 0);
      const currency = getCurrency();

      // Group by due date
      const workloadByDate = {};
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      sales.forEach(sale => {
        if (sale.payment_due_date) {
          const dueDate = sale.payment_due_date;
          if (!workloadByDate[dueDate]) {
            workloadByDate[dueDate] = { orders: [], totalPending: 0, totalQuantity: 0 };
          }
          workloadByDate[dueDate].orders.push(sale);
          workloadByDate[dueDate].totalPending += sale.pending_balance || 0;
          workloadByDate[dueDate].totalQuantity += sale.quantity || 0;
        }
      });

      const workloadContainer = document.getElementById('workload-prediction');
      const upcomingContainer = document.getElementById('upcoming-dues');

      const sortedDates = Object.keys(workloadByDate).sort();

      if (sortedDates.length === 0) {
        workloadContainer.innerHTML = '<p class="text-slate-500 text-center py-8">No pending orders to analyze.</p>';
        upcomingContainer.innerHTML = '<p class="text-slate-500 text-center py-8">No upcoming payment due dates.</p>';
        return;
      }

      // Workload prediction
      let totalPendingOrders = sales.length;
      let daysWithWork = sortedDates.length;
      let avgOrdersPerDay = daysWithWork > 0 ? Math.ceil(totalPendingOrders / daysWithWork) : 0;

      workloadContainer.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div class="bg-blue-50 rounded-lg p-4 text-center">
            <div class="text-3xl font-bold text-blue-600">${totalPendingOrders}</div>
            <div class="text-sm text-blue-700">Pending Orders</div>
          </div>
          <div class="bg-amber-50 rounded-lg p-4 text-center">
            <div class="text-3xl font-bold text-amber-600">${daysWithWork}</div>
            <div class="text-sm text-amber-700">Days with Deadlines</div>
          </div>
          <div class="bg-green-50 rounded-lg p-4 text-center">
            <div class="text-3xl font-bold text-green-600">~${avgOrdersPerDay}</div>
            <div class="text-sm text-green-700">Avg Orders/Day</div>
          </div>
        </div>
        <div class="bg-slate-50 rounded-lg p-4">
          <h4 class="font-semibold mb-3">üìä Workload Distribution by Due Date</h4>
          <div class="space-y-3">
            ${sortedDates.map(date => {
        const data = workloadByDate[date];
        const isOverdue = new Date(date) < today;
        const isToday = new Date(date).toDateString() === today.toDateString();
        return `
                <div class="flex items-center gap-3 ${isOverdue ? 'bg-red-100 rounded p-2' : isToday ? 'bg-amber-100 rounded p-2' : ''}">
                  <div class="w-24 text-sm font-medium ${isOverdue ? 'text-red-700' : isToday ? 'text-amber-700' : 'text-slate-600'}">
                    ${formatDate(date)}
                    ${isOverdue ? '<span class="text-xs">(Overdue)</span>' : ''}
                    ${isToday ? '<span class="text-xs">(Today)</span>' : ''}
                  </div>
                  <div class="flex-1 bg-slate-200 rounded-full h-4 overflow-hidden">
                    <div class="h-full ${isOverdue ? 'bg-red-500' : isToday ? 'bg-amber-500' : 'bg-blue-500'}" style="width: ${Math.min(100, data.orders.length * 20)}%"></div>
                  </div>
                  <div class="text-sm font-medium w-32 text-right">
                    ${data.orders.length} orders
                  </div>
                </div>
              `;
      }).join('')}
          </div>
        </div>
      `;

      // Upcoming dues
      upcomingContainer.innerHTML = sortedDates.slice(0, 10).map(date => {
        const data = workloadByDate[date];
        const isOverdue = new Date(date) < today;
        const isToday = new Date(date).toDateString() === today.toDateString();

        return `
          <div class="flex items-center justify-between p-3 rounded-lg ${isOverdue ? 'bg-red-50 border border-red-200' : isToday ? 'bg-amber-50 border border-amber-200' : 'bg-slate-50'}">
            <div>
              <div class="font-medium ${isOverdue ? 'text-red-700' : isToday ? 'text-amber-700' : 'text-slate-800'}">
                ${formatDate(date)} ${isOverdue ? '‚ö†Ô∏è Overdue' : isToday ? 'üìå Today' : ''}
              </div>
              <div class="text-sm text-slate-600">${data.orders.length} customer(s) - ${data.orders.map(o => o.customer_name || 'Unknown').join(', ')}</div>
            </div>
            <div class="text-right">
              <div class="font-bold ${isOverdue ? 'text-red-600' : 'text-slate-800'}">${currency}${data.totalPending.toLocaleString()}</div>
              <div class="text-xs text-slate-500">to collect</div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Modal Functions
    function openModal(type, item = null) {
      currentModalType = type;
      editingItem = item;

      const modal = document.getElementById('modal');
      const title = document.getElementById('modal-title');
      const fields = document.getElementById('modal-fields');
      const submitBtn = document.getElementById('modal-submit');
      const cancelBtn = document.querySelector('#modal-form button[onclick="closeModal()"]');

      // Reset button visibility and text
      submitBtn.style.display = 'block';
      cancelBtn.textContent = 'Cancel';

      if (type === 'investment') {
        title.textContent = item ? 'Edit Investment' : 'Add Investment';
        fields.innerHTML = getInvestmentFields(item);
        // wire live total preview
        attachInvestmentPreviewListeners();
      } else if (type === 'sale') {
        title.textContent = item ? 'Edit Sale' : 'Add Sale';
        fields.innerHTML = getSaleFields(item);
      } else if (type === 'product') {
        title.textContent = item ? 'Edit Product' : 'Add Product';
        fields.innerHTML = getProductFields(item);
      } else if (type === 'household') {
        title.textContent = item ? 'Edit Household' : 'Add Household';
        fields.innerHTML = getHouseholdFields(item);
        // Show wage calculator if Worker Wages is selected
        setTimeout(toggleWageCalculator, 0);
      } else if (type === 'order') {
        title.textContent = item ? 'Edit Order' : 'Add Order';
        fields.innerHTML = getOrderFields(item);
        // Initialize totals for multi-product orders
        setTimeout(() => {
          if (item && item.products) {
            // Calculate totals for each product
            item.products.forEach((prod, idx) => {
              calculateProductTotal(idx);
            });
          }
          calculateOrderGrandTotal();
        }, 0);
      } else if (type === 'production') {
        title.textContent = item ? 'Edit Production' : 'Add Production';
        fields.innerHTML = getProductionFields(item);
      } else if (type === 'master_worker') {
        title.textContent = item ? 'Edit Worker' : 'Add Worker';
        fields.innerHTML = getMasterWorkerFields(item);
      } else if (type === 'worker') {
        title.textContent = item ? 'Edit Daily Production' : 'Add Daily Production';
        fields.innerHTML = getWorkerFields(item);
        // Initialize wage preview
        setTimeout(() => {
          calculateWorkerWage();
          if (item) calculateWorkerProductivity();
        }, 0);
      } else if (type === 'roll') {
        title.textContent = item ? 'Edit Roll' : 'Add Roll Stock';
        fields.innerHTML = getRollFields(item);
        // Calculate total cost on load if editing
        setTimeout(() => {
          if (item) {
            calculateRollTotalCost();
          } else {
            // For new rolls, initialize current stock from weight
            updateCurrentStock();
          }
        }, 0);
      }

      modal.classList.remove('hidden');
    }

    // Wage Calculator Functions
    function toggleWageCalculator() {
      const categorySelect = document.getElementById('household-category');
      const calculator = document.getElementById('wage-calculator');
      if (categorySelect && calculator) {
        calculator.style.display = categorySelect.value === 'Worker Wages' ? 'block' : 'none';
      }
    }

    function addWageEntry() {
      const container = document.getElementById('wage-entries');
      const entry = document.createElement('div');
      entry.className = 'flex gap-2';
      entry.innerHTML = `
        <input type="number" class="wage-input input-field flex-1 px-2 py-1 text-sm border border-slate-300 rounded" placeholder="Worker wage" step="0.01">
        <button type="button" onclick="removeWageEntry(this)" class="text-red-600 hover:text-red-800 px-2">‚úï</button>
      `;
      container.appendChild(entry);
    }

    function removeWageEntry(btn) {
      const container = document.getElementById('wage-entries');
      if (container.children.length > 1) {
        btn.parentElement.remove();
      }
    }

    function calculateTotalWages() {
      const inputs = document.querySelectorAll('.wage-input');
      let total = 0;
      inputs.forEach(input => {
        const val = parseFloat(input.value) || 0;
        total += val;
      });
      const amountInput = document.getElementById('household-amount');
      if (amountInput) {
        amountInput.value = total.toFixed(2);
      }
    }

    function attachInvestmentPreviewListeners() {
      const form = document.getElementById('modal-form');
      if (!form) return;
      const costInput = form.querySelector('input[name="cost"]');
      const transportInput = form.querySelector('input[name="transport_charge"]');
      const totalInput = form.querySelector('input[name="total_preview"]');
      function update() {
        const base = parseFloat(costInput?.value) || 0;
        const transport = parseFloat(transportInput?.value) || 0;
        if (totalInput) {
          const v = base + transport;
          totalInput.value = v ? v.toFixed(2) : '';
        }
      }
      if (costInput) costInput.oninput = update;
      if (transportInput) transportInput.oninput = update;
      update();
    }

    window.closeModal = function() {
      document.getElementById('modal').classList.add('hidden');
      currentModalType = null;
      editingItem = null;
    }

    function getInvestmentFields(item) {
      const products = getProducts();
      const today = new Date().toISOString().split('T')[0];

      return `
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Product *</label>
            <select name="name" required class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none">
              <option value="">Select product...</option>
              ${products.map(p => `<option value="${escapeHtml(p.name)}" ${item && item.name === p.name ? 'selected' : ''}>${escapeHtml(p.name)}</option>`).join('')}
            </select>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Quantity *</label>
              <input type="number" name="quantity" step="0.01" required value="${item?.quantity || ''}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none" placeholder="10">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Unit *</label>
              <select name="unit" required class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none">
                <option value="kg" ${!item || item.unit === 'kg' ? 'selected' : ''}>Kilograms (kg)</option>
                <option value="pcs" ${item?.unit === 'pcs' ? 'selected' : ''}>Pieces (pcs)</option>
                <option value="rolls" ${item?.unit === 'rolls' ? 'selected' : ''}>Rolls</option>
                <option value="boxes" ${item?.unit === 'boxes' ? 'selected' : ''}>Boxes</option>
                <option value="meters" ${item?.unit === 'meters' ? 'selected' : ''}>Meters (m)</option>
                <option value="liters" ${item?.unit === 'liters' ? 'selected' : ''}>Liters (L)</option>
                <option value="tons" ${item?.unit === 'tons' ? 'selected' : ''}>Tons</option>
              </select>
            </div>
          </div>
          <div class="grid grid-cols-3 gap-3">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Cost (Base) *</label>
              <input type="number" name="cost" step="0.01" required value="${item?.cost_base || item?.cost || ''}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none" placeholder="5000">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Transport Charge</label>
              <input type="number" name="transport_charge" step="0.01" value="${item?.transport_charge || ''}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none" placeholder="200">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Total</label>
              <input type="number" name="total_preview" step="0.01" value="${item ? ((item?.cost_base || 0) + (item?.transport_charge || 0)) : ''}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none bg-slate-50" placeholder="5200" readonly>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Date *</label>
            <input type="date" name="date" required value="${item?.date || today}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Place/Supplier</label>
            <input type="text" name="place" value="${item?.place || ''}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none" placeholder="Local Market">
          </div>
        </div>
      `;
    }

    function getSaleFields(item) {
      const products = getProducts();
      const today = new Date().toISOString().split('T')[0];

      return `
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Product *</label>
            <select name="name" required class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none">
              <option value="">Select product...</option>
              ${products.map(p => `<option value="${escapeHtml(p.name)}" ${item && item.name === p.name ? 'selected' : ''}>${escapeHtml(p.name)}</option>`).join('')}
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Customer Name *</label>
            <input type="text" name="customer_name" required value="${item?.customer_name || ''}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none" placeholder="John Doe">
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Quantity *</label>
              <input type="number" name="quantity" step="0.01" required value="${item?.quantity || ''}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none" placeholder="5">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Unit</label>
              <input type="text" name="unit" value="${item?.unit || ''}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none" placeholder="kg">
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Selling Price *</label>
            <input type="number" name="selling_price" step="0.01" required value="${item?.selling_price || ''}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none" placeholder="7500">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Sale Date *</label>
            <input type="date" name="date" required value="${item?.date || today}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none">
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Pending Balance</label>
              <input type="number" name="pending_balance" step="0.01" value="${item?.pending_balance || 0}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none" placeholder="0">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Payment Due Date</label>
              <input type="date" name="payment_due_date" value="${item?.payment_due_date || ''}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none">
            </div>
          </div>
        </div>
      `;
    }

    function getProductFields(item) {
      return `
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Product Name *</label>
            <input type="text" name="name" required value="${item?.name || ''}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none" placeholder="e.g., Paper Bag Small">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Unit Type *</label>
            <select name="unit" id="product-unit-select" onchange="toggleConversionFields()" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none">
              <option value="piece" ${!item || item?.unit === 'piece' ? 'selected' : ''}>Piece</option>
              <option value="kg" ${item?.unit === 'kg' ? 'selected' : ''}>Kilogram (kg)</option>
              <option value="meter" ${item?.unit === 'meter' ? 'selected' : ''}>Meter (m)</option>
              <option value="liter" ${item?.unit === 'liter' ? 'selected' : ''}>Liter (L)</option>
              <option value="box" ${item?.unit === 'box' ? 'selected' : ''}>Box</option>
              <option value="roll" ${item?.unit === 'roll' ? 'selected' : ''}>Roll</option>
            </select>
          </div>
          
          <div id="conversion-section" class="bg-gradient-to-r from-orange-50 to-amber-50 border-2 border-orange-200 rounded-lg p-4" style="display: ${item?.unit && item?.unit !== 'piece' ? 'block' : 'none'}">
            <div class="text-sm font-semibold text-orange-800 mb-3">‚öñÔ∏è Material Conversion</div>
            <p class="text-xs text-orange-700 mb-3">Set conversion rate: How many pieces does this material produce?</p>
            
            <div class="grid grid-cols-2 gap-3 mb-3">
              <div>
                <label class="block text-xs font-medium text-slate-700 mb-1">Material Quantity</label>
                <input type="number" name="material_quantity" step="0.001" value="${item?.material_quantity || ''}" class="input-field w-full px-2 py-1.5 border border-slate-300 rounded text-sm" placeholder="1">
              </div>
              <div>
                <label class="block text-xs font-medium text-slate-700 mb-1">Material Unit</label>
                <select name="material_unit" id="material-unit-select" class="input-field w-full px-2 py-1.5 border border-slate-300 rounded text-sm">
                  <option value="">-- Auto from Unit Type --</option>
                  <option value="kg" ${item?.material_unit === 'kg' ? 'selected' : ''}>Kilograms (kg)</option>
                  <option value="grams" ${item?.material_unit === 'grams' ? 'selected' : ''}>Grams (g)</option>
                  <option value="meters" ${item?.material_unit === 'meters' ? 'selected' : ''}>Meters (m)</option>
                  <option value="liters" ${item?.material_unit === 'liters' ? 'selected' : ''}>Liters (L)</option>
                </select>
              </div>
            </div>
            
            <div class="text-center text-slate-600 text-xl mb-3">=</div>
            
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-xs font-medium text-slate-700 mb-1">Produces Quantity</label>
                <input type="number" name="produces_quantity" step="0.01" value="${item?.produces_quantity || ''}" class="input-field w-full px-2 py-1.5 border border-slate-300 rounded text-sm" placeholder="25">
              </div>
              <div>
                <label class="block text-xs font-medium text-slate-700 mb-1">Product Unit</label>
                <select name="produces_unit" class="input-field w-full px-2 py-1.5 border border-slate-300 rounded text-sm">
                  <option value="pcs" ${!item || item?.produces_unit === 'pcs' ? 'selected' : ''}>Pieces (pcs)</option>
                  <option value="boxes" ${item?.produces_unit === 'boxes' ? 'selected' : ''}>Boxes</option>
                  <option value="rolls" ${item?.produces_unit === 'rolls' ? 'selected' : ''}>Rolls</option>
                </select>
              </div>
            </div>
            
            <div class="mt-3 bg-white border border-orange-300 rounded p-2 text-xs text-slate-600">
              <strong>Example:</strong> If 1 kg of paper produces 25 paper bags:<br>
              ‚Ä¢ Material: 1 kg<br>
              ‚Ä¢ Produces: 25 pcs<br>
              <br>
              This helps track material consumption vs production output.
            </div>
          </div>
          
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm text-blue-700">
            ‚ÑπÔ∏è Dimensions and prices are captured per order, since specifications vary by customer
          </div>
        </div>
      `;
    }

    function toggleConversionFields() {
      const unitSelect = document.getElementById('product-unit-select');
      const conversionSection = document.getElementById('conversion-section');
      const materialUnitSelect = document.getElementById('material-unit-select');

      if (unitSelect && conversionSection) {
        const selectedUnit = unitSelect.value;

        // Show conversion only if unit is NOT piece
        if (selectedUnit === 'piece') {
          conversionSection.style.display = 'none';
        } else {
          conversionSection.style.display = 'block';

          // Auto-set material unit to match selected unit type
          if (materialUnitSelect && !materialUnitSelect.value) {
            materialUnitSelect.value = selectedUnit === 'kg' ? 'kg' :
              selectedUnit === 'meter' ? 'meters' :
                selectedUnit === 'liter' ? 'liters' : '';
          }
        }
      }
    }

    function getOrderFields(item) {
      const products = getProducts();
      const rolls = getRolls().filter(r => (r.current_stock || 0) > 0);
      const today = new Date().toISOString().split('T')[0];

      // For existing orders, show old single-product format
      if (item && !item.products) {
        return getSingleProductOrderFields(item, products, rolls, today);
      }

      // For new orders or multi-product orders, use new format
      const orderProducts = item?.products || [{}];

      return `
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Customer Name *</label>
            <input type="text" name="customer_name" required value="${item?.customer_name || ''}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none" placeholder="John Doe">
          </div>
          
          <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
            <div class="text-sm font-semibold text-purple-800 mb-2">üí∞ Design Charges (One-time fee)</div>
            <input type="number" name="design_charge" id="order-design-charge" step="0.01" value="${item?.design_charge || 0}" oninput="calculateOrderGrandTotal()" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none" placeholder="0">
            <p class="text-xs text-slate-500 mt-1">This charge applies to the entire order, not per product</p>
          </div>

          <div class="bg-slate-50 border border-slate-200 rounded-lg p-3">
            <div class="flex justify-between items-center mb-3">
              <div class="text-sm font-semibold text-slate-800">üì¶ Products in Order</div>
              <button type="button" onclick="addProductToOrder()" class="text-sm bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">+ Add Product</button>
            </div>
            
            <div id="order-products-container" class="space-y-4">
              ${orderProducts.map((prod, idx) => getProductOrderItem(prod, idx, products, rolls)).join('')}
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Issue Date *</label>
              <input type="date" name="issue_date" required value="${item?.issue_date || today}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Delivery Date *</label>
              <input type="date" name="delivery_date" required value="${item?.delivery_date || ''}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none">
            </div>
          </div>

          <div class="bg-green-50 border border-green-200 rounded-lg p-4">
            <div class="text-lg font-bold text-green-800 mb-3">üí∞ Order Summary</div>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-slate-600">Products Total:</span>
                <span class="font-semibold" id="order-products-total">‚Çπ0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-slate-600">Design Charges:</span>
                <span class="font-semibold" id="order-design-total">‚Çπ0</span>
              </div>
              <div class="border-t-2 border-green-300 pt-2 flex justify-between">
                <span class="text-green-800 font-bold">Grand Total:</span>
                <span class="text-xl font-bold text-green-800" id="order-grand-total">‚Çπ0</span>
              </div>
            </div>
            <input type="hidden" name="price" id="order-final-price" value="${item?.price || 0}">
          </div>
          
          <div class="bg-green-50 border border-green-200 rounded-lg p-3">
            <div class="text-sm font-semibold text-green-800 mb-2">üí∞ Payment Details</div>
            <div class="grid gap-3">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Amount Paid (Settled) *</label>
                <input type="number" name="amount_paid" id="order-amount-paid" step="0.01" required value="${item?.amount_paid || 0}" ${item ? 'readonly' : ''} class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none ${item ? 'bg-slate-100 cursor-not-allowed' : ''}" placeholder="0">
                <p class="text-xs text-slate-500 mt-1">${item ? 'Amount is calculated from payment history. Use "Record Payment" button to add payments.' : 'Enter initial amount received from customer'}</p>
              </div>
              ${!item ? `
                <div id="initial-payment-mode" class="${item ? 'hidden' : ''}">
                  <label class="block text-sm font-medium text-slate-700 mb-1">Payment Mode ${item ? '' : '*'}</label>
                  <select name="initial_payment_mode" id="order-payment-mode" onchange="toggleInitialPaymentProof()" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none">
                    <option value="">Select payment mode...</option>
                    <option value="cash">üíµ Cash</option>
                    <option value="phonepay">üì± PhonePe</option>
                    <option value="gpay">üí≥ Google Pay</option>
                    <option value="paytm">üí∞ Paytm</option>
                    <option value="bank">üè¶ Bank Transfer</option>
                  </select>
                </div>
                <div id="initial-payment-proof" class="hidden">
                  <label class="block text-sm font-medium text-slate-700 mb-1">Payment Proof (Optional)</label>
                  <input type="file" id="order-payment-proof" accept="image/*" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none">
                  <div id="order-payment-proof-preview" class="mt-2"></div>
                  <p class="text-xs text-slate-500 mt-1">Upload screenshot of transaction</p>
                </div>
              ` : ''}
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Balance Due Date (Optional)</label>
                <input type="date" name="promised_payment_date" value="${item?.promised_payment_date || ''}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none">
                <p class="text-xs text-slate-500 mt-1">Date when customer promises to pay remaining balance</p>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function getProductOrderItem(prod, idx, products, rolls) {
      return `
        <div class="border-2 border-slate-300 rounded-lg p-3 bg-white" data-product-index="${idx}">
          <div class="flex justify-between items-center mb-2">
            <div class="font-semibold text-slate-700">Product #${idx + 1}</div>
            ${idx > 0 ? `<button type="button" onclick="removeProductFromOrder(${idx})" class="text-red-600 hover:text-red-800 text-sm">‚úï Remove</button>` : ''}
          </div>
          
          <div class="grid grid-cols-2 gap-3 mb-3">
            <div>
              <label class="block text-xs font-medium text-slate-700 mb-1">Product *</label>
              <select name="products[${idx}][product_name]" required class="input-field w-full px-2 py-1.5 text-sm border border-slate-300 rounded">
                <option value="">Select product...</option>
                ${products.map(p => `<option value="${escapeHtml(p.name)}" ${prod.product_name === p.name ? 'selected' : ''}>${escapeHtml(p.name)}</option>`).join('')}
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-slate-700 mb-1">Roll to Use *</label>
              <select name="products[${idx}][roll_id]" required class="input-field w-full px-2 py-1.5 text-sm border border-slate-300 rounded">
                <option value="">Select roll...</option>
                ${rolls.map(r => `<option value="${r.__backendId}" ${prod.roll_id === r.__backendId ? 'selected' : ''}>${escapeHtml(r.roll_name)} (${r.current_stock.toFixed(1)} kg, ${r.width}cm wide)</option>`).join('')}
              </select>
            </div>
          </div>

          <div class="bg-blue-50 border border-blue-200 rounded-lg p-2 mb-2">
            <div class="text-xs font-semibold text-blue-800 mb-1">üìè Product Specifications</div>
            <div class="grid grid-cols-3 gap-2">
              <div>
                <label class="block text-xs text-slate-600 mb-1">Length *</label>
                <input type="number" name="products[${idx}][length]" step="0.1" required value="${prod.length || ''}" class="input-field w-full px-2 py-1 text-sm border border-slate-300 rounded" placeholder="30">
              </div>
              <div>
                <label class="block text-xs text-slate-600 mb-1">Width *</label>
                <input type="number" name="products[${idx}][width]" step="0.1" required value="${prod.width || ''}" class="input-field w-full px-2 py-1 text-sm border border-slate-300 rounded" placeholder="20">
              </div>
              <div>
                <label class="block text-xs text-slate-600 mb-1">Unit *</label>
                <select name="products[${idx}][dimension_unit]" class="input-field w-full px-2 py-1 text-sm border border-slate-300 rounded">
                  <option value="cm" ${!prod.dimension_unit || prod.dimension_unit === 'cm' ? 'selected' : ''}>cm</option>
                  <option value="m" ${prod.dimension_unit === 'm' ? 'selected' : ''}>m</option>
                  <option value="mm" ${prod.dimension_unit === 'mm' ? 'selected' : ''}>mm</option>
                  <option value="inch" ${prod.dimension_unit === 'inch' ? 'selected' : ''}>inch</option>
                  <option value="ft" ${prod.dimension_unit === 'ft' ? 'selected' : ''}>ft</option>
                </select>
              </div>
            </div>
          </div>

          <div class="bg-orange-50 border border-orange-200 rounded-lg p-2 mb-2">
            <div class="text-xs font-semibold text-orange-800 mb-1">‚úÇÔ∏è Cutting Dimensions</div>
            <div class="grid grid-cols-3 gap-2">
              <div>
                <label class="block text-xs text-slate-600 mb-1">Cut Length *</label>
                <input type="number" name="products[${idx}][cutting_length]" step="0.1" required value="${prod.cutting_length || ''}" class="input-field w-full px-2 py-1 text-sm border border-slate-300 rounded" placeholder="32">
              </div>
              <div>
                <label class="block text-xs text-slate-600 mb-1">Cut Width *</label>
                <input type="number" name="products[${idx}][cutting_width]" step="0.1" required value="${prod.cutting_width || ''}" class="input-field w-full px-2 py-1 text-sm border border-slate-300 rounded" placeholder="22">
              </div>
              <div>
                <label class="block text-xs text-slate-600 mb-1">Unit *</label>
                <select name="products[${idx}][cutting_unit]" class="input-field w-full px-2 py-1 text-sm border border-slate-300 rounded">
                  <option value="cm" ${!prod.cutting_unit || prod.cutting_unit === 'cm' ? 'selected' : ''}>cm</option>
                  <option value="m" ${prod.cutting_unit === 'm' ? 'selected' : ''}>m</option>
                  <option value="mm" ${prod.cutting_unit === 'mm' ? 'selected' : ''}>mm</option>
                  <option value="inch" ${prod.cutting_unit === 'inch' ? 'selected' : ''}>inch</option>
                  <option value="ft" ${prod.cutting_unit === 'ft' ? 'selected' : ''}>ft</option>
                </select>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-4 gap-2">
            <div>
              <label class="block text-xs font-medium text-slate-700 mb-1">Quantity *</label>
              <input type="number" name="products[${idx}][quantity]" step="0.01" required value="${prod.quantity || ''}" oninput="calculateProductTotal(${idx})" class="input-field w-full px-2 py-1 text-sm border border-slate-300 rounded" placeholder="1000">
            </div>
            <div>
              <label class="block text-xs font-medium text-slate-700 mb-1">Unit *</label>
              <select name="products[${idx}][quantity_unit]" class="input-field w-full px-2 py-1 text-sm border border-slate-300 rounded">
                <option value="pcs" ${!prod.quantity_unit || prod.quantity_unit === 'pcs' ? 'selected' : ''}>pcs</option>
                <option value="kg" ${prod.quantity_unit === 'kg' ? 'selected' : ''}>kg</option>
                <option value="boxes" ${prod.quantity_unit === 'boxes' ? 'selected' : ''}>boxes</option>
                <option value="meters" ${prod.quantity_unit === 'meters' ? 'selected' : ''}>meters</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-slate-700 mb-1">Price/Unit *</label>
              <input type="number" name="products[${idx}][unit_price]" step="0.01" required value="${prod.unit_price || ''}" oninput="calculateProductTotal(${idx})" class="input-field w-full px-2 py-1 text-sm border border-slate-300 rounded" placeholder="6.5">
            </div>
            <div>
              <label class="block text-xs font-medium text-slate-700 mb-1">Total</label>
              <input type="number" name="products[${idx}][price]" id="product-${idx}-total" step="0.01" readonly value="${prod.price || 0}" class="input-field w-full px-2 py-1 text-sm border border-slate-300 rounded bg-slate-100 cursor-not-allowed">
            </div>
          </div>
        </div>
      `;
    }

    function getSingleProductOrderFields(item, products, rolls, today) {
      // Legacy single-product order format for editing existing orders
      return `
        <div class="space-y-4">
          <div class="bg-amber-50 border border-amber-300 rounded-lg p-3 text-sm text-amber-800">
            ‚ö†Ô∏è This is a legacy single-product order. New orders support multiple products.
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Customer Name *</label>
            <input type="text" name="customer_name" required value="${item?.customer_name || ''}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none" placeholder="John Doe">
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Product *</label>
              <select name="product_name" required class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none">
                <option value="">Select product...</option>
                ${products.map(p => `<option value="${escapeHtml(p.name)}" ${item && item.product_name === p.name ? 'selected' : ''}>${escapeHtml(p.name)}</option>`).join('')}
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Roll to Use *</label>
              <select name="roll_id" required class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none">
                <option value="">Select roll...</option>
                ${rolls.map(r => `<option value="${r.__backendId}" ${item && item.roll_id === r.__backendId ? 'selected' : ''}>${escapeHtml(r.roll_name)} (${r.current_stock.toFixed(1)} kg left, ${r.width}cm wide)</option>`).join('')}
              </select>
            </div>
          </div>
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
            <div class="text-sm font-semibold text-blue-800 mb-2">üìè Product Specifications</div>
            <div class="grid grid-cols-3 gap-3 mb-2">
              <div>
                <label class="block text-xs text-slate-600 mb-1">Desired Length *</label>
                <input type="number" name="length" step="0.1" required value="${item?.length || ''}" class="input-field w-full px-2 py-1.5 border border-slate-300 rounded" placeholder="30">
              </div>
              <div>
                <label class="block text-xs text-slate-600 mb-1">Desired Width *</label>
                <input type="number" name="width" step="0.1" required value="${item?.width || ''}" class="input-field w-full px-2 py-1.5 border border-slate-300 rounded" placeholder="20">
              </div>
              <div>
                <label class="block text-xs text-slate-600 mb-1">Unit *</label>
                <select name="dimension_unit" class="input-field w-full px-2 py-1.5 border border-slate-300 rounded text-sm">
                  <option value="cm" ${!item || item.dimension_unit === 'cm' ? 'selected' : ''}>cm</option>
                  <option value="m" ${item?.dimension_unit === 'm' ? 'selected' : ''}>m</option>
                  <option value="mm" ${item?.dimension_unit === 'mm' ? 'selected' : ''}>mm</option>
                  <option value="inch" ${item?.dimension_unit === 'inch' ? 'selected' : ''}>inch</option>
                  <option value="ft" ${item?.dimension_unit === 'ft' ? 'selected' : ''}>ft</option>
                </select>
              </div>
            </div>
            <div class="text-xs text-slate-500">Final product dimensions</div>
          </div>
          <div class="bg-orange-50 border border-orange-200 rounded-lg p-3">
            <div class="text-sm font-semibold text-orange-800 mb-2">‚úÇÔ∏è Cutting Dimensions (for Wastage Calculation)</div>
            <div class="grid grid-cols-3 gap-3 mb-2">
              <div>
                <label class="block text-xs text-slate-600 mb-1">Cutting Length *</label>
                <input type="number" name="cutting_length" step="0.1" required value="${item?.cutting_length || ''}" class="input-field w-full px-2 py-1.5 border border-slate-300 rounded" placeholder="32">
              </div>
              <div>
                <label class="block text-xs text-slate-600 mb-1">Cutting Width *</label>
                <input type="number" name="cutting_width" step="0.1" required value="${item?.cutting_width || ''}" class="input-field w-full px-2 py-1.5 border border-slate-300 rounded" placeholder="22">
              </div>
              <div>
                <label class="block text-xs text-slate-600 mb-1">Unit *</label>
                <select name="cutting_unit" class="input-field w-full px-2 py-1.5 border border-slate-300 rounded text-sm">
                  <option value="cm" ${!item || item.cutting_unit === 'cm' ? 'selected' : ''}>cm</option>
                  <option value="m" ${item?.cutting_unit === 'm' ? 'selected' : ''}>m</option>
                  <option value="mm" ${item?.cutting_unit === 'mm' ? 'selected' : ''}>mm</option>
                  <option value="inch" ${item?.cutting_unit === 'inch' ? 'selected' : ''}>inch</option>
                  <option value="ft" ${item?.cutting_unit === 'ft' ? 'selected' : ''}>ft</option>
                </select>
              </div>
            </div>
            <div class="text-xs text-slate-500">Actual size to cut from roll (includes trim/wastage margin)</div>
          </div>
          <div class="grid grid-cols-4 gap-3">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Quantity *</label>
              <input type="number" name="quantity" id="order-quantity" step="0.01" required value="${item?.quantity || ''}" oninput="calculateOrderTotal()" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none" placeholder="1000">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Unit *</label>
              <select name="quantity_unit" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none">
                <option value="pcs" ${!item || item.quantity_unit === 'pcs' ? 'selected' : ''}>Pieces (pcs)</option>
                <option value="kg" ${item?.quantity_unit === 'kg' ? 'selected' : ''}>Kilograms (kg)</option>
                <option value="boxes" ${item?.quantity_unit === 'boxes' ? 'selected' : ''}>Boxes</option>
                <option value="rolls" ${item?.quantity_unit === 'rolls' ? 'selected' : ''}>Rolls</option>
                <option value="meters" ${item?.quantity_unit === 'meters' ? 'selected' : ''}>Meters (m)</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">PricePerUnit*</label>
              <input type="number" name="unit_price" id="order-unit-price" step="0.01" required value="${item?.unit_price || item?.price && item?.quantity ? (item.price / item.quantity).toFixed(2) : ''}" oninput="calculateOrderTotal()" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none" placeholder="6.5">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Total Price *</label>
              <input type="number" name="price" id="order-total-price" step="0.01" required value="${item?.price || ''}" readonly class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none bg-slate-100 cursor-not-allowed" placeholder="0">
            </div>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Issue Date *</label>
              <input type="date" name="issue_date" required value="${item?.issue_date || today}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Delivery Date *</label>
              <input type="date" name="delivery_date" required value="${item?.delivery_date || ''}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none">
            </div>
          </div>
          <div class="bg-green-50 border border-green-200 rounded-lg p-3">
            <div class="text-sm font-semibold text-green-800 mb-2">üí∞ Payment Details</div>
            <div class="grid gap-3">
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Amount Paid (Settled) *</label>
                <input type="number" name="amount_paid" id="order-amount-paid" step="0.01" required value="${item?.amount_paid || 0}" ${item ? 'readonly' : 'oninput="toggleInitialPaymentMode()"'} class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none ${item ? 'bg-slate-100 cursor-not-allowed' : ''}" placeholder="0">
                <p class="text-xs text-slate-500 mt-1">${item ? 'Amount is calculated from payment history. Use "Record Payment" button to add payments.' : 'Enter initial amount received from customer'}</p>
              </div>
              ${!item ? `
                <div id="initial-payment-mode" class="hidden">
                  <label class="block text-sm font-medium text-slate-700 mb-1">Payment Mode *</label>
                  <select name="initial_payment_mode" id="order-payment-mode" onchange="toggleInitialPaymentProof()" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none">
                    <option value="">Select payment mode...</option>
                    <option value="cash">üíµ Cash</option>
                    <option value="phonepay">üì± PhonePe</option>
                    <option value="gpay">üí≥ Google Pay</option>
                    <option value="paytm">üí∞ Paytm</option>
                    <option value="bank">üè¶ Bank Transfer</option>
                  </select>
                </div>
                <div id="initial-payment-proof" class="hidden">
                  <label class="block text-sm font-medium text-slate-700 mb-1">Payment Proof (Optional)</label>
                  <input type="file" id="order-payment-proof" accept="image/*" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none">
                  <div id="order-payment-proof-preview" class="mt-2"></div>
                  <p class="text-xs text-slate-500 mt-1">Upload screenshot of transaction</p>
                </div>
              ` : ''}
              <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Balance Due Date (Optional)</label>
                <input type="date" name="promised_payment_date" value="${item?.promised_payment_date || ''}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none">
                <p class="text-xs text-slate-500 mt-1">Date when customer promises to pay remaining balance</p>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function getProductionFields(item) {
      const products = getProducts();
      const today = new Date().toISOString().split('T')[0];

      // Calculate average wastage from historical data
      const production = getProduction();
      const avgWastage = production.length > 0
        ? production.reduce((sum, p) => sum + (p.wastage_percent || 0), 0) / production.length
        : 5;

      return `
        <div class="space-y-4">
          ${production.length > 0 ? `
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
              <div class="text-sm text-blue-800">
                üí° <strong>Historical Average:</strong> Wastage ${avgWastage.toFixed(1)}% | 
                ${avgWastage > 10 ? '<span class="text-amber-600 font-semibold">‚ö†Ô∏è Consider reducing wastage</span>' : '<span class="text-green-600">‚úì Good control</span>'}
              </div>
            </div>
          ` : ''}
          
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Product *</label>
            <select name="product_name" required class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none">
              <option value="">Select product...</option>
              ${products.map(p => `<option value="${escapeHtml(p.name)}" ${item && item.product_name === p.name ? 'selected' : ''}>${escapeHtml(p.name)}</option>`).join('')}
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Units Produced *</label>
            <input type="number" name="units_produced" step="0.01" required value="${item?.units_produced || ''}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none" placeholder="1000">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Raw Material Cost *</label>
            <input type="number" id="raw-material-cost" name="raw_material_cost" step="0.01" required value="${item?.raw_material_cost || ''}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none" placeholder="5000" oninput="calculateProductionCost()">
            <p class="text-xs text-slate-500 mt-1">Total cost of raw materials used</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Wastage % *</label>
            <input type="number" id="wastage-percent" name="wastage_percent" step="0.1" required value="${item?.wastage_percent || 0}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none" placeholder="5" oninput="calculateProductionCost()">
            <p class="text-xs text-slate-500 mt-1">Percentage of material wasted</p>
          </div>
          <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
            <div class="text-sm text-purple-700 mb-1">Total Production Cost (including wastage)</div>
            <div class="text-2xl font-bold text-purple-800" id="production-cost-preview">‚Çπ0</div>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Production Date *</label>
            <input type="date" name="date" required value="${item?.date || today}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Notes</label>
            <textarea name="notes" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none" rows="2" placeholder="Any additional details...">${item?.notes || ''}</textarea>
          </div>
        </div>
      `;
    }

    function getMasterWorkerFields(item) {
      return `
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Worker Name *</label>
            <input type="text" name="name" required value="${item?.name || ''}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none" placeholder="e.g., Rajesh Kumar">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Contact Number</label>
            <input type="tel" name="contact" value="${item?.contact || ''}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none" placeholder="e.g., 9876543210">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Monthly Wage *</label>
            <input type="number" name="monthly_wage" step="0.01" required value="${item?.monthly_wage || ''}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none" placeholder="15000">
            <p class="text-xs text-slate-500 mt-1">Fixed monthly salary. Paid leaves are set globally in Attendance tab.</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Notes</label>
            <textarea name="notes" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none" rows="2" placeholder="Any additional details...">${item?.notes || ''}</textarea>
          </div>
        </div>
      `;
    }

    function getWorkerFields(item) {
      const today = new Date().toISOString().split('T')[0];
      const allWorkers = getMasterWorkers();

      // If item has worker_id, find that worker
      let selectedWorker = null;
      if (item?.worker_id) {
        selectedWorker = allWorkers.find(w => w.__backendId === item.worker_id);
      }

      // Calculate smart suggestions
      const suggestions = calculateWorkerSuggestions();

      return `
        <div class="space-y-4">
          ${suggestions.hasSuggestions ? `
            <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg p-4 mb-4">
              <div class="flex items-start gap-3">
                <svg class="w-6 h-6 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                <div class="flex-1">
                  <div class="font-bold mb-2">üéØ Team Production Targets</div>
                  <div class="text-sm space-y-1 opacity-90">
                    ${suggestions.recommendations.map(rec => `
                      <div>‚Ä¢ <strong>${rec.product}</strong>: ${rec.dailyTarget} units/day total | <strong>${rec.perWorkerTarget} units/worker</strong> (${rec.totalWorkers} workers) | ${rec.remainingDays} days left</div>
                    `).join('')}
                  </div>
                  ${suggestions.averageProductivity > 0 ? `
                    <div class="text-xs mt-2 opacity-75">Team average: ${suggestions.averageProductivity.toFixed(1)} units/hour per worker</div>
                  ` : ''}
                </div>
              </div>
            </div>
          ` : ''}
          
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Worker Name *</label>
            ${allWorkers.length > 0 ? `
              <select name="worker_name" required class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none" onchange="calculateWorkerWage()">
                <option value="">-- Select worker --</option>
                ${allWorkers.map(w => {
        const isSelected = (selectedWorker && w.__backendId === selectedWorker.__backendId) || (item && item.worker_name === w.name);
        return `<option value="${escapeHtml(w.name)}" data-monthly-wage="${w.monthly_wage || 0}" ${isSelected ? 'selected' : ''}>${escapeHtml(w.name)} (‚Çπ${w.monthly_wage || 0}/month)</option>`;
      }).join('')}
              </select>
              <p class="text-xs text-slate-500 mt-1">Select worker to add production</p>
            ` : `
              <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 text-sm text-amber-700">
                ‚ö†Ô∏è No workers registered yet. Please add workers first using the "Add Worker" button above.
              </div>
            `}
          </div>
          
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Order (Optional)</label>
            <select id="worker-order-select" name="order_id" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none" onchange="handleOrderSelection()">
              <option value="">Select order...</option>
              ${getOrders().filter(o => !o.settled).map(o => {
        const orderDate = new Date(o.issue_date).toLocaleDateString();
        return `<option value="${o.__backendId}" data-product="${escapeHtml(o.product_name)}" data-length="${o.length || ''}" data-width="${o.width || ''}" data-cutting-length="${o.cutting_length || o.length || ''}" data-cutting-width="${o.cutting_width || o.width || ''}" ${item && item.order_id === o.__backendId ? 'selected' : ''}>${escapeHtml(o.customer_name)} - ${escapeHtml(o.product_name)} (${o.quantity} units) - ${orderDate}</option>`;
      }).join('')}
              <option value="other" ${item && item.background_work ? 'selected' : ''}>Other (Background Work)</option>
            </select>
          </div>
          
          <div id="background-work-container" style="display: ${item && item.background_work ? 'block' : 'none'};">
            <label class="block text-sm font-medium text-slate-700 mb-1">Background Work / Task Description *</label>
            <input type="text" id="background-work-input" name="background_work" value="${item?.background_work || ''}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none" placeholder="e.g., Machine maintenance, Quality check, Preparation work">
            <p class="text-xs text-slate-500 mt-1">Describe the background work or task</p>
          </div>
          
          <input type="hidden" id="worker-product-input" name="product_name" value="${item?.product_name || ''}">
          <input type="hidden" id="order-length" value="${item?.order_length || ''}">
          <input type="hidden" id="order-width" value="${item?.order_width || ''}">
          
          <div class="bg-gradient-to-r from-green-50 to-teal-50 border-2 border-green-200 rounded-lg p-4">
            <div class="text-sm font-semibold text-green-800 mb-3">üìú Roll Usage (Optional)</div>
            <p class="text-xs text-green-700 mb-3">Track which paper roll was used for this production</p>
            
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-xs font-medium text-slate-700 mb-1">Select Roll</label>
                <select name="roll_id" id="worker-roll-select" class="input-field w-full px-2 py-1.5 border border-slate-300 rounded text-sm" onchange="calculateRollUsage()">
                  <option value="">-- No roll tracking --</option>
                  ${getRolls().filter(r => r.current_stock > 0).map(r => {
        const isSelected = item && item.roll_id === r.__backendId;
        return `<option value="${r.__backendId}" data-width="${r.width}" ${isSelected ? 'selected' : ''}>${escapeHtml(r.roll_name)} (${r.current_stock.toFixed(1)} kg left, ${r.width}cm wide)</option>`;
      }).join('')}
                </select>
              </div>
              <div>
                <label class="block text-xs font-medium text-slate-700 mb-1">Material Used (kg)</label>
                <input type="number" name="roll_usage_kg" id="roll-usage-kg" step="0.001" value="${item?.roll_usage_kg || ''}" class="input-field w-full px-2 py-1.5 border border-slate-300 rounded text-sm" placeholder="Auto-calculated">
                <p class="text-xs text-slate-500 mt-1">Weight of material consumed</p>
              </div>
            </div>
            
            <div id="roll-usage-preview" class="mt-3 bg-white border border-green-300 rounded p-2 text-xs text-slate-600 hidden">
              <strong>Estimated usage:</strong> <span id="roll-usage-text"></span>
            </div>
          </div>
          
          <div class="grid grid-cols-3 gap-3">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Units Produced *</label>
              <input type="number" id="worker-units" name="units_produced" step="0.01" required value="${item?.units_produced || ''}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none" placeholder="500">
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Unit Type</label>
              <select name="production_unit" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none">
                <option value="pcs" ${!item || item.production_unit === 'pcs' ? 'selected' : ''}>Pieces (pcs)</option>
                <option value="kg" ${item?.production_unit === 'kg' ? 'selected' : ''}>Kilograms (kg)</option>
                <option value="meters" ${item?.production_unit === 'meters' ? 'selected' : ''}>Meters (m)</option>
                <option value="rolls" ${item?.production_unit === 'rolls' ? 'selected' : ''}>Rolls</option>
                <option value="boxes" ${item?.production_unit === 'boxes' ? 'selected' : ''}>Boxes</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Hours Worked *</label>
              <input type="number" id="worker-hours" name="hours_worked" step="0.5" required value="${item?.hours_worked || ''}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none" placeholder="8" oninput="calculateWorkerProductivity()">
            </div>
          </div>
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
            <div class="text-sm text-blue-700 mb-1">Productivity</div>
            <div class="text-2xl font-bold text-blue-800" id="worker-productivity-preview">0 units/hour</div>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Work Date *</label>
            <input type="date" name="date" required value="${item?.date || today}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none">
          </div>
        </div>
      `;
    }

    function handleOrderSelection() {
      const orderSelect = document.getElementById('worker-order-select');
      const selectedOption = orderSelect.options[orderSelect.selectedIndex];
      const productInput = document.getElementById('worker-product-input');
      const lengthInput = document.getElementById('order-length');
      const widthInput = document.getElementById('order-width');
      const backgroundWorkContainer = document.getElementById('background-work-container');
      const backgroundWorkInput = document.getElementById('background-work-input');

      // Check if "Other" is selected
      if (selectedOption && selectedOption.value === 'other') {
        // Show background work field and make it required
        backgroundWorkContainer.style.display = 'block';
        if (backgroundWorkInput) {
          backgroundWorkInput.required = true;
        }
        // Clear product selection
        productInput.value = '';
        lengthInput.value = '';
        widthInput.value = '';
      } else {
        // Hide background work field and make it not required
        backgroundWorkContainer.style.display = 'none';
        if (backgroundWorkInput) {
          backgroundWorkInput.required = false;
          backgroundWorkInput.value = ''; // Clear the value
        }

        // If an actual order is selected, populate product details
        if (selectedOption && selectedOption.value) {
          productInput.value = selectedOption.dataset.product || '';
          lengthInput.value = selectedOption.dataset.length || '';
          widthInput.value = selectedOption.dataset.width || '';
        }
      }

      calculateSmartWastage();
    }

    function calculateSmartWastage() {
      const lengthInput = document.getElementById('order-length');
      const widthInput = document.getElementById('order-width');
      const rollSelect = document.getElementById('worker-roll-select');
      const unitsInput = document.getElementById('worker-units');
      const wastageBox = document.getElementById('wastage-calculation-box');
      const wastageDetails = document.getElementById('wastage-details');
      const hiddenWastage = document.getElementById('calculated-wastage');
      const hiddenMaterialUsed = document.getElementById('material-used-kg');

      if (!lengthInput || !widthInput || !rollSelect || !unitsInput || !wastageBox) return;

      const length = parseFloat(lengthInput.value) || 0;
      const width = parseFloat(widthInput.value) || 0;
      const rollId = rollSelect.value;
      const units = parseFloat(unitsInput.value) || 0;

      // Get cutting dimensions from the selected order
      const orderSelect = document.getElementById('production-order');
      const selectedOption = orderSelect?.options[orderSelect.selectedIndex];
      const cuttingLength = selectedOption ? parseFloat(selectedOption.getAttribute('data-cutting-length')) || length : length;
      const cuttingWidth = selectedOption ? parseFloat(selectedOption.getAttribute('data-cutting-width')) || width : width;

      if (!length || !width || !rollId || units === 0) {
        wastageBox.classList.add('hidden');
        return;
      }

      // Get roll details
      const rolls = getRolls();
      const roll = rolls.find(r => r.__backendId === rollId);
      if (!roll) {
        wastageBox.classList.add('hidden');
        return;
      }

      // Calculate areas (all in cm¬≤)
      const productArea = length * width; // cm¬≤ (desired product)
      const rollWidth = roll.width; // cm
      const rollLength = roll.length * 100; // convert meters to cm

      // Calculate how many pieces fit across the width (using cutting dimensions)
      const piecesAcrossWidth = Math.floor(rollWidth / cuttingWidth);
      const piecesAlongLength = Math.ceil(units / piecesAcrossWidth);

      // Calculate actual length used (using cutting dimensions)
      const lengthUsed = piecesAlongLength * cuttingLength; // cm
      const actualPiecesFit = piecesAcrossWidth * piecesAlongLength;

      // Calculate areas
      const usedArea = productArea * units; // cm¬≤
      const totalCutArea = rollWidth * lengthUsed; // cm¬≤ (rectangle we cut)
      const wastedArea = totalCutArea - usedArea;
      const wastagePercent = (wastedArea / totalCutArea * 100);

      // Calculate material weight used (simplified: proportional to area)
      // Assuming GSM (grams per square meter)
      const materialUsedM2 = totalCutArea / 10000; // convert cm¬≤ to m¬≤
      const materialUsedKg = (materialUsedM2 * roll.thickness) / 1000; // GSM to kg

      // Update hidden fields
      hiddenWastage.value = wastagePercent.toFixed(2);
      hiddenMaterialUsed.value = materialUsedKg.toFixed(3);

      // Show calculation details
      wastageDetails.innerHTML = `
        <div><strong>Desired Product:</strong> ${length}cm √ó ${width}cm (${productArea.toFixed(0)} cm¬≤ each)</div>
        <div><strong>Cutting Size:</strong> ${cuttingLength}cm √ó ${cuttingWidth}cm</div>
        <div><strong>Roll:</strong> ${rollLength / 100}m √ó ${rollWidth}cm</div>
        <div><strong>Cutting Pattern:</strong> ${piecesAcrossWidth} across √ó ${piecesAlongLength} down = ${actualPiecesFit} pieces possible</div>
        <div><strong>Material Used:</strong> ${lengthUsed.toFixed(1)}cm length √ó ${rollWidth}cm width = ${totalCutArea.toFixed(0)} cm¬≤</div>
        <div><strong>Product Area:</strong> ${usedArea.toFixed(0)} cm¬≤ (${units} units)</div>
        <div class="pt-2 border-t border-purple-300 mt-2">
          <div class="${wastagePercent > 15 ? 'text-red-700 font-bold' : 'text-green-700 font-bold'}">
            <strong>Wastage:</strong> ${wastagePercent.toFixed(2)}% (${wastedArea.toFixed(0)} cm¬≤)
          </div>
          <div><strong>Material Weight:</strong> ${materialUsedKg.toFixed(3)} kg</div>
        </div>
        ${wastagePercent > 15 ? '<div class="text-red-600 text-xs mt-1">‚ö†Ô∏è High wastage! Consider optimizing cutting pattern</div>' : ''}
      `;

      wastageBox.classList.remove('hidden');

      // Also update productivity
      calculateWorkerProductivity();
    }

    function calculateProductionCost() {
      const rawCost = parseFloat(document.getElementById('raw-material-cost')?.value || 0);
      const wastage = parseFloat(document.getElementById('wastage-percent')?.value || 0);
      const totalCost = rawCost * (1 + wastage / 100);
      const preview = document.getElementById('production-cost-preview');
      if (preview) {
        preview.textContent = `${getCurrency()}${totalCost.toFixed(2)}`;
      }
    }

    function calculateWorkerProductivity() {
      const units = parseFloat(document.getElementById('worker-units')?.value || 0);
      const hours = parseFloat(document.getElementById('worker-hours')?.value || 0);
      const productivity = hours > 0 ? (units / hours) : 0;
      const preview = document.getElementById('worker-productivity-preview');
      if (preview) {
        preview.textContent = `${productivity.toFixed(1)} units/hour`;
      }
      calculateRollUsage(); // Also recalculate roll usage when units change
    }

    function calculateRollUsage() {
      const rollSelect = document.getElementById('worker-roll-select');
      const rollUsageInput = document.getElementById('roll-usage-kg');
      const rollUsagePreview = document.getElementById('roll-usage-preview');
      const rollUsageText = document.getElementById('roll-usage-text');

      if (!rollSelect || !rollUsageInput || !rollUsagePreview || !rollUsageText) return;

      const selectedOption = rollSelect.options[rollSelect.selectedIndex];
      const rollWidth = parseFloat(selectedOption?.getAttribute('data-width') || 0);

      if (!rollSelect.value || rollWidth === 0) {
        rollUsagePreview.classList.add('hidden');
        rollUsageInput.value = '';
        return;
      }

      // Get cutting dimensions from order
      const cuttingLength = parseFloat(document.getElementById('order-length')?.value || 0);
      const cuttingWidth = parseFloat(document.getElementById('order-width')?.value || 0);
      const unitsProduced = parseFloat(document.getElementById('worker-units')?.value || 0);

      if (cuttingLength > 0 && cuttingWidth > 0 && unitsProduced > 0) {
        // Calculate total area used (in cm¬≤)
        const areaPerUnit = cuttingLength * cuttingWidth;
        const totalArea = areaPerUnit * unitsProduced;

        // Estimate weight (very rough): assuming ~80 GSM paper, 1m¬≤ ‚âà 80g = 0.08kg
        // Convert cm¬≤ to m¬≤: divide by 10000
        const totalAreaM2 = totalArea / 10000;
        const estimatedWeight = totalAreaM2 * 0.08; // 80 GSM approximation

        rollUsageInput.value = estimatedWeight.toFixed(3);
        rollUsageText.textContent = `${estimatedWeight.toFixed(3)} kg for ${unitsProduced} units (${cuttingLength}√ó${cuttingWidth}cm each)`;
        rollUsagePreview.classList.remove('hidden');
      } else {
        rollUsagePreview.classList.add('hidden');
      }
    }

    function calculateWorkerWage() {
      const workerSelect = document.querySelector('select[name="worker_name"]');
      const selectedOption = workerSelect?.options[workerSelect.selectedIndex];
      const monthlyWage = parseFloat(selectedOption?.getAttribute('data-monthly-wage') || 0);
      const dailyWage = monthlyWage / 26; // 26 working days per month

      const wagePreview = document.getElementById('worker-wage-preview');
      if (wagePreview) {
        wagePreview.textContent = `‚Çπ${dailyWage.toFixed(2)}`;
      }
    }

    function calculateWorkerSuggestions() {
      const orders = getOrders().filter(o => !o.settled && o.delivery_date);
      const production = getProduction();
      const workers = getWorkers();

      if (orders.length === 0) {
        return { hasSuggestions: false, recommendations: [], averageProductivity: 0 };
      }

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // Calculate total unique workers - count only active master workers, not deleted ones
      const activeMasterWorkers = getMasterWorkers(); // Get only existing master workers
      const uniqueWorkers = activeMasterWorkers.length || 1; // Count actual active workers

      // Calculate production needs by product
      const needs = {};
      orders.forEach(order => {
        const product = order.product_name;
        const deliveryDate = new Date(order.delivery_date);
        const daysRemaining = Math.max(1, Math.ceil((deliveryDate - today) / (1000 * 60 * 60 * 24)));

        if (!needs[product]) {
          needs[product] = { required: 0, produced: 0, earliestDays: daysRemaining };
        }
        needs[product].required += order.quantity || 0;
        needs[product].earliestDays = Math.min(needs[product].earliestDays, daysRemaining);
      });

      // Calculate what's been produced
      production.forEach(prod => {
        const product = prod.product_name;
        if (needs[product]) {
          needs[product].produced += prod.units_produced || 0;
        }
      });

      // Calculate average productivity
      const totalHours = workers.reduce((sum, w) => sum + (w.hours_worked || 0), 0);
      const totalOutput = workers.reduce((sum, w) => sum + (w.units_produced || 0), 0);
      const avgProductivity = totalHours > 0 ? totalOutput / totalHours : 5;

      const recommendations = [];
      Object.keys(needs).forEach(product => {
        const data = needs[product];
        const remaining = Math.max(0, data.required - data.produced);
        if (remaining > 0) {
          const dailyTarget = Math.ceil(remaining / data.earliestDays);
          const perWorkerTarget = Math.ceil(dailyTarget / Math.max(1, uniqueWorkers));
          recommendations.push({
            product,
            remaining,
            dailyTarget,
            perWorkerTarget,
            totalWorkers: uniqueWorkers,
            remainingDays: data.earliestDays
          });
        }
      });

      return {
        hasSuggestions: recommendations.length > 0,
        recommendations,
        averageProductivity: avgProductivity
      };
    }

    function handleWorkerSelection() {
      const select = document.getElementById('worker-name-select');
      const input = document.getElementById('worker-name-input');
      if (select && input && select.value) {
        input.value = select.value;
        updateWorkerSuggestions();
      }
    }

    function updateWorkerSuggestions() {
      const workerName = document.getElementById('worker-name-input')?.value;
      const productSelect = document.getElementById('worker-product-input');
      const product = productSelect?.value;

      if (!product) return;

      const suggestions = calculateWorkerSuggestions();
      const box = document.getElementById('worker-suggestion-box');
      const details = document.getElementById('worker-suggestion-details');

      if (!box || !details) return;

      const productRec = suggestions.recommendations.find(r => r.product === product);

      if (productRec) {
        // Get worker's historical performance
        const workers = getWorkers();
        const workerHistory = workers.filter(w => w.worker_name === workerName && w.product_name === product);
        const avgWorkerOutput = workerHistory.length > 0
          ? workerHistory.reduce((sum, w) => sum + (w.units_produced || 0), 0) / workerHistory.length
          : productRec.dailyTarget;

        // Count only active master workers, not deleted ones
        const activeMasterWorkers = getMasterWorkers();
        const uniqueWorkers = activeMasterWorkers.length || 1;
        const perWorkerTarget = Math.ceil(productRec.dailyTarget / Math.max(1, uniqueWorkers));
        const suggestedUnits = workerHistory.length > 0 ? Math.round(avgWorkerOutput) : perWorkerTarget;
        const suggestedHours = suggestions.averageProductivity > 0 ? (suggestedUnits / suggestions.averageProductivity) : 8;

        details.innerHTML = `
          <div class="space-y-1">
            <div><strong>${productRec.product}</strong> needs <strong>${productRec.dailyTarget} units/day</strong></div>
            <div>Your suggested target: <strong>${suggestedUnits} units</strong> in <strong>${suggestedHours.toFixed(1)} hours</strong></div>
            ${workerHistory.length > 0 ? `<div class="text-xs opacity-75">Based on ${workerName}'s average: ${avgWorkerOutput.toFixed(0)} units/day</div>` : ''}
          </div>
        `;

        box.classList.remove('hidden');
        box.dataset.suggestedUnits = suggestedUnits;
        box.dataset.suggestedHours = suggestedHours.toFixed(1);
      } else {
        box.classList.add('hidden');
      }
    }

    function applySuggestedProduction() {
      const box = document.getElementById('worker-suggestion-box');
      const unitsInput = document.getElementById('worker-units');
      const hoursInput = document.getElementById('worker-hours');

      if (box && unitsInput && hoursInput) {
        unitsInput.value = box.dataset.suggestedUnits || '';
        hoursInput.value = box.dataset.suggestedHours || '';
        calculateWorkerProductivity();
      }
    }

    function getHouseholdFields(item) {
      const today = new Date().toISOString().split('T')[0];
      return `
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Category *</label>
            <select id="household-category" name="category" required class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none" onchange="toggleWageCalculator()">
              <option value="">Select category...</option>
              <option value="Powerbill" ${item && item.category === 'Powerbill' ? 'selected' : ''}>Powerbill</option>
              <option value="Worker Wages" ${item && item.category === 'Worker Wages' ? 'selected' : ''}>Worker Wages</option>
              <option value="Maintenance" ${item && item.category === 'Maintenance' ? 'selected' : ''}>Maintenance</option>
              <option value="Other" ${item && item.category === 'Other' ? 'selected' : ''}>Other</option>
            </select>
          </div>
          <div id="wage-calculator" style="display:none;" class="bg-blue-50 border border-blue-200 rounded-lg p-3">
            <div class="text-sm font-semibold text-blue-800 mb-2">üíº Wage Calculator</div>
            <div id="wage-entries" class="space-y-2 mb-2">
              <div class="flex gap-2">
                <input type="number" class="wage-input input-field flex-1 px-2 py-1 text-sm border border-slate-300 rounded" placeholder="Worker 1 wage" step="0.01">
                <button type="button" onclick="removeWageEntry(this)" class="text-red-600 hover:text-red-800 px-2">‚úï</button>
              </div>
            </div>
            <div class="flex gap-2 mb-2">
              <button type="button" onclick="addWageEntry()" class="text-sm bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">+ Add Worker</button>
              <button type="button" onclick="calculateTotalWages()" class="text-sm bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">Calculate Total</button>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Description</label>
            <input type="text" name="description" value="${item?.description || ''}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none" placeholder="Details">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Amount *</label>
            <input id="household-amount" type="number" name="amount" step="0.01" required value="${item?.cost || ''}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none" placeholder="1500">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Date *</label>
            <input type="date" name="date" required value="${item?.date || today}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Place/Note</label>
            <input type="text" name="place" value="${item?.place || ''}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none" placeholder="Office / Vendor">
          </div>
        </div>
      `;
    }

    function getRollFields(item) {
      const today = new Date().toISOString().split('T')[0];
      return `
        <div class="space-y-4">
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
            <div class="text-sm font-semibold text-blue-800 mb-1">üìè Smart Wastage Calculation</div>
            <div class="text-xs text-blue-700">Enter roll dimensions. When products are made, wastage will be automatically calculated based on cutting patterns.</div>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Roll Name *</label>
            <input type="text" name="roll_name" required value="${item?.roll_name || ''}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none" placeholder="e.g., Paper Roll #1">
          </div>
          <div class="bg-amber-50 border border-amber-200 rounded-lg p-3">
            <div class="text-sm font-semibold text-amber-800 mb-2">üí∞ Pricing & Weight</div>
            <div class="grid grid-cols-2 gap-3 mb-2">
              <div>
                <label class="block text-xs text-slate-600 mb-1">Weight (kg) *</label>
                <input type="number" name="roll_weight" id="roll-weight-input" step="0.01" required value="${item?.roll_weight || ''}" onchange="calculateRollTotalCost(); updateCurrentStock();" oninput="updateCurrentStock();" class="input-field w-full px-2 py-1.5 border border-slate-300 rounded" placeholder="500">
              </div>
              <div>
                <label class="block text-xs text-slate-600 mb-1">Cost per kg *</label>
                <input type="number" name="cost_per_kg" id="roll-cost-per-kg" step="0.01" required value="${item?.cost_per_kg || ''}" onchange="calculateRollTotalCost()" class="input-field w-full px-2 py-1.5 border border-slate-300 rounded" placeholder="50">
              </div>
            </div>
            <div class="bg-white border border-amber-300 rounded p-2">
              <div class="text-xs text-slate-600 mb-1">Total Cost</div>
              <div class="text-2xl font-bold text-amber-900" id="roll-total-cost">‚Çπ0</div>
              <input type="hidden" name="cost" id="roll-total-cost-hidden" value="${item?.cost || 0}">
            </div>
          </div>
          <div class="bg-slate-50 border border-slate-200 rounded-lg p-3">
            <div class="text-sm font-semibold text-slate-700 mb-2">Roll Dimensions</div>
            <div class="grid grid-cols-2 gap-3 mb-3">
              <div>
                <label class="block text-xs text-slate-600 mb-1">Length *</label>
                <input type="number" name="length" step="0.01" required value="${item?.length || ''}" class="input-field w-full px-2 py-1.5 border border-slate-300 rounded" placeholder="100">
              </div>
              <div>
                <label class="block text-xs text-slate-600 mb-1">Length Unit *</label>
                <select name="length_unit" class="input-field w-full px-2 py-1.5 border border-slate-300 rounded">
                  <option value="meters" ${!item || item?.length_unit === 'meters' ? 'selected' : ''}>Meters (m)</option>
                  <option value="feet" ${item?.length_unit === 'feet' ? 'selected' : ''}>Feet (ft)</option>
                  <option value="inches" ${item?.length_unit === 'inches' ? 'selected' : ''}>Inches (in)</option>
                  <option value="yards" ${item?.length_unit === 'yards' ? 'selected' : ''}>Yards (yd)</option>
                  <option value="cm" ${item?.length_unit === 'cm' ? 'selected' : ''}>Centimeters (cm)</option>
                </select>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-3">
              <div>
                <label class="block text-xs text-slate-600 mb-1">Width *</label>
                <input type="number" name="width" step="0.1" required value="${item?.width || ''}" class="input-field w-full px-2 py-1.5 border border-slate-300 rounded" placeholder="60">
              </div>
              <div>
                <label class="block text-xs text-slate-600 mb-1">Width Unit *</label>
                <select name="width_unit" class="input-field w-full px-2 py-1.5 border border-slate-300 rounded">
                  <option value="cm" ${!item || item?.width_unit === 'cm' ? 'selected' : ''}>Centimeters (cm)</option>
                  <option value="inches" ${item?.width_unit === 'inches' ? 'selected' : ''}>Inches (in)</option>
                  <option value="feet" ${item?.width_unit === 'feet' ? 'selected' : ''}>Feet (ft)</option>
                  <option value="meters" ${item?.width_unit === 'meters' ? 'selected' : ''}>Meters (m)</option>
                </select>
              </div>
            </div>
            <div>
              <label class="block text-xs text-slate-600 mb-1">Thickness (GSM) *</label>
              <input type="number" name="thickness" step="1" required value="${item?.thickness || ''}" class="input-field w-full px-2 py-1.5 border border-slate-300 rounded" placeholder="80">
            </div>
            <div class="text-xs text-slate-500 mt-2">üí° Dimensions will be converted to standard units for calculations</div>
          </div>
          <div class="bg-slate-50 border border-slate-200 rounded-lg p-3">
            <div class="text-sm font-semibold text-slate-700 mb-2">üì¶ Stock Tracking</div>
            <div>
              <label class="block text-xs text-slate-600 mb-1">Current Stock (kg)</label>
              <input type="number" name="current_stock" id="roll-current-stock" step="0.01" readonly value="${item?.current_stock || item?.roll_weight || ''}" class="input-field w-full px-2 py-1.5 border border-slate-300 rounded bg-slate-100 cursor-not-allowed" placeholder="Auto-filled">
              <p class="text-xs text-slate-500 mt-1">üìù Auto-filled from weight above. Decreases as material is used in production.</p>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Purchase Date *</label>
            <input type="date" name="date" required value="${item?.date || today}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Supplier</label>
            <input type="text" name="supplier" value="${item?.supplier || ''}" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none" placeholder="Supplier name">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Notes</label>
            <textarea name="notes" class="input-field w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none" rows="2" placeholder="Any additional details...">${item?.notes || ''}</textarea>
          </div>
        </div>
      `;
    }

    function renderRolls() {
      const rolls = getRolls();
      const workers = getWorkers(); // Get all production records
      const grid = document.getElementById('rolls-grid');
      const currency = getCurrency();

      if (!grid) return;

      if (rolls.length === 0) {
        grid.innerHTML = `
          <div class="col-span-full card-gradient rounded-xl shadow-lg border border-slate-200 p-8 text-center">
            <svg class="w-16 h-16 mx-auto text-slate-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
            <p class="text-slate-600 mb-2">No rolls in inventory</p>
            <p class="text-sm text-slate-500">Add your first paper roll to start tracking</p>
          </div>
        `;
        return;
      }

      grid.innerHTML = rolls.map(roll => {
        // Calculate usage statistics for this roll
        const rollUsages = workers.filter(w => w.roll_id === roll.__backendId);
        const currentStock = roll.current_stock || 0;
        const initialStock = roll.initial_stock || roll.roll_weight || 0;
        const totalConsumed = initialStock - currentStock;

        // Calculate actual GSM from roll specifications
        const rollWidthCm = roll.width || 150; // cm
        const rollLengthM = roll.length || 500; // meters
        const rollWeightKg = initialStock; // kg
        const rollAreaM2 = (rollWidthCm / 100) * rollLengthM; // convert width to m, then area
        const actualGSM = rollAreaM2 > 0 ? rollWeightKg / rollAreaM2 : 0.08; // kg/m¬≤ (fallback to 80 GSM if not calculable)

        // Smart cutting optimization and wastage calculation
        let totalProductAreaKg = 0;
        let totalMaterialNeededKg = 0;
        let totalCuttingWastageKg = 0;
        let totalActualUsedKg = 0;

        rollUsages.forEach(usage => {
          totalActualUsedKg += usage.roll_usage_kg || 0;

          if (usage.order_length && usage.order_width && usage.units_produced) {
            const bagLength = usage.order_length; // cm (height of bag)
            const bagWidth = usage.order_width; // cm (width of bag)
            const unitsNeeded = usage.units_produced;

            // Try different cutting patterns to find optimal arrangement
            const patterns = [];

            // Pattern 1: All vertical (length along roll direction)
            const verticalPerWidth = Math.floor(rollWidthCm / bagWidth);
            if (verticalPerWidth > 0) {
              const rowsNeeded = Math.ceil(unitsNeeded / verticalPerWidth);
              const lengthUsed = rowsNeeded * bagLength;
              const usedWidth = verticalPerWidth * bagWidth;
              const wasteWidth = rollWidthCm - usedWidth;
              const wasteArea = (lengthUsed * wasteWidth) / 10000; // m¬≤
              patterns.push({
                name: `${verticalPerWidth} vertical`,
                piecesPerRow: verticalPerWidth,
                lengthPerRow: bagLength,
                usedWidth: usedWidth,
                wasteWidth: wasteWidth,
                totalLength: lengthUsed,
                wasteArea: wasteArea
              });
            }

            // Pattern 2: All horizontal (width along roll direction)
            const horizontalPerWidth = Math.floor(rollWidthCm / bagLength);
            if (horizontalPerWidth > 0) {
              const rowsNeeded = Math.ceil(unitsNeeded / horizontalPerWidth);
              const lengthUsed = rowsNeeded * bagWidth;
              const usedWidth = horizontalPerWidth * bagLength;
              const wasteWidth = rollWidthCm - usedWidth;
              const wasteArea = (lengthUsed * wasteWidth) / 10000; // m¬≤
              patterns.push({
                name: `${horizontalPerWidth} horizontal`,
                piecesPerRow: horizontalPerWidth,
                lengthPerRow: bagWidth,
                usedWidth: usedWidth,
                wasteWidth: wasteWidth,
                totalLength: lengthUsed,
                wasteArea: wasteArea
              });
            }

            // Pattern 3: Mixed (e.g., 2 vertical + 1 horizontal if they fit)
            const vertCount = Math.floor(rollWidthCm / bagWidth);
            const remainingWidth = rollWidthCm - (vertCount * bagWidth);
            const horizCount = Math.floor(remainingWidth / bagLength);
            if (vertCount > 0 && horizCount > 0) {
              const piecesPerRow = vertCount + horizCount;
              const rowLength = Math.max(bagLength, bagWidth); // need max to fit both orientations
              const rowsNeeded = Math.ceil(unitsNeeded / piecesPerRow);
              const lengthUsed = rowsNeeded * rowLength;
              const usedWidth = (vertCount * bagWidth) + (horizCount * bagLength);
              const wasteWidth = rollWidthCm - usedWidth;
              const wasteArea = (lengthUsed * wasteWidth) / 10000; // m¬≤
              patterns.push({
                name: `${vertCount}V + ${horizCount}H mixed`,
                piecesPerRow: piecesPerRow,
                lengthPerRow: rowLength,
                usedWidth: usedWidth,
                wasteWidth: wasteWidth,
                totalLength: lengthUsed,
                wasteArea: wasteArea
              });
            }

            // Find optimal pattern (minimum waste)
            const optimal = patterns.reduce((best, curr) =>
              curr.wasteArea < best.wasteArea ? curr : best
              , patterns[0] || { wasteArea: 0, totalLength: 0 });

            // Calculate material usage with actual roll GSM
            const productArea = (bagLength * bagWidth * unitsNeeded) / 10000; // m¬≤
            const productKg = productArea * actualGSM; // Use actual roll density
            const wasteKg = optimal.wasteArea * actualGSM;
            const totalLengthM = optimal.totalLength / 100; // convert cm to m
            const totalAreaM2 = (totalLengthM * rollWidthCm) / 100; // total roll area used
            const totalKg = totalAreaM2 * actualGSM;

            totalProductAreaKg += productKg;
            totalMaterialNeededKg += totalKg;
            totalCuttingWastageKg += wasteKg;
          }
        });

        // Untracked consumption (manual adjustments or unrecorded usage)
        const untrackedKg = totalConsumed - totalActualUsedKg;

        const stockPercent = (currentStock / initialStock) * 100;
        const productPercent = (totalProductAreaKg / initialStock) * 100;
        const wastePercent = (totalCuttingWastageKg / initialStock) * 100;
        const untrackedPercent = (untrackedKg / initialStock) * 100;
        const isLow = stockPercent < 20;
        const isMedium = stockPercent >= 20 && stockPercent < 50;

        // Dynamic colors based on stock level
        const productColor = isLow ? 'bg-red-500' : isMedium ? 'bg-orange-500' : 'bg-green-500';
        const stockTextColor = isLow ? 'text-red-700' : isMedium ? 'text-orange-700' : 'text-slate-700';

        const materialEfficiency = totalMaterialNeededKg > 0 ? ((totalProductAreaKg / totalMaterialNeededKg) * 100) : 0;
        const totalWastagePercent = totalMaterialNeededKg > 0 ? (totalCuttingWastageKg / totalMaterialNeededKg * 100) : 0;

        return `
          <div class="card-gradient rounded-xl shadow-lg border-2 ${isLow ? 'border-red-300' : 'border-slate-200'} p-4">
            <div class="flex justify-between items-start mb-3">
              <div>
                <h3 class="font-bold text-lg text-slate-800">${escapeHtml(roll.roll_name)}</h3>
                <div class="text-xs text-slate-500 mt-1">${initialStock.toFixed(1)} kg initial</div>
              </div>
              <button onclick="deleteItem('${roll.__backendId}')" class="text-red-600 hover:text-red-800" title="Delete">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
              </button>
            </div>

            <div class="bg-white rounded-lg p-3 mb-3 border border-slate-200">
              <div class="text-xs text-slate-600 mb-2">Roll Consumption (Smart Cutting Optimization)</div>
              <div class="w-full bg-slate-200 rounded-full h-6 mb-2 relative overflow-hidden">
                <div class="${productColor} h-6 absolute left-0" style="width: ${productPercent}%" title="Usable products: ${totalProductAreaKg.toFixed(2)} kg"></div>
                <div class="bg-yellow-400 h-6 absolute" style="left: ${productPercent}%; width: ${wastePercent}%" title="Cutting wastage: ${totalCuttingWastageKg.toFixed(2)} kg"></div>
                ${untrackedKg > 0 ? `<div class="bg-gray-400 h-6 absolute" style="left: ${productPercent + wastePercent}%; width: ${untrackedPercent}%" title="Untracked: ${untrackedKg.toFixed(2)} kg"></div>` : ''}
                <div class="absolute inset-0 flex items-center justify-center text-xs font-semibold ${stockTextColor}">
                  ${stockPercent.toFixed(0)}% stock left
                </div>
              </div>
              <div class="grid grid-cols-2 gap-1 text-xs mt-2">
                <div class="flex items-center gap-1">
                  <div class="w-3 h-3 ${productColor} rounded"></div>
                  <span class="text-slate-600">Products: ${totalProductAreaKg.toFixed(2)} kg</span>
                </div>
                <div class="flex items-center gap-1">
                  <div class="w-3 h-3 bg-yellow-400 rounded"></div>
                  <span class="text-slate-600">Cutting Waste: ${totalCuttingWastageKg.toFixed(2)} kg</span>
                </div>
                <div class="flex items-center gap-1">
                  <div class="w-3 h-3 bg-blue-500 rounded"></div>
                  <span class="text-slate-600">Total Used: ${totalMaterialNeededKg.toFixed(2)} kg</span>
                </div>
                ${untrackedKg > 0 ? `
                <div class="flex items-center gap-1">
                  <div class="w-3 h-3 bg-gray-400 rounded"></div>
                  <span class="text-slate-600">Untracked: ${untrackedKg.toFixed(2)} kg</span>
                </div>
                ` : ''}
              </div>
              <div class="mt-2 pt-2 border-t border-slate-200">
                <span class="text-2xl font-bold ${isLow ? 'text-red-600' : isMedium ? 'text-orange-600' : 'text-blue-600'}">${currentStock.toFixed(2)} kg</span>
                <span class="text-sm text-slate-600 ml-2">left in stock</span>
              </div>
            </div>

            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-3 mb-3 border border-blue-200">
              <div class="text-xs font-semibold text-blue-800 mb-2">üìä Cutting Efficiency Analysis</div>
              <div class="space-y-1 text-xs">
                <div class="flex justify-between">
                  <span class="text-slate-600">Material Efficiency:</span>
                  <span class="font-semibold ${materialEfficiency >= 85 ? 'text-green-600' : materialEfficiency >= 70 ? 'text-orange-600' : 'text-red-600'}">
                    ${materialEfficiency.toFixed(1)}%
                  </span>
                </div>
                <div class="flex justify-between">
                  <span class="text-slate-600">Cutting Wastage:</span>
                  <span class="font-semibold ${totalWastagePercent <= 15 ? 'text-green-600' : totalWastagePercent <= 25 ? 'text-orange-600' : 'text-red-600'}">
                    ${totalCuttingWastageKg.toFixed(2)} kg (${totalWastagePercent.toFixed(1)}%)
                  </span>
                </div>
                <div class="flex justify-between">
                  <span class="text-slate-600">Production Batches:</span>
                  <span class="font-semibold text-blue-600">${rollUsages.length} times</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-slate-600">Optimization:</span>
                  <span class="font-semibold text-purple-600">Smart nesting active ‚úì</span>
                </div>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-2 text-sm mb-3">
              <div class="bg-blue-50 rounded p-2">
                <div class="text-xs text-blue-600">Length</div>
                <div class="font-semibold text-blue-800">${roll.length}${roll.length_unit || 'm'}</div>
              </div>
              <div class="bg-purple-50 rounded p-2">
                <div class="text-xs text-purple-600">Width</div>
                <div class="font-semibold text-purple-800">${roll.width}${roll.width_unit || 'cm'}</div>
              </div>
              <div class="bg-green-50 rounded p-2">
                <div class="text-xs text-green-600">GSM</div>
                <div class="font-semibold text-green-800">${roll.thickness}</div>
              </div>
              <div class="bg-amber-50 rounded p-2">
                <div class="text-xs text-amber-600">Cost/kg</div>
                <div class="font-semibold text-amber-800">${currency}${(roll.cost_per_kg || 0).toFixed(2)}</div>
              </div>
              <div class="bg-orange-50 rounded p-2 col-span-2">
                <div class="text-xs text-orange-600">Total Cost</div>
                <div class="font-semibold text-orange-800">${currency}${(roll.cost || 0).toLocaleString()}</div>
              </div>
            </div>
            
            <div class="bg-slate-50 rounded p-2 text-xs mb-2">
              <div class="font-semibold text-slate-700 mb-1">üìä Usage Summary:</div>
              <div class="text-slate-600">Total consumed: ${totalConsumed.toFixed(2)} kg</div>
              <div class="text-slate-600">Production uses: ${rollUsages.length} times</div>
            </div>

            <div class="text-xs text-slate-500 space-y-1">
              <div>üìÖ ${formatDate(roll.date)}</div>
              ${roll.supplier ? `<div>üè™ ${escapeHtml(roll.supplier)}</div>` : ''}
            </div>

            ${isLow ? `
              <div class="mt-3 bg-red-50 border border-red-200 rounded p-2 text-xs text-red-700">
                ‚ö†Ô∏è Low stock! Consider reordering
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    async function handleFormSubmit(event) {
      event.preventDefault();

      if (isLoading) return;

      const form = event.target;
      const formData = new FormData(form);
      const data = Object.fromEntries(formData.entries());

      // Check record limit
      if (!editingItem && allData.length >= 999) {
        showToast('Maximum limit of 999 records reached. Please delete some items first.', 'error');
        return;
      }

      showLoading(true);

      try {
        if (currentModalType === 'investment') {
          const baseCost = parseFloat(data.cost) || 0;
          const transport = parseFloat(data.transport_charge) || 0;
          const totalCost = baseCost + transport;
          const record = {
            type: 'investment',
            name: data.name,
            quantity: parseFloat(data.quantity) || 0,
            unit: data.unit || '',
            cost_base: baseCost,
            transport_charge: transport,
            cost: totalCost,
            date: data.date,
            place: data.place || '',
            created_at: new Date().toISOString()
          };

          if (editingItem) {
            const result = await window.dataSdk.update({ ...editingItem, ...record });
            if (!result.isOk) throw new Error('Failed to update');
          } else {
            const result = await window.dataSdk.create(record);
            if (!result.isOk) throw new Error('Failed to create');
          }
        } else if (currentModalType === 'sale') {
          const record = {
            type: 'sale',
            name: data.name,
            customer_name: data.customer_name,
            quantity: parseFloat(data.quantity) || 0,
            unit: data.unit || '',
            selling_price: parseFloat(data.selling_price) || 0,
            date: data.date,
            pending_balance: parseFloat(data.pending_balance) || 0,
            payment_due_date: data.payment_due_date || null,
            created_at: new Date().toISOString()
          };

          if (editingItem) {
            const result = await window.dataSdk.update({ ...editingItem, ...record });
            if (!result.isOk) throw new Error('Failed to update');
          } else {
            const result = await window.dataSdk.create(record);
            if (!result.isOk) throw new Error('Failed to create');
          }
        } else if (currentModalType === 'product') {
          const record = {
            type: 'product',
            name: data.name,
            length: parseFloat(data.length) || 0,
            width: parseFloat(data.width) || 0,
            unit: data.unit || 'piece',
            price: parseFloat(data.price) || 0,
            material_quantity: parseFloat(data.material_quantity) || null,
            material_unit: data.material_unit || null,
            produces_quantity: parseFloat(data.produces_quantity) || null,
            produces_unit: data.produces_unit || null,
            active: true,
            created_at: new Date().toISOString()
          };

          if (editingItem) {
            const result = await window.dataSdk.update({ ...editingItem, ...record });
            if (!result.isOk) throw new Error('Failed to update');
          } else {
            const result = await window.dataSdk.create(record);
            if (!result.isOk) throw new Error('Failed to create');
          }
        } else if (currentModalType === 'household') {
          const amt = parseFloat(data.amount) || 0;
          const record = {
            type: 'household',
            category: data.category || 'Household',
            description: data.description || '',
            cost_base: amt,
            transport_charge: 0,
            cost: amt,
            date: data.date,
            place: data.place || '',
            created_at: new Date().toISOStrinvbbng()
          };

          if (editingItem) {
            const result = await window.dataSdk.update({ ...editingItem, ...record });
            if (!result.isOk) throw new Error('Failed to update');
          } else {
            const result = await window.dataSdk.create(record);
            if (!result.isOk) throw new Error('Failed to create');
          }
        } else if (currentModalType === 'order') {
          // Check if this is a multi-product order or legacy single-product
          const isMultiProduct = form.querySelector('[name^="products["]') !== null;

          if (isMultiProduct) {
            // New multi-product order format
            const products = [];
            const productContainers = form.querySelectorAll('[data-product-index]');

            productContainers.forEach((container, idx) => {
              const getFieldValue = (field) => {
                const input = form.querySelector(`[name="products[${idx}][${field}]"]`);
                return input ? input.value : '';
              };

              products.push({
                product_name: getFieldValue('product_name'),
                roll_id: getFieldValue('roll_id') || null,
                length: parseFloat(getFieldValue('length')) || 0,
                width: parseFloat(getFieldValue('width')) || 0,
                dimension_unit: getFieldValue('dimension_unit') || 'cm',
                cutting_length: parseFloat(getFieldValue('cutting_length')) || 0,
                cutting_width: parseFloat(getFieldValue('cutting_width')) || 0,
                cutting_unit: getFieldValue('cutting_unit') || 'cm',
                quantity: parseFloat(getFieldValue('quantity')) || 0,
                quantity_unit: getFieldValue('quantity_unit') || 'pcs',
                unit_price: parseFloat(getFieldValue('unit_price')) || 0,
                price: parseFloat(getFieldValue('price')) || 0
              });
            });

            const designCharge = parseFloat(data.design_charge) || 0;
            const totalPrice = parseFloat(data.price) || 0;

            // Initialize payment_history array
            let paymentHistory = editingItem?.payment_history || [];
            let amountPaid = 0;

            if (editingItem) {
              // When editing, calculate amount_paid from payment_history
              amountPaid = paymentHistory.reduce((sum, p) => sum + (p.amount || 0), 0);
            } else {
              // When creating, use the form value and add to history if > 0
              amountPaid = parseFloat(data.amount_paid) || 0;
              if (amountPaid > 0) {
                const now = new Date();
                const initialMode = data.initial_payment_mode || 'cash';

                // Get proof file if payment mode is digital
                let proofData = null;
                const proofInput = document.getElementById('order-payment-proof');
                if (proofInput && proofInput.files && proofInput.files[0]) {
                  proofData = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(proofInput.files[0]);
                  });
                }

                paymentHistory = [{
                  amount: amountPaid,
                  date: data.issue_date || now.toISOString().split('T')[0],
                  time: now.toTimeString().slice(0, 5),
                  mode: initialMode,
                  proof: proofData,
                  note: 'Initial payment',
                  recorded_at: now.toISOString()
                }];
              }
            }

            const balance = totalPrice - amountPaid;

            const record = {
              type: 'order',
              customer_name: data.customer_name,
              products: products,
              design_charge: designCharge,
              price: totalPrice,
              amount_paid: amountPaid,
              balance: balance,
              issue_date: data.issue_date,
              delivery_date: data.delivery_date,
              promised_payment_date: data.promised_payment_date || null,
              payment_history: paymentHistory,
              settled: editingItem?.settled || false,
              created_at: new Date().toISOString()
            };

            if (editingItem) {
              const result = await window.dataSdk.update({ ...editingItem, ...record });
              if (!result.isOk) throw new Error('Failed to update');
            } else {
              const result = await window.dataSdk.create(record);
              if (!result.isOk) throw new Error('Failed to create');
            }
          } else {
            // Legacy single-product order
            const totalPrice = parseFloat(data.price) || 0;
            const unitPrice = parseFloat(data.unit_price) || 0;

            // Initialize payment_history array
            let paymentHistory = editingItem?.payment_history || [];
            let amountPaid = 0;

            if (editingItem) {
              // When editing, calculate amount_paid from payment_history
              amountPaid = paymentHistory.reduce((sum, p) => sum + (p.amount || 0), 0);
            } else {
              // When creating, use the form value and add to history if > 0
              amountPaid = parseFloat(data.amount_paid) || 0;
              if (amountPaid > 0) {
                const now = new Date();
                const initialMode = data.initial_payment_mode || 'cash';

                // Get proof file if payment mode is digital
                let proofData = null;
                const proofInput = document.getElementById('order-payment-proof');
                if (proofInput && proofInput.files && proofInput.files[0]) {
                  proofData = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(proofInput.files[0]);
                  });
                }

                paymentHistory = [{
                  amount: amountPaid,
                  date: data.issue_date || now.toISOString().split('T')[0],
                  time: now.toTimeString().slice(0, 5),
                  mode: initialMode,
                  proof: proofData,
                  note: 'Initial payment',
                  recorded_at: now.toISOString()
                }];
              }
            }

            const balance = totalPrice - amountPaid;

            const record = {
              type: 'order',
              customer_name: data.customer_name,
              product_name: data.product_name,
              roll_id: data.roll_id || null,
              length: parseFloat(data.length) || 0,
              width: parseFloat(data.width) || 0,
              dimension_unit: data.dimension_unit || 'cm',
              cutting_length: parseFloat(data.cutting_length) || 0,
              cutting_width: parseFloat(data.cutting_width) || 0,
              cutting_unit: data.cutting_unit || 'cm',
              quantity: parseFloat(data.quantity) || 0,
              quantity_unit: data.quantity_unit || 'pcs',
              unit_price: unitPrice,
              price: totalPrice,
              amount_paid: amountPaid,
              balance: balance,
              issue_date: data.issue_date,
              delivery_date: data.delivery_date,
              promised_payment_date: data.promised_payment_date || null,
              payment_history: paymentHistory,
              settled: editingItem?.settled || false,
              created_at: new Date().toISOString()
            };

            if (editingItem) {
              const result = await window.dataSdk.update({ ...editingItem, ...record });
              if (!result.isOk) throw new Error('Failed to update');
            } else {
              const result = await window.dataSdk.create(record);
              if (!result.isOk) throw new Error('Failed to create');
            }
          }
        } else if (currentModalType === 'master_worker') {
          const record = {
            type: 'master_worker',
            name: data.name,
            contact: data.contact || '',
            monthly_wage: parseFloat(data.monthly_wage) || 0,
            notes: data.notes || '',
            created_at: new Date().toISOString()
          };

          if (editingItem) {
            const result = await window.dataSdk.update({ ...editingItem, ...record });
            if (!result.isOk) throw new Error('Failed to update');
          } else {
            const result = await window.dataSdk.create(record);
            if (!result.isOk) throw new Error('Failed to create');
          }
        } else if (currentModalType === 'production') {
          const rawMaterialCost = parseFloat(data.raw_material_cost) || 0;
          const wastagePercent = parseFloat(data.wastage_percent) || 0;
          const totalCost = rawMaterialCost * (1 + wastagePercent / 100);

          console.log('Saving production - Raw Material Cost:', rawMaterialCost);
          console.log('Saving production - Wastage Percent:', wastagePercent);
          console.log('Saving production - Total Cost:', totalCost);

          const record = {
            type: 'production',
            product_name: data.product_name,
            units_produced: parseFloat(data.units_produced) || 0,
            raw_material_cost: rawMaterialCost,
            wastage_percent: wastagePercent,
            total_cost: totalCost,
            date: data.date,
            notes: data.notes || '',
            created_at: new Date().toISOString()
          };

          if (editingItem) {
            const result = await window.dataSdk.update({ ...editingItem, ...record });
            if (!result.isOk) throw new Error('Failed to update');
          } else {
            const result = await window.dataSdk.create(record);
            if (!result.isOk) throw new Error('Failed to create');
          }
        } else if (currentModalType === 'roll') {
          const record = {
            type: 'roll',
            roll_name: data.roll_name,
            roll_weight: parseFloat(data.roll_weight) || 0,
            cost_per_kg: parseFloat(data.cost_per_kg) || 0,
            cost: parseFloat(data.cost) || 0,
            length: parseFloat(data.length) || 0,
            length_unit: data.length_unit || 'meters',
            width: parseFloat(data.width) || 0,
            width_unit: data.width_unit || 'cm',
            thickness: parseFloat(data.thickness) || 0,
            current_stock: parseFloat(data.current_stock) || parseFloat(data.roll_weight) || 0,
            initial_stock: parseFloat(data.current_stock) || parseFloat(data.roll_weight) || 0,
            date: data.date,
            supplier: data.supplier || '',
            notes: data.notes || '',
            created_at: new Date().toISOString()
          };

          if (editingItem) {
            const result = await window.dataSdk.update({ ...editingItem, ...record });
            if (!result.isOk) throw new Error('Failed to update');
          } else {
            const result = await window.dataSdk.create(record);
            if (!result.isOk) throw new Error('Failed to create');
          }
        } else if (currentModalType === 'worker') {
          const orderId = data.order_id || null;
          // Get order details to retrieve dimensions
          const order = orderId ? allData.find(d => d.__backendId === orderId) : null;
          // Find worker details
          const masterWorkers = getMasterWorkers();
          const selectedWorker = masterWorkers.find(w => w.name === data.worker_name);
          const user = api.user;
          const record = {
            type: 'worker',
            worker_id: selectedWorker?.__backendId || editingItem?.worker_id || null,
            worker_name: data.worker_name,
            product_name: data.product_name || '',
            order_id: orderId === 'other' ? null : orderId,
            background_work: data.background_work || '',
            units_produced: parseFloat(data.units_produced) || 0,
            production_unit: data.production_unit || 'pcs',
            hours_worked: parseFloat(data.hours_worked) || 0,
            order_length: order?.cutting_length || order?.length || null,
            order_width: order?.cutting_width || order?.width || null,
            roll_id: data.roll_id || null,
            roll_usage_kg: parseFloat(data.roll_usage_kg) || 0,
            date: data.date,
            is_placeholder: false,
            lastEditedBy: user && user.username ? user.username : undefined
          };
          // Don't override created_at on update
          if (!editingItem) {
            record.created_at = new Date().toISOString();
          }

          // Update roll stock if roll was used
          if (record.roll_id && record.roll_usage_kg > 0) {
            const roll = allData.find(r => r.__backendId === record.roll_id && r.type === 'roll');
            if (roll) {
              // Subtract the old usage if editing
              let previousUsage = 0;
              if (editingItem && editingItem.roll_id === record.roll_id && editingItem.roll_usage_kg) {
                previousUsage = editingItem.roll_usage_kg;
              }

              const newStock = roll.current_stock + previousUsage - record.roll_usage_kg;

              if (newStock < 0) {
                throw new Error(`Insufficient roll stock! Only ${roll.current_stock.toFixed(2)} kg available.`);
              }

              await window.dataSdk.update({ ...roll, current_stock: newStock });
              console.log(`Updated roll ${roll.roll_name}: ${roll.current_stock} -> ${newStock} kg`);
            }
          }

          if (editingItem && editingItem.__backendId) {
            // Update existing record
            const result = await window.dataSdk.update({ ...editingItem, ...record });
            if (!result.isOk) {
              console.error('Update failed:', result, 'editingItem:', editingItem, 'record:', record);
              throw new Error('Failed to update');
            }
          } else {
            // Check if placeholder exists for this worker and date
            const existingPlaceholder = getWorkers().find(w =>
              w.worker_id === record.worker_id &&
              w.date === record.date &&
              w.is_placeholder === true
            );

            if (existingPlaceholder) {
              // Update the placeholder
              const result = await window.dataSdk.update({ ...existingPlaceholder, ...record });
              if (!result.isOk) {
                console.error('Update placeholder failed:', result);
                throw new Error('Failed to update');
              }
            } else {
              // Create new record
              const result = await window.dataSdk.create(record);
              if (!result.isOk) {
                console.error('Create failed:', result, 'record:', record);
                throw new Error('Failed to create');
              }
            }
          }
        }

        closeModal();
        showToast('Saved successfully!', 'success');

        // Update pending badges after save
        setTimeout(updatePendingBadges, 500);
      } catch (error) {
        console.error('Save error:', error);
        showToast('Failed to save. Please try again.', 'error');
      }

      showLoading(false);
    }

    function editItem(id, type) {
      const item = allData.find(d => d.__backendId === id);
      if (item) {
        openModal(type, item);
      }
    }

    async function toggleProduct(id) {
      const product = allData.find(d => d.__backendId === id);
      if (!product) return;

      showLoading(true);
      try {
        const result = await window.dataSdk.update({ ...product, active: !product.active });
        if (!result.isOk) throw new Error('Failed to toggle');
        showToast(`Product ${product.active ? 'deactivated' : 'activated'}`, 'success');
      } catch (error) {
        showToast('Failed to update product', 'error');
      }
      showLoading(false);
    }

    // Payment Recording
    let currentPaymentOrder = null;

    function recordPayment(orderId) {
      const order = allData.find(d => d.__backendId === orderId);
      if (!order) return;

      currentPaymentOrder = order;
      const currency = getCurrency();
      const balance = (order.balance !== undefined) ? order.balance : (order.price - (order.amount_paid || 0));

      // Populate order info
      document.getElementById('payment-order-info').innerHTML = `
        <div class="text-sm">
          <div class="font-semibold text-slate-800 mb-1">${escapeHtml(order.customer_name || 'Unknown')} - ${escapeHtml(order.product_name || '')}</div>
          <div class="flex justify-between text-xs">
            <span class="text-slate-600">Total: ${currency}${(order.price || 0).toLocaleString()}</span>
            <span class="text-green-600">Paid: ${currency}${(order.amount_paid || 0).toLocaleString()}</span>
            <span class="text-red-600 font-semibold">Balance: ${currency}${balance.toLocaleString()}</span>
          </div>
        </div>
      `;

      // Set defaults
      document.getElementById('payment-amount').value = '';
      document.getElementById('payment-amount').max = balance;
      document.getElementById('payment-date').value = new Date().toISOString().split('T')[0];
      const now = new Date();
      document.getElementById('payment-time').value = now.toTimeString().slice(0, 5);
      document.getElementById('payment-mode').value = '';
      document.getElementById('payment-note').value = '';
      document.getElementById('payment-balance-hint').textContent = `Maximum: ${currency}${balance.toLocaleString()}`;
      document.getElementById('payment-proof-section').classList.add('hidden');
      document.getElementById('payment-proof').value = '';
      document.getElementById('payment-proof-preview').innerHTML = '';

      // Show modal
      document.getElementById('payment-modal').classList.remove('hidden');
    }

    function togglePaymentProof() {
      const mode = document.getElementById('payment-mode').value;
      const proofSection = document.getElementById('payment-proof-section');

      // Show proof upload for digital payment modes
      if (mode && mode !== 'cash') {
        proofSection.classList.remove('hidden');
      } else {
        proofSection.classList.add('hidden');
        document.getElementById('payment-proof').value = '';
        document.getElementById('payment-proof-preview').innerHTML = '';
      }
    }

    function toggleInitialPaymentMode() {
      const amountInput = document.getElementById('order-amount-paid');
      const modeSection = document.getElementById('initial-payment-mode');
      const modeSelect = document.getElementById('order-payment-mode');

      if (amountInput && modeSection) {
        const amount = parseFloat(amountInput.value) || 0;
        if (amount > 0) {
          modeSection.classList.remove('hidden');
          if (modeSelect) modeSelect.required = true;
        } else {
          modeSection.classList.add('hidden');
          if (modeSelect) {
            modeSelect.required = false;
            modeSelect.value = '';
          }
        }
      }
    }

    // Handle file preview
    document.addEventListener('DOMContentLoaded', () => {
      const proofInput = document.getElementById('payment-proof');
      if (proofInput) {
        proofInput.addEventListener('change', function (e) {
          const file = e.target.files[0];
          const preview = document.getElementById('payment-proof-preview');

          if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function (e) {
              preview.innerHTML = `
                <div class="relative inline-block">
                  <img src="${e.target.result}" class="max-w-full h-24 rounded border border-slate-300">
                  <button type="button" onclick="clearPaymentProof()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600">√ó</button>
                </div>
              `;
            };
            reader.readAsDataURL(file);
          }
        });
      }
    });

    function clearPaymentProof() {
      document.getElementById('payment-proof').value = '';
      document.getElementById('payment-proof-preview').innerHTML = '';
    }

    function calculateOrderTotal() {
      const quantity = parseFloat(document.getElementById('order-quantity')?.value) || 0;
      const unitPrice = parseFloat(document.getElementById('order-unit-price')?.value) || 0;
      const totalPrice = quantity * unitPrice;

      const totalPriceInput = document.getElementById('order-total-price');
      if (totalPriceInput) {
        totalPriceInput.value = totalPrice > 0 ? totalPrice.toFixed(2) : '';
      }
    }

    // New multi-product order functions
    function addProductToOrder() {
      const container = document.getElementById('order-products-container');
      if (!container) return;

      const existingProducts = container.querySelectorAll('[data-product-index]');
      const newIndex = existingProducts.length;

      const products = getProducts();
      const rolls = getRolls().filter(r => (r.current_stock || 0) > 0);

      const newProductHTML = getProductOrderItem({}, newIndex, products, rolls);
      container.insertAdjacentHTML('beforeend', newProductHTML);

      calculateOrderGrandTotal();
    }

    function removeProductFromOrder(index) {
      const container = document.getElementById('order-products-container');
      if (!container) return;

      const productDiv = container.querySelector(`[data-product-index="${index}"]`);
      if (productDiv) {
        productDiv.remove();
        // Re-index remaining products
        reindexOrderProducts();
        calculateOrderGrandTotal();
      }
    }

    function reindexOrderProducts() {
      const container = document.getElementById('order-products-container');
      if (!container) return;

      const productDivs = container.querySelectorAll('[data-product-index]');
      productDivs.forEach((div, newIndex) => {
        div.setAttribute('data-product-index', newIndex);
        div.querySelector('.font-semibold').textContent = `Product #${newIndex + 1}`;

        // Update all input names
        div.querySelectorAll('[name^="products["]').forEach(input => {
          const nameMatch = input.name.match(/products\[\d+\](\[.+\])/);
          if (nameMatch) {
            input.name = `products[${newIndex}]${nameMatch[1]}`;
          }
        });

        // Update onclick for remove button
        const removeBtn = div.querySelector('button[onclick^="removeProductFromOrder"]');
        if (removeBtn && newIndex > 0) {
          removeBtn.setAttribute('onclick', `removeProductFromOrder(${newIndex})`);
        }

        // Update total input id and calculation
        const totalInput = div.querySelector('[id^="product-"][id$="-total"]');
        if (totalInput) {
          totalInput.id = `product-${newIndex}-total`;
        }

        // Update oninput handlers
        div.querySelectorAll('[oninput^="calculateProductTotal"]').forEach(input => {
          input.setAttribute('oninput', `calculateProductTotal(${newIndex})`);
        });
      });
    }

    function calculateProductTotal(index) {
      const quantityInput = document.querySelector(`[name="products[${index}][quantity]"]`);
      const unitPriceInput = document.querySelector(`[name="products[${index}][unit_price]"]`);
      const totalInput = document.getElementById(`product-${index}-total`);

      if (quantityInput && unitPriceInput && totalInput) {
        const quantity = parseFloat(quantityInput.value) || 0;
        const unitPrice = parseFloat(unitPriceInput.value) || 0;
        const total = quantity * unitPrice;

        totalInput.value = total.toFixed(2);
      }

      calculateOrderGrandTotal();
    }

    function calculateOrderGrandTotal() {
      // Calculate products total
      let productsTotal = 0;
      const productTotals = document.querySelectorAll('[id^="product-"][id$="-total"]');
      productTotals.forEach(input => {
        productsTotal += parseFloat(input.value) || 0;
      });

      // Get design charge
      const designCharge = parseFloat(document.getElementById('order-design-charge')?.value) || 0;

      // Calculate grand total
      const grandTotal = productsTotal + designCharge;

      // Update display
      document.getElementById('order-products-total').textContent = '‚Çπ' + productsTotal.toFixed(2);
      document.getElementById('order-design-total').textContent = '‚Çπ' + designCharge.toFixed(2);
      document.getElementById('order-grand-total').textContent = '‚Çπ' + grandTotal.toFixed(2);
      document.getElementById('order-final-price').value = grandTotal.toFixed(2);
    }

    function toggleInitialPaymentProof() {
      const mode = document.getElementById('order-payment-mode')?.value;
      const proofSection = document.getElementById('initial-payment-proof');

      if (proofSection && mode && mode !== 'cash') {
        proofSection.classList.remove('hidden');
      } else if (proofSection) {
        proofSection.classList.add('hidden');
        const proofInput = document.getElementById('order-payment-proof');
        if (proofInput) proofInput.value = '';
        const preview = document.getElementById('order-payment-proof-preview');
        if (preview) preview.innerHTML = '';
      }
    }

    // Handle initial payment proof preview
    document.addEventListener('DOMContentLoaded', () => {
      const orderProofInput = document.getElementById('order-payment-proof');
      if (orderProofInput) {
        orderProofInput.addEventListener('change', function (e) {
          const file = e.target.files[0];
          const preview = document.getElementById('order-payment-proof-preview');

          if (file && file.type.startsWith('image/') && preview) {
            const reader = new FileReader();
            reader.onload = function (e) {
              preview.innerHTML = `
                <div class="relative inline-block">
                  <img src="${e.target.result}" class="max-w-full h-24 rounded border border-slate-300">
                </div>
              `;
            };
            reader.readAsDataURL(file);
          }
        });
      }
    });

    // Orders pagination and search
    let currentOrdersPage = 1;
    let ordersPerPage = 10;
    let filteredOrders = [];

    function searchOrders() {
      currentOrdersPage = 1;
      renderOrders();
    }

    function searchPayments() {
      currentPaymentsPage = 1;
      renderPaymentHistory();
    }

    // Payments pagination
    let currentPaymentsPage = 1;
    let paymentsPerPage = 5;

    function closePaymentModal() {
      currentPaymentOrder = null;
      document.getElementById('payment-modal').classList.add('hidden');
    }

    // Handle payment form submission
    document.addEventListener('DOMContentLoaded', () => {
      const paymentForm = document.getElementById('payment-form');
      if (paymentForm) {
        paymentForm.addEventListener('submit', async (e) => {
          e.preventDefault();

          if (!currentPaymentOrder) return;

          const amount = parseFloat(document.getElementById('payment-amount').value);
          const date = document.getElementById('payment-date').value;
          const time = document.getElementById('payment-time').value;
          const mode = document.getElementById('payment-mode').value;
          const note = document.getElementById('payment-note').value;
          const proofFile = document.getElementById('payment-proof').files[0];

          const balance = (currentPaymentOrder.balance !== undefined) ? currentPaymentOrder.balance : (currentPaymentOrder.price - (currentPaymentOrder.amount_paid || 0));

          if (amount <= 0) {
            showToast('Payment amount must be greater than 0', 'error');
            return;
          }

          if (amount > balance) {
            showToast('Payment amount cannot exceed balance', 'error');
            return;
          }

          if (!mode) {
            showToast('Please select payment mode', 'error');
            return;
          }

          showLoading(true);
          try {
            // Convert proof image to base64 if exists
            let proofData = null;
            if (proofFile) {
              proofData = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsDataURL(proofFile);
              });
            }

            // Initialize payment_history if it doesn't exist
            if (!currentPaymentOrder.payment_history) {
              currentPaymentOrder.payment_history = [];
            }

            // Add new payment to history
            currentPaymentOrder.payment_history.push({
              amount: amount,
              date: date,
              time: time,
              mode: mode,
              proof: proofData,
              note: note || '',
              recorded_at: new Date().toISOString()
            });

            // Update amount_paid and balance
            const newAmountPaid = (currentPaymentOrder.amount_paid || 0) + amount;
            const newBalance = currentPaymentOrder.price - newAmountPaid;

            // Update order
            const updatedOrder = {
              ...currentPaymentOrder,
              amount_paid: newAmountPaid,
              balance: newBalance,
              settled: newBalance <= 0
            };

            const result = await window.dataSdk.update(updatedOrder);
            if (!result.isOk) throw new Error('Failed to record payment');

            showToast('Payment recorded successfully!', 'success');
            closePaymentModal();
          } catch (error) {
            showToast('Failed to record payment', 'error');
          }
          showLoading(false);
        });
      }
    });

    async function markOrderSettled(id) {
      const order = allData.find(d => d.__backendId === id);
      if (!order) return;

      showLoading(true);
      try {
        const result = await window.dataSdk.update({ ...order, settled: true });
        if (!result.isOk) throw new Error('Failed to update');
        showToast('Order marked as settled!', 'success');
      } catch (error) {
        showToast('Failed to update order', 'error');
      }
      showLoading(false);
    }

    async function markOrderUnsettled(id) {
      const order = allData.find(d => d.__backendId === id);
      if (!order) return;

      showLoading(true);
      try {
        const result = await window.dataSdk.update({ ...order, settled: false });
        if (!result.isOk) throw new Error('Failed to update');
        showToast('Order marked as unsettled!', 'success');
      } catch (error) {
        showToast('Failed to update order', 'error');
      }
      showLoading(false);
    }

    // Alerts and Warnings System
    function updateAlerts() {
      const alerts = [];
      const currency = getCurrency();
      const filteredProduction = getFilteredData(getProduction());
      const filteredWorkers = getFilteredData(getWorkers());
      const filteredSales = getFilteredData(getSales());
      const filteredOrders = getFilteredData(getOrders());
      // ...existing code...
      return alerts;
    }
// --- END OF updateAlerts ---
  // ...existing code...

    function formatMonth(monthStr) {
      const [year, month] = monthStr.split('-');
      const date = new Date(year, month - 1);
      return date.toLocaleDateString('en-IN', { month: 'long', year: 'numeric' });
    }

    // Notification and Reminder System
    let notificationPermissionGranted = Notification?.permission === 'granted';

    async function requestNotificationPermission() {
      if ('Notification' in window && Notification.permission === 'default') {
        try {
          const permission = await Notification.requestPermission();
          notificationPermissionGranted = permission === 'granted';
        } catch (error) {
          console.log('Notification permission not granted');
        }
      } else if (Notification.permission === 'granted') {
        notificationPermissionGranted = true;
      }
    }

    function playNotificationSound() {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();

      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);

      oscillator.frequency.value = 800;
      oscillator.type = 'sine';

      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.5);
    }

    function showNotification(title, body) {
      if (notificationPermissionGranted) {
        new Notification(title, {
          body: body,
          icon: 'üìã',
          badge: 'üìã',
          vibrate: [200, 100, 200]
        });
      }
      playNotificationSound();
      showToast(body, 'info');
    }

    function checkTodayAttendance() {
      const today = new Date().toISOString().split('T')[0];
      const attendanceRecords = getAttendance();
      const masterWorkers = getMasterWorkers();

      if (masterWorkers.length === 0) return true;

      const todayRecords = attendanceRecords.filter(r => r.date === today);
      return todayRecords.length >= masterWorkers.length;
    }

    function checkTodayProduction() {
      const today = new Date().toISOString().split('T')[0];
      const productionRecords = getProduction();
      const todayRecords = productionRecords.filter(p => p.date === today);
      return todayRecords.length > 0;
    }

    function updatePendingBadges() {
      const now = new Date();
      const currentHour = now.getHours();
      const today = new Date().toISOString().split('T')[0];

      const attendanceBadge = document.getElementById('attendance-badge');
      const productionBadge = document.getElementById('production-badge');

      // Check attendance (show red dot after 10:00 AM if not filled)
      if (attendanceBadge) {
        if (currentHour >= 10 && !checkTodayAttendance()) {
          attendanceBadge.classList.remove('hidden');
        } else {
          attendanceBadge.classList.add('hidden');
        }
      }

      // Check production (show red dot after 7:00 PM if not filled)
      if (productionBadge) {
        if (currentHour >= 19 && !checkTodayProduction()) {
          productionBadge.classList.remove('hidden');
        } else {
          productionBadge.classList.add('hidden');
        }
      }
    }

    function checkAndSendReminders() {
      const now = new Date();
      const currentHour = now.getHours();
      const currentMinute = now.getMinutes();
      const today = new Date().toISOString().split('T')[0];

      const attendanceNotified = localStorage.getItem(`attendance_notified_${today}`);
      const productionNotified = localStorage.getItem(`production_notified_${today}`);

      // Attendance reminder at 10:00 AM
      if (currentHour === 10 && currentMinute === 0 && !attendanceNotified) {
        if (!checkTodayAttendance()) {
          showNotification('Attendance Reminder', 'Please mark attendance for all workers today!');
          localStorage.setItem(`attendance_notified_${today}`, 'true');
        }
      }

      // Production reminder at 7:00 PM (19:00)
      if (currentHour === 19 && currentMinute === 0 && !productionNotified) {
        if (!checkTodayProduction()) {
          showNotification('Production Reminder', 'Please record today\'s production details!');
          localStorage.setItem(`production_notified_${today}`, 'true');
        }
      }

      updatePendingBadges();
    }

    // Start notification system
    async function enableNotifications() {
      await requestNotificationPermission();
      const banner = document.getElementById('notification-banner');
      if (notificationPermissionGranted) {
        banner.classList.add('hidden');
        showToast('Notifications enabled! You\'ll receive daily reminders.', 'success');
      } else {
        showToast('Notification permission denied. Please enable in browser settings.', 'error');
      }
    }

    function initNotificationSystem() {
      // Check existing permission status
      if (Notification?.permission === 'granted') {
        notificationPermissionGranted = true;
      } else if (Notification?.permission === 'default') {
        // Show banner to enable notifications
        const banner = document.getElementById('notification-banner');
        if (banner) banner.classList.remove('hidden');
      }

      // Check every minute
      setInterval(checkAndSendReminders, 60000);

      // Check immediately
      checkAndSendReminders();
    }

    // Initialize app
    initApp();
    initNotificationSystem();
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      document.getElementById('user-name').textContent = user.fullName || user.username || 'User';
      const badge = document.getElementById('user-role-badge');
      if (user.role === 'user') {
        badge.textContent = 'USER';
        badge.classList.remove('bg-purple-600');
        badge.classList.add('bg-blue-600');
        // Hide all tabs except Production
        const allowed = ['tab-workers'];
        document.querySelectorAll('.tab-btn').forEach(btn => {
          if (!allowed.includes(btn.id)) {
            btn.style.display = 'none';
          } else {
            btn.style.display = '';
          }
        });
        // Show only production tab content
        document.querySelectorAll('.tab-content').forEach(tc => {
          if (tc.id !== 'content-workers') tc.style.display = 'none';
          else tc.style.display = '';
        });
        // Set production tab as active
        document.getElementById('tab-workers').classList.add('tab-active');
      }

      // User menu toggle logic
      const userMenuBtn = document.getElementById('user-menu-btn');
      const userMenu = document.getElementById('user-menu');
      if (userMenuBtn && userMenu) {
        userMenuBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          userMenu.classList.toggle('hidden');
        });
        // Hide menu when clicking outside
        document.addEventListener('click', function(e) {
          if (!userMenu.contains(e.target) && e.target !== userMenuBtn) {
            userMenu.classList.add('hidden');
          }
        });
      }
    });
  </script>
  <script src="/cloudflare-challenge.js"></script>
</body>
</html>